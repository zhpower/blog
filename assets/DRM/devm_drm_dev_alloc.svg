<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="847" height="641"><desc>title%20devm_drm_dev_alloc%0A%0ADriver%20-%3E%20drm_drv%3A%3Ccolor%3A%23ff0066%3Edevm_drm_dev_alloc%3C%2Fcolor%3E%5Cn(struct%20device*%2C%20struct%20drm_driver%20*%2C%20struct%20private_driver%2C%20drm)%0A%0A%0Arbox%20over%20drm_drv%3A__devm_drm_dev_alloc(%20)%5Cn%20%20%5Cn%20%20%20%20%3Ccolor%3A%23red%3E1%3C%2Fcolor%3E.%20kzalloc(%20)%20%5C%2F%5C%2F%E4%B8%BA%E7%94%A8%E6%88%B7%E5%AE%9A%E4%B9%89%E7%9A%84driver%E7%BB%93%E6%9E%84%E5%88%86%E9%85%8D%E7%A9%BA%E9%97%B4%5Cn%5Cn%20%20%20%202.%20devm_drm_dev_init(%20)%5Cn%5Cn%20%20%20%20%20%20%20%20%202.1%20drm_dev_init()%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20a.%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%BA%9B%E9%94%81%E3%80%81%E9%93%BE%E8%A1%A8(filelist%2C%20clientlist%2C%20vblank_event_list)%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20b.%E8%AE%BE%E7%BD%AE%20dev%20minor%20%20%5C%2F%5C%2F%E9%80%9A%E8%BF%87idr_alloc(drm_minors_idr)%20%E5%88%86%E9%85%8D%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20c.%20if%20DRIVER_LEGACY%2C%20idr_init(dev%5C-%3Ectx_idr)%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20d.%20if%20DRIVER_GEM%2C%20%3Ccolor%3A%23green%3Edrm_gem_init(%20)%20%5C-%5C-%3E%20drm_vma_offset_manager_init(%20)%3C%2Fcolor%3E%5Cn%5Cn%20%20%20%20%20%20%20%20%202.2%20devm_add_action_or_reset(%20devm_drm_dev_init_release)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%2F%5C%2F%E5%9C%A8%E8%AE%BE%E5%A4%87%E8%A2%AB%E5%8D%B8%E8%BD%BD%E6%88%96%E9%87%8D%E7%BD%AE%E6%97%B6%E6%89%A7%E8%A1%8C%E5%9B%9E%E8%B0%83%EF%BC%8C%E9%87%8A%E6%94%BE%E8%AE%BE%E5%A4%87%E6%89%80%E5%8D%A0%E7%94%A8%E7%9A%84%E8%B5%84%E6%BA%90%5Cn%5Cn%20%20%20%203.%20drmm_add_final_kfree(%20)%20%5C%2F%5C%2F%20%E8%AE%B0%E5%BD%95%20%3C%3Ccolor%3A%23red%3E1%3C%2Fcolor%3E%3E%20%E4%B8%AD%E5%88%86%E9%85%8D%E7%9A%84%E7%A9%BA%E9%97%B4%EF%BC%8C%20%E5%9C%A8drm_dev_release()%E4%B8%AD%E9%87%8A%E6%94%BE</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="847" height="641"/></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 48.97455687792578 103.10369087072726 L 48.97455687792578 641.4114673107274" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 522.1134795246705 103.10369087072726 L 522.1134795246705 641.4114673107274" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 8.795878699999996 55.60594589072727 L 89.15323505585155 55.60594589072727 L 89.15323505585155 103.10369087072726 L 8.795878699999996 103.10369087072726 L 8.795878699999996 55.60594589072727 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="27.882935478999997" y="85.51193347072726" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">Driver</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 473.7458059854166 55.60594589072727 L 570.4811530639245 55.60594589072727 L 570.4811530639245 103.10369087072726 L 473.7458059854166 103.10369087072726 L 473.7458059854166 55.60594589072727 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="492.83286276441663" y="85.51193347072726" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_drv</text></g></g><g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16pt" font-style="normal" font-weight="normal" text-decoration="normal" x="317.65721893310547" y="26.547561167272725" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">devm_drm_dev_alloc</text></g><g><g><rect fill="white" stroke="none" x="69.79146980125911" y="138.28720567072725" width="150.76792944167968" height="22.86928462"/></g><g><rect fill="white" stroke="none" x="69.79146980125911" y="155.87896307072725" width="431.50509680007815" height="22.86928462"/></g><text fill="#ff0066" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="72.43023341125911" y="154.11978733072726" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">devm_drm_dev_alloc</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="72.43023341125911" y="171.71154473072727" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">(struct device*, struct drm_driver *, struct private_driver, drm)</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 48.97455687792578 178.74824769072725 L 507.6295992653372 178.74824769072725" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(522.1134795246705,178.74824769072725) translate(-522.1134795246705,-178.74824769072725)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 507.4536816913372 171.41834877406058 L 522.1134795246705 178.74824769072725 L 507.4536816913372 186.07814660739393 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 205.82069726525646 220.96846545072728 L 205.82069726525646 220.96846545072728 A 15.832581659999999 15.832581659999999 0 0 1 221.65327892525644 205.1358837907273 L 822.5736801240846 205.1358837907273 L 822.5736801240846 205.1358837907273 A 15.832581659999999 15.832581659999999 0 0 1 838.4062617840846 220.96846545072728 L 838.4062617840846 564.0077347507274 L 838.4062617840846 564.0077347507274 A 15.832581659999999 15.832581659999999 0 0 1 822.5736801240846 579.8403164107274 L 221.65327892525644 579.8403164107274 L 221.65327892525644 579.8403164107274 A 15.832581659999999 15.832581659999999 0 0 1 205.82069726525646 564.0077347507274 L 205.82069726525646 220.96846545072728" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="229.76434415072734" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">__devm_drm_dev_alloc( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="247.35610155072735" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">  </text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="264.9478589507273" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">    </text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="247.80059805494398" y="264.9478589507273" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="256.3975981770143" y="264.9478589507273" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">. kzalloc( ) //为用户定义的driver结构分配空间</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="300.13137375072733" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">    2. devm_drm_dev_init( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="335.31488855072735" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         2.1 drm_dev_init()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="370.49840335072736" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                 a.初始化一些锁、链表(filelist, clientlist, vblank_event_list)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="405.68191815072737" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                 b.设置 dev minor  //通过idr_alloc(drm_minors_idr) 分配</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="440.8654329507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                 c. if DRIVER_LEGACY, idr_init(dev-&gt;ctx_idr)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="476.0489477507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                 d. if DRIVER_GEM, </text><text fill="green" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="435.07327261549085" y="476.0489477507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_init( ) --&gt; drm_vma_offset_manager_init( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="511.2324625507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         2.2 devm_add_action_or_reset( devm_drm_dev_init_release)</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="528.8242199507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">             //在设备被卸载或重置时执行回调，释放设备所占用的资源</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="230.44915762525648" y="564.0077347507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">    3. drmm_add_final_kfree( ) // 记录 &lt;</text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="498.2301024494752" y="564.0077347507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="506.82710257154554" y="564.0077347507274" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">&gt; 中分配的空间， 在drm_dev_release()中释放</text></g></g><g/><g/></g></svg>