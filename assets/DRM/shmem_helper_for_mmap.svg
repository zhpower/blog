<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="1869" height="1538"><desc>title%20shmem%20helper%20for%20mmap%0A%0A%3D%3Dmmap%3D%3D%0Adriver-%3Edrm_dumb_buffer%3Adrm_mode_mmap_dumb_ioctl(%20)%0Arbox%20left%20of%20drm_dumb_buffer%3Adrm_gem_dumb_map_offset(%20)%5Cn%5Cn%20%20%20%20%20%20%20%20%20%3Ccolor%3A%23red%3E1%3C%2Fcolor%3E.drm_gem_object_lookup()%20%5C%2F%5C%2F%20handle%20%5C-%5C-%3E%20gem_object%5Cn%5Cn%20%20%20%20%20%20%20%20%20%3Ccolor%3A%23red%3E2%3C%2Fcolor%3E.drm_gem_create_mmap_offset()%5Cn%20%20%20%20%20%20%20%20%20%20%20%5C%2F%5C%2F%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAfake%20offset%20%E8%BF%94%E5%9B%9E%E7%BB%99%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4%EF%BC%8C%E5%BD%93%E7%94%A8%E6%88%B7map%E5%AF%B9%E5%BA%94%E7%9A%84gem_object%E6%97%B6%EF%BC%8C%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%E7%B3%BB%E7%BB%9F%E5%8F%AF%E4%BB%A5%E9%80%9A%E8%BF%87%E8%BF%99%E4%B8%AAoffset%E6%89%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84gem_object%20%E4%BB%8E%E8%80%8C%E5%BB%BA%E7%AB%8Bmemory%20mapping%5Cn%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C-%5C-%3Edrm_gem_create_mmap_offset_size()%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C-%5C-%3Edrm_vma_offset_add()%5Cn%5Cn%20%20%20%20%20%20%20%20%20%3Ccolor%3A%23red%3E3%3C%2Fcolor%3E.drm_vma_node_offset_addr()%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%2F%5C%2F%20vm_node.start%20%3C%3C%20PAGE_SHIFT%20%5C-%5C-%3E%20offset%0Arbox%20right%20of%20driver%3A%E5%9C%A8%3Ccolor%3A%23ff00ff%3Edrm_driver.fops.mmap%3C%2Fcolor%3E(%20)%E4%B8%AD%E8%AE%BE%E7%BD%AE%E5%AF%B9%E5%BA%94%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0%5Cn%5Cn%20%20%20%20%E5%9C%A8%E5%9F%BA%E4%BA%8EGEM%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%AD%EF%BC%8C%E5%8F%AF%E9%80%9A%E8%BF%87%E8%B0%83%E7%94%A8drm_gem_mmap()%E6%9D%A5%E5%AE%9E%E7%8E%B0%0Adriver-%3Edrm_gem%3Adrm_gem_mmap(%20)%0Arbox%20left%20of%20drm_gem%3A%20%20%20%20drm_gem_mmap(%20)%20%5C%2F%5C%2F%E9%BB%98%E8%AE%A4%E7%9A%84gem%20mmap%E5%AE%9E%E7%8E%B0%5Cn%20%20%20%20%20%20%201.%20vma.vm_pgoff%20%5C-%5C-%3E%20vm_node%20%5C-%5C-%3E%20gem_object%5Cn%20%20%20%20%20%20%202.drm_gem_mmap_obj(%20)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ccolor%3A%23ff00ff%3Eobj-%3Efuncs-%3Emmap(%20)%3C%2Fcolor%3E%20%5C%2F%5C%2F%20if%20not%20null(%E5%9C%A8dumb_create%E4%B8%AD%E8%AE%BE%E7%BD%AE)%0Adrm_gem-%3Eshmem_helper%3A%3Ccolor%3A%23ff00ff%3Eobj-%3Efuncs-%3Emmap(%20)%3C%2Fcolor%3E%20%5Cn%20%20%20%20%20%20drm_gem_shmem_object_mmap(%20)%20%20%5C%2F%5C%2F%E5%9C%A8drm_gem_shmem_create(%20)%E8%AE%BE%E7%BD%AE%0Arbox%20left%20of%20shmem_helper%3Adrm_gem_shmem_mmap(%20)%5Cn%5Cn%20%20%20%20%20a.%20%3Ccolor%3A%23green%3Edrm_gem_shmem_get_pages%3C%2Fcolor%3E(%20)%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%5C-%5C-%3Edrm_gem_shmem_get_pages_locked()%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C-%5C-%3Edrm_gem_get_pages()%5Cn%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5C%2F%5C%2F%E4%BF%9D%E5%AD%98%E5%88%B0%3Ccolor%3A%23red%3Eshmem-%3Epages%3C%2Fcolor%3E%5Cn%5Cn%20%20%20%20%20b.%20vma-%3Evm_ops%20%3D%20%26%3Ccolor%3A%23red%3Edrm_gem_shmem_vm_ops%3C%2Fcolor%3E%0Ashmem_helper-%3Edrm_gem%3Adrm_gem_get_pages(%20)%0Arbox%20left%20of%20drm_gem%3A%E6%A0%B9%E6%8D%AEobj-%3Eflip-%3Ef_mapping%5Cn%E8%B0%83%E7%94%A8s%3Ccolor%3A%23red%3Ehmem_read_mapping_page%3C%2Fcolor%3E()%E8%8E%B7%E5%8F%96pages%5Cn%5Cn%5C%2F%5C%2Fobj-%3Eflip%E6%98%AF%E5%9C%A8init%20gem_obj%E6%97%B6%E7%94%B1shmem_file_setup(%20)%E5%BE%97%E5%88%B0%5Cn%0Abox%20left%20of%20shmem_helper%3A%3Ccolor%3A%23red%3Edrm_gem_shmem_vm_ops%3C%2Fcolor%3E%20%3D%20%7B%5Cn%20%20%20%20%20%20%20%20%09.fault%20%3D%20%3Ccolor%3A%23purple%3Edrm_gem_shmem_fault%3C%2Fcolor%3E%2C%5Cn%20%20%20%20%20%20%20%20%09.open%20%3D%20drm_gem_shmem_vm_open%2C%5Cn%20%20%20%20%20%20%20%20%09.close%20%3D%20drm_gem_shmem_vm_close%2C%5Cn%7D%3B%0Arbox%20left%20of%20shmem_helper%3A%3Ccolor%3A%23purple%3Edrm_gem_shmem_fault%3C%2Fcolor%3E(%20)%5Cn%5Cn%20%20%20%20a.%20%E6%A0%B9%E6%8D%AEpage_offset%E5%9C%A8shmem_pages%E4%B8%AD%E5%BE%97%E5%88%B0page%5Cn%20%20%20%20b.%20%3Ccolor%3A%23blue%3Evmf_insert_page(%20)%3C%2Fcolor%3E%0A</desc><defs/><g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g><rect fill="white" stroke="none" x="0" y="0" width="1869" height="1538"/></g><g><text fill="black" stroke="none" font-family="sans-serif" font-size="16.5pt" font-style="normal" font-weight="normal" text-decoration="normal" x="804.2641257646576" y="26.3876361" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">shmem helper for mmap</text></g><g/><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 48.07978148730078 103.26361593799999 L 48.07978148730078 1538.7510197779998" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 685.7086109744884 103.26361593799999 L 685.7086109744884 1538.7510197779998" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1223.2300948806212 103.26361593799999 L 1223.2300948806212 1538.7510197779998" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1790.5352467754128 103.26361593799999 L 1790.5352467754128 1538.7510197779998" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray="13.532121076923076,5.863919133333333"/></g><g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 8.795878699999996 55.765870957999994 L 87.36368427460155 55.765870957999994 L 87.36368427460155 103.26361593799999 L 8.795878699999996 103.26361593799999 L 8.795878699999996 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="27.882935478999997" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">driver</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 603.7153118248829 55.765870957999994 L 767.7019101240938 55.765870957999994 L 767.7019101240938 103.26361593799999 L 603.7153118248829 103.26361593799999 L 603.7153118248829 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="622.8023686038829" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_dumb_buffer</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1170.8001425938087 55.765870957999994 L 1275.6600471674337 55.765870957999994 L 1275.6600471674337 103.26361593799999 L 1170.8001425938087 103.26361593799999 L 1170.8001425938087 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1189.8871993728087" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem</text></g><path fill="none" stroke="none"/><g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1720.0988629090104 55.765870957999994 L 1860.9716306418152 55.765870957999994 L 1860.9716306418152 103.26361593799999 L 1720.0988629090104 103.26361593799999 L 1720.0988629090104 55.765870957999994 Z" stroke-miterlimit="10" stroke-width="2.814681184" stroke-dasharray=""/></g><g><g/><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1739.1859196880105" y="85.67185853800001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">shmem_helper</text></g></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 8.7958787 152.81373261466666 L 1860.2041213 152.81373261466666 M 8.7958787 158.677651748 L 1860.2041213 158.677651748 M 8.7958787 164.5415708813333 L 1860.2041213 164.5415708813333" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 887.4019580359961 138.447130738 L 981.598041964004 138.447130738 L 981.598041964004 178.90817275799998 L 887.4019580359961 178.90817275799998 Z" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="912.0304183959961" y="163.07559109800002" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">mmap</text></g><g><g><rect fill="white" stroke="none" x="251.1380009802695" y="205.29580885799996" width="231.51239050125" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="253.77676459026952" y="221.12839051799997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_mode_mmap_dumb_ioctl( )</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 48.07978148730078 228.16509347799996 L 671.224730715155 228.16509347799996" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(685.7086109744884,228.16509347799996) translate(-685.7086109744884,-228.16509347799996)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 671.048813141155 220.83519456133328 L 685.7086109744884 228.16509347799996 L 671.048813141155 235.49499239466664 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 685.7086109744884 380.333794988 L 676.9127322744883 380.333794988 M 56.87566018730081 270.385311238 L 56.87566018730081 270.385311238 A 15.832581659999999 15.832581659999999 0 0 1 72.70824184730081 254.552729578 L 661.0801506144884 254.55272957799997 L 661.0801506144884 254.552729578 A 15.832581659999999 15.832581659999999 0 0 1 676.9127322744883 270.385311238 L 676.9127322744883 490.282278738 L 676.9127322744883 490.282278738 A 15.832581659999999 15.832581659999999 0 0 1 661.0801506144884 506.114860398 L 72.70824184730081 506.114860398 L 72.70824184730081 506.114860398 A 15.832581659999999 15.832581659999999 0 0 1 56.87566018730081 490.282278738 L 56.87566018730081 270.385311238" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="279.18118993800005" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_dumb_map_offset( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="296.77294733800005" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="314.36470473800006" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         </text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="120.5448615140977" y="314.36470473800006" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">1</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="129.14186163616802" y="314.36470473800006" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">.drm_gem_object_lookup() // handle --&gt; gem_object</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="331.95646213800006" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="349.54821953800007" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         </text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="120.5448615140977" y="349.54821953800007" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">2</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="129.14186163616802" y="349.54821953800007" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">.drm_gem_create_mmap_offset()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="367.1399769380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">           // 创建一个fake offset 返回给用户空间，当用户map对应的gem_object时，</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="384.7317343380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                系统可以通过这个offset找到对应的gem_object 从而建立memory mapping</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="402.3234917380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="419.9152491380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                --&gt;drm_gem_create_mmap_offset_size()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="437.5070065380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                                           --&gt;drm_vma_offset_add()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="455.0987639380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="472.6905213380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         </text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="120.5448615140977" y="472.6905213380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">3</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="129.14186163616802" y="472.6905213380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">.drm_vma_node_offset_addr()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730083" y="490.2822787380001" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                       // vm_node.start &lt;&lt; PAGE_SHIFT --&gt; offset</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 48.07978148730078 570.324774908 L 56.87566018730078 570.324774908 M 56.87566018730078 548.335078158 L 56.87566018730078 548.335078158 A 15.832581659999999 15.832581659999999 0 0 1 72.70824184730078 532.502496498 L 503.4854240519882 532.502496498 L 503.4854240519882 532.502496498 A 15.832581659999999 15.832581659999999 0 0 1 519.3180057119882 548.335078158 L 519.3180057119882 592.314471658 L 519.3180057119882 592.314471658 A 15.832581659999999 15.832581659999999 0 0 1 503.4854240519882 608.147053318 L 72.70824184730078 608.147053318 L 72.70824184730078 608.147053318 A 15.832581659999999 15.832581659999999 0 0 1 56.87566018730078 592.314471658 L 56.87566018730078 548.335078158" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730077" y="557.130956858" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">在</text><text fill="#ff00ff" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="96.16410895062108" y="557.130956858" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_driver.fops.mmap</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="253.04315252972265" y="557.130956858" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">( )中设置对应函数实现</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730077" y="574.722714258" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="81.50412054730077" y="592.314471658" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">    在基于GEM的实现中，可通过调用drm_gem_mmap()来实现</text></g><g><g><rect fill="white" stroke="none" x="566.852943677965" y="634.534689418" width="137.60398901199218" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="569.4917072879649" y="650.3672710779999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_mmap( )</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 48.07978148730078 657.403974038 L 1208.746214621288 657.403974038" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(1223.2300948806212,657.403974038) translate(-1223.2300948806212,-657.403974038)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1208.5702970472878 650.0740751213333 L 1223.2300948806212 657.403974038 L 1208.5702970472878 664.7338729546667 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1223.2300948806212 730.409767248 L 1214.4342161806212 730.409767248 M 694.5044896744884 699.6241917979999 L 694.5044896744884 699.6241917979999 A 15.832581659999999 15.832581659999999 0 0 1 710.3370713344883 683.7916101379999 L 1198.6016345206212 683.7916101379999 L 1198.6016345206212 683.7916101379999 A 15.832581659999999 15.832581659999999 0 0 1 1214.4342161806212 699.6241917979999 L 1214.4342161806212 761.195342698 L 1214.4342161806212 761.195342698 A 15.832581659999999 15.832581659999999 0 0 1 1198.6016345206212 777.027924358 L 710.3370713344883 777.027924358 L 710.3370713344883 777.027924358 A 15.832581659999999 15.832581659999999 0 0 1 694.5044896744884 761.195342698 L 694.5044896744884 699.6241917979999" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="719.1329500344884" y="708.420070498" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">   drm_gem_mmap( ) //默认的gem mmap实现</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="719.1329500344884" y="726.011827898" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">       1. vma.vm_pgoff --&gt; vm_node --&gt; gem_object</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="719.1329500344884" y="743.603585298" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">       2.drm_gem_mmap_obj( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="719.1329500344884" y="761.195342698" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                </text><text fill="#ff00ff" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="788.5387117532384" y="761.195342698" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">obj-&gt;funcs-&gt;mmap( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="941.9245607522619" y="761.195342698" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> // if not null(在dumb_create中设置)</text></g><g><g><rect fill="white" stroke="none" x="1244.0470078039546" y="803.415560458" width="163.0012363264453" height="22.86928462"/></g><g><rect fill="white" stroke="none" x="1244.0470078039546" y="821.007317858" width="525.671326048125" height="22.86928462"/></g><text fill="#ff00ff" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1246.6857714139546" y="819.2481421179999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">obj-&gt;funcs-&gt;mmap( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.071620412978" y="819.2481421179999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> </text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1246.6857714139546" y="836.8398995179999" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">      drm_gem_shmem_object_mmap( )  //在drm_gem_shmem_create( )设置</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1223.2300948806212 843.876602478 L 1776.0513665160795 843.876602478" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(1790.5352467754128,843.876602478) translate(-1790.5352467754128,-843.876602478)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1775.8754489420794 836.5467035613333 L 1790.5352467754128 843.876602478 L 1775.8754489420794 851.2065013946667 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1790.5352467754128 952.065910488 L 1781.7393680754128 952.065910488 M 1376.1330668622488 886.096820238 L 1376.1330668622488 886.096820238 A 15.832581659999999 15.832581659999999 0 0 1 1391.9656485222488 870.264238578 L 1765.9067864154129 870.264238578 L 1765.9067864154129 870.264238578 A 15.832581659999999 15.832581659999999 0 0 1 1781.7393680754128 886.096820238 L 1781.7393680754128 1018.035000738 L 1781.7393680754128 1018.035000738 A 15.832581659999999 15.832581659999999 0 0 1 1765.9067864154129 1033.867582398 L 1391.9656485222488 1033.867582398 L 1391.9656485222488 1033.867582398 A 15.832581659999999 15.832581659999999 0 0 1 1376.1330668622488 1018.035000738 L 1376.1330668622488 886.096820238" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="894.892698938" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_shmem_mmap( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="912.484456338" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="930.076213738" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     a. </text><text fill="green" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1438.420752686116" y="930.076213738" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_shmem_get_pages</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1641.3198920904128" y="930.076213738" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="947.667971138" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">             --&gt;drm_gem_shmem_get_pages_locked()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="965.259728538" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                 --&gt;drm_gem_get_pages()</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="982.851485938" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">                 //保存到</text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1531.0119697271316" y="982.851485938" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">shmem-&gt;pages</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="1000.443243338" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1400.7615272222488" y="1018.035000738" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">     b. vma-&gt;vm_ops = &amp;</text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1572.2074653326003" y="1018.035000738" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_shmem_vm_ops</text></g><g><g><rect fill="white" stroke="none" x="1424.8165390539546" y="1060.255218498" width="164.132263548125" height="22.86928462"/></g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1427.4553026639546" y="1076.087800158" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_get_pages( )</text></g><g><path fill="none" stroke="black" paint-order="fill stroke markers" d=" M 1790.5352467754128 1083.124503118 L 1237.7139751399545 1083.124503118" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g transform="translate(1223.2300948806212,1083.124503118) translate(-1223.2300948806212,-1083.124503118)"><path fill="black" stroke="none" paint-order="stroke fill markers" d=" M 1237.8898927139546 1075.7946042013332 L 1223.2300948806212 1083.124503118 L 1237.8898927139546 1090.4544020346666 Z"/></g></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1223.2300948806212 1164.9261750279998 L 1214.4342161806212 1164.9261750279998 M 776.3512456559338 1125.3447208779999 L 776.3512456559338 1125.3447208779999 A 15.832581659999999 15.832581659999999 0 0 1 792.1838273159337 1109.512139218 L 1198.6016345206212 1109.512139218 L 1198.6016345206212 1109.512139218 A 15.832581659999999 15.832581659999999 0 0 1 1214.4342161806212 1125.3447208779999 L 1214.4342161806212 1204.507629178 L 1214.4342161806212 1204.507629178 A 15.832581659999999 15.832581659999999 0 0 1 1198.6016345206212 1220.3402108379998 L 792.1838273159337 1220.3402108379998 L 792.1838273159337 1220.3402108379998 A 15.832581659999999 15.832581659999999 0 0 1 776.3512456559338 1204.507629178 L 776.3512456559338 1125.3447208779999" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="800.9797060159337" y="1134.1405995779996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">根据obj-&gt;flip-&gt;f_mapping</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="800.9797060159337" y="1151.7323569779996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">调用s</text><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="837.0856477883947" y="1151.7323569779996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">hmem_read_mapping_page</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1030.6361543801916" y="1151.7323569779996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">()获取pages</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="800.9797060159337" y="1169.3241143779996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="800.9797060159337" y="1186.9158717779997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">//obj-&gt;flip是在init gem_obj时由shmem_file_setup( )得到</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="800.9797060159337" y="1204.5076291779997" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1790.5352467754128 1302.1418827479997 L 1781.7393680754128 1302.1418827479997 M 1435.3313853436941 1246.7278469379999 L 1781.7393680754128 1246.7278469379999 L 1781.7393680754128 1357.5559185579998 L 1435.3313853436941 1357.5559185579998 L 1435.3313853436941 1246.7278469379999" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="red" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1459.959845703694" y="1271.3563072979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_shmem_vm_ops</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1644.8632880865066" y="1271.3563072979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"> = {</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1459.959845703694" y="1288.9480646979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         .fault = </text><text fill="purple" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1553.6605598150222" y="1288.9480646979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_shmem_fault</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1716.6742164312332" y="1288.9480646979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1459.959845703694" y="1306.5398220979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         .open = drm_gem_shmem_vm_open,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1459.959845703694" y="1324.1315794979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">         .close = drm_gem_shmem_vm_close,</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1459.959845703694" y="1341.7233368979996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">};</text></g><path fill="white" stroke="black" paint-order="fill stroke markers" d=" M 1790.5352467754128 1430.5617117679997 L 1781.7393680754128 1430.5617117679997 M 1395.0450694257254 1399.7761363179998 L 1395.0450694257254 1399.7761363179998 A 15.832581659999999 15.832581659999999 0 0 1 1410.8776510857253 1383.9435546579998 L 1765.9067864154129 1383.9435546579998 L 1765.9067864154129 1383.9435546579998 A 15.832581659999999 15.832581659999999 0 0 1 1781.7393680754128 1399.7761363179998 L 1781.7393680754128 1461.3472872179998 L 1781.7393680754128 1461.3472872179998 A 15.832581659999999 15.832581659999999 0 0 1 1765.9067864154129 1477.1798688779998 L 1410.8776510857253 1477.1798688779998 L 1410.8776510857253 1477.1798688779998 A 15.832581659999999 15.832581659999999 0 0 1 1395.0450694257254 1461.3472872179998 L 1395.0450694257254 1399.7761363179998" stroke-miterlimit="10" stroke-width="1.4659797833333332" stroke-dasharray=""/><g><text fill="purple" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1419.6735297857253" y="1408.5720150179995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">drm_gem_shmem_fault</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1582.6871864019363" y="1408.5720150179995" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">( )</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1419.6735297857253" y="1426.1637724179996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve"></text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1419.6735297857253" y="1443.7555298179996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">    a. 根据page_offset在shmem_pages中得到page</text><text fill="black" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1419.6735297857253" y="1461.3472872179996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">    b. </text><text fill="blue" stroke="none" font-family="sans-serif" font-size="11pt" font-style="normal" font-weight="normal" text-decoration="normal" x="1454.254737061116" y="1461.3472872179996" text-anchor="start" dominant-baseline="alphabetic" xml:space="preserve">vmf_insert_page( )</text></g></g><g/><g/><g/><g/></g></svg>