<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>进程内存检查 · 学习笔记</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Build Jekyll site with the GitBook style.
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="kevin_zh"><link rel="stylesheet" href="/blog/assets/gitbook/style.css">
<link rel="stylesheet" href="/blog/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.css">
<link rel="stylesheet" href="/blog/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.css">
<link rel="stylesheet" href="/blog/assets/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="/blog/assets/gitbook/gitbook-plugin-search-pro/search.css">
<link rel="stylesheet" href="/blog/assets/gitbook/gitbook-plugin-splitter/splitter.css">

<link rel="stylesheet" href="/blog/assets/gitbook/rouge/magritte.css">

<link rel="stylesheet" href="/blog/assets/gitbook/custom.css">
<link rel="stylesheet" href="/blog/assets/gitbook/custom-local.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="/blog/assets/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="/blog//assets/gitbook/images/favicon.ico" type="image/x-icon">




            <link rel="prev" href="/blog/jekyll/2018-05-15-Wayland&Weston.html" />
        

        
            <link rel="next" href="/blog/drm/2018-06-21-DRM_IOCTL.html" />
        
    </head>
    <body>
        <div class="book"><div class="book-summary">
    <script type="text/javascript">
        // Fixes the page links scroll problem on both desktop and mobile browsers
        function pageScrollToTop(element) {
            // both mobile and non-mobile
            $('div.body-inner').animate({scrollTop: 0});
            $(element).parent().find('li>ul>li').removeClass('active');
            return true;  // propagate
        }
        // Fixes the anchor links scroll problem on mobile browsers
        function mobilePageScrollToAnchor(element) {
            $(element).closest('li.chapter').find('ul>li').removeClass('active');
            $(element).parent().addClass('active');
            if ($(document).width() <= 1240) {
                $('div.body-inner').animate({scrollTop: $($(element).attr('href')).get(0).offsetTop});
            }
            return true;
        }
    </script>

    <nav role="navigation">
        <div id="book-search-input" role="search">
            <input type="text" placeholder="Type to search" />
        </div>
        <div id="book-search-input-link" role="search">
            <a href="/blog/assets/search.html">Click to Search</a>
        </div>
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="/blog">
            
                <a href="/blog/" onclick="pageScrollToTop(this)">
                    学习笔记
                </a>
            </li>

            <li class="divider"></li>

            
                <!-- <p>pages</p> -->
                
                    

                    

                    
                
            
                <!-- <p>posts</p> -->
                
                    

                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2013-03-02-cobalt.html">
                        
                            <a href="/blog/jekyll/2013-03-02-cobalt.html" onclick="pageScrollToTop(this)">
                                Cobalt
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/drm/2018-02-01-DRM.html">
                        
                            <a href="/blog/drm/2018-02-01-DRM.html" onclick="pageScrollToTop(this)">
                                DRM子系统
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2018-03-21-YUV.html">
                        
                            <a href="/blog/jekyll/2018-03-21-YUV.html" onclick="pageScrollToTop(this)">
                                YUV编码
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2018-05-15-Wayland&Weston.html">
                        
                            <a href="/blog/jekyll/2018-05-15-Wayland&Weston.html" onclick="pageScrollToTop(this)">
                                Wayland&amp;Weston
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter active" data-level="1.2" data-path="/blog/jekyll/2018-05-20-memory_check.html">
                        
                            <a href="/blog/jekyll/2018-05-20-memory_check.html" onclick="pageScrollToTop(this)">
                                进程内存检查
                            </a>
                            
                                
                                    <ul><li><a href="#1进程内存映射文件smaps" onclick="mobilePageScrollToAnchor(this)" >1.进程内存映射文件smaps</a><ul><li><a href="#11-两种映射" onclick="mobilePageScrollToAnchor(this)" >1.1 两种映射</a></li><li><a href="#12-各字段含义" onclick="mobilePageScrollToAnchor(this)" >1.2 各字段含义</a></li><li><a href="#13-不同变量的位置" onclick="mobilePageScrollToAnchor(this)" >1.3 不同变量的位置</a></li></ul></li><li><a href="#2free-命令" onclick="mobilePageScrollToAnchor(this)" >2.free 命令</a><ul><li><a href="#21-buffer与cache" onclick="mobilePageScrollToAnchor(this)" >2.1 buffer与cache</a></li><li><a href="#22-手动释放缓存" onclick="mobilePageScrollToAnchor(this)" >2.2. 手动释放缓存</a></li></ul></li><li><a href="#3mtrace" onclick="mobilePageScrollToAnchor(this)" >3.mtrace</a></li><li><a href="#4strace与ltrace" onclick="mobilePageScrollToAnchor(this)" >4.strace与ltrace</a><ul><li><a href="#41-strace" onclick="mobilePageScrollToAnchor(this)" >4.1 strace</a></li><li><a href="#42-ltrace" onclick="mobilePageScrollToAnchor(this)" >4.2 ltrace</a></li></ul></li></ul>

                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/drm/2018-06-21-DRM_IOCTL.html">
                        
                            <a href="/blog/drm/2018-06-21-DRM_IOCTL.html" onclick="pageScrollToTop(this)">
                                DRM ioctl
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/linux/2018-08-01-DeviceResourceManage.html">
                        
                            <a href="/blog/linux/2018-08-01-DeviceResourceManage.html" onclick="pageScrollToTop(this)">
                                设备资源管理模块
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2019-01-11-Weston.html">
                        
                            <a href="/blog/jekyll/2019-01-11-Weston.html" onclick="pageScrollToTop(this)">
                                Weston
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2019-08-10-Wayland-Misc.html">
                        
                            <a href="/blog/jekyll/2019-08-10-Wayland-Misc.html" onclick="pageScrollToTop(this)">
                                Wayland Misc
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2020-06-22-misc.html">
                        
                            <a href="/blog/jekyll/2020-06-22-misc.html" onclick="pageScrollToTop(this)">
                                Kernel Misc
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2020-08-20-OpenGL_misc.html">
                        
                            <a href="/blog/jekyll/2020-08-20-OpenGL_misc.html" onclick="pageScrollToTop(this)">
                                OpenGL Misc
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2020-10-02-FuncTrace.html">
                        
                            <a href="/blog/jekyll/2020-10-02-FuncTrace.html" onclick="pageScrollToTop(this)">
                                Function Trace
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2021-04-27-ffmpeg.html">
                        
                            <a href="/blog/jekyll/2021-04-27-ffmpeg.html" onclick="pageScrollToTop(this)">
                                ffmpeg命令
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2022-04-27-bit.html">
                        
                            <a href="/blog/jekyll/2022-04-27-bit.html" onclick="pageScrollToTop(this)">
                                位运算
                            </a>
                            
                                
                            
                        </li>
                    
                        
                        <li class="chapter" data-level="1.1" data-path="/blog/jekyll/2022-05-02-App_misc.html">
                        
                            <a href="/blog/jekyll/2022-05-02-App_misc.html" onclick="pageScrollToTop(this)">
                                linux dev misc
                            </a>
                            
                                
                            
                        </li>
                    

                    
                        <li class="divider"></li>
                    
                
            
        </ul>
    </nav>
</div>
<div class="book-body">
                <div class="book-header" role="navigation">
                    <!-- Title -->
                    <h1>
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        
                            <a href="." >进程内存检查</a>
                        
                    </h1>
                </div>

                <div class="body-inner"><div class="page-wrapper" tabindex="-1" role="main">
    

    <div class="page-inner">
        <div id="book-search-results">
            <div class="search-noresults">
                <section class="normal markdown-section">
                    
                        <h1 id="/jekyll/memory_check">进程内存检查</h1>
                    

                    <h1 id="1进程内存映射文件smaps">1.进程内存映射文件smaps</h1>

<p>在内核的数据结构中，进程、进程使用内存、虚拟内存块和一个二进制程序文件的对应关系图如下。</p>

<p><img src="/blog/assets/memory_check/vm_area.png" alt="vm_area" /></p>

<p>查看<code class="language-plaintext highlighter-rouge">/proc/${PID}/smaps</code>，可以得到每一个vm_area_node的详细信息。</p>

<p>下图是一个具体的<strong>vm_area_node</strong>信息。</p>

<p><img src="/blog/assets/memory_check/smap_file.png" alt="smaps" /></p>

<h2 id="11-两种映射">1.1 两种映射</h2>

<p>下面两种映射的介绍，是为了下一节解释各字段含义做准备。</p>

<ul>
  <li>文件映射</li>
</ul>

<p>就是存储介质(比如：磁盘)中的数据通过文件系统映射到内存再通过文件映射映射到虚拟空间，这样，用户就可以在用户空间通过 open, read, write 等函数区操作文件内容。代码中函数open(), read(), write(), close(), mmap(fd，…)… 操作的虚拟地址都属于文件映射。</p>

<ul>
  <li>匿名映射</li>
</ul>

<p>就是用户空间要求内核分配一定的物理内存来存储数据，这部分内存不属于任何文件。内核就使用匿名映射将内存中的某段物理地址与用户空间一一映射，这样用户就可用直接操作虚拟地址来范围这段物理内存。比如使用malloc(), mmap(NULL，…)申请内存。</p>

<h2 id="12-各字段含义">1.2 各字段含义</h2>

<ul>
  <li><span style="background-color: yellow">第一行</span></li>
</ul>

<p><img src="/blog/assets/memory_check/vm_area_node_head.png" alt="smaps_head" /></p>

<blockquote>
  <ol>
    <li><span style="color:hotpink;">08048000-080bc000</span>: 该虚拟内存段的开始和结束位置</li>
    <li><span style="color:orange">r-xp</span>:内存段的权限，分别是可读、可写、可运行、私有或共享，最后一位p代表私有，s代表共享(如共享的内存， shm). 如果有”w”，表示是库的数据区.</li>
    <li><span style="color:green">00000000</span>: 虚拟内存段起始地址在对应的映射文件中以页为单位的偏移量，
对匿名映射，它等于0或者vm_start/PAGE_SIZE</li>
    <li><span style="color:orangered;">03:02</span>: 文件的主设备号和次设备号。
对有名映射来说，是映射的文件所在设备的设备号
对匿名映射来说，因为没有文件在磁盘上，所以没有设备号，始终为00:00。</li>
    <li><span style="color:blue;">13130</span>: 被映射到虚拟内存的文件的索引节点号,通过该节点可以找到对应的文件，
对匿名映射来说，因为没有文件在磁盘上，所以为0</li>
    <li><strong>/bin/bash</strong>: 被映射到虚拟内存的文件名称。后面带(deleted)的是内存数据，可以被销毁。
对有名映射来说，是映射的文件名。
对匿名映射来说，是此段虚拟内存在进程中的角色。[stack]表示在进程中作为栈使用，[heap]表示堆。其余情况比如mmap(NULL, ….)则无显示。</li>
  </ol>
</blockquote>

<ul>
  <li>
    <p><span style="background-color: yellow">Size</span></p>

    <p>虚拟内存空间大小。但是这个内存值不一定是物理内存实际分配的大小，因为在用户态上，虚拟内存总是延迟分配的。这个值计算也非常简单，就是该VMA的开       始位置减结束位置。</p>

    <p><strong>延迟分配</strong>:就是当进程申请内存的时候，Linux会给他先分配页，但是并不会区建立页与页框的映射关系，也就是并不会分配物理内存，而当真正使用的时候，就会产生一个缺页异常，硬件跳转page fault处理程序执行，在其中分配物理内存，然后修改页表(创建页表项)。异常处理完毕，返回程序用户态，继续执行。</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Rss</span> resident set size</p>

    <p>实际分配的内存，这部分物理内存已经分配，不需要缺页中断就可以使用的。<strong>但可能是和其他进程共享的</strong>。</p>

    <p>这里有一个公式计算Rss：</p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Rss</span><span class="o">=</span><span class="n">Shared_Clean</span><span class="o">+</span><span class="n">Shared_Dirty</span><span class="o">+</span><span class="n">Private_Clean</span><span class="o">+</span><span class="n">Private_Dirty</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><span style="background-color: yellow">Shared_Clean</span>  <span style="background-color: yellow">Shared_Dirty</span>   <span style="background-color: yellow">Private_Clean</span>  <span style="background-color: yellow">Private_Dirty</span></p>

    <p>share/private：表示该页面是共享还是私有。</p>

    <p>dirty/clean： 表示该页面是否被修改过，如果修改过（dirty），在页面被淘汰的时候，就会把该脏页面回写到交换分区(换出，swap out)。有 一个标志位用于表示页面是否dirty。</p>

    <p>share/private_dirty/clean 计算逻辑：</p>

    <p>查看该page的引用数，如果引用&gt;1，则归为shared，如果是1，则归为private，再查看该page的flag，是否标记为_PAGE_DIRTY，如果不是，则认为干净的</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Pss</span> proportional set size</p>

    <p>平摊计算后的实际物理使用内存(有些内存会和其他进程共享，例如mmap进来的)。实际上包含上面private_clean+private_dirty，和按比例均分的shared_clean、shared_dirty。</p>

    <p>举个计算Pss的例子：</p>

    <p>如果进程A有x个private_clean页面，有y个private_dirty页面，有z个shared_clean仅和进程B共享，有h个shared_dirty页面和进程B、C共享。那么进程A的Pss为：x + y + z/2 + h/3</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Referenced</span></p>

    <p>当前页面被标记为已引用或者包含匿名映射（The amount of memory currently marked as referenced or a mapping associated with a file may contain anonymous pages）。在Linux内存管理的页面替换算法中，当某个页面被访问后，Referenced标志被设置，如果该标志设置了，就不能将该页移出。</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Anonymous</span></p>

    <p>匿名映射的物理内存，这部分内存不是来自于文件。</p>
  </li>
  <li>
    <p><span style="background-color: yellow">VmFlags</span></p>

    <p>vm_area的各种属性，具体如下：</p>

    <p><img src="/blog/assets/memory_check/vmflags.png" alt="vmflags" width="400px" height="450px" /></p>
  </li>
</ul>

<h2 id="13-不同变量的位置">1.3 不同变量的位置</h2>

<p>一个库映射到内存， 一般分为代码段、数据段和只读数据段</p>
<ul>
  <li>r- --p: so中的字符串常数</li>
  <li>rw--p: so中的全局变量，静态变量</li>
  <li>r- -xp: so的代码段，常量</li>
  <li>- ---p: 表示该 VMA 是私有的，不可执行，且不可读写. 这通常用于保护敏感数据或代码，防止其被修改或执行</li>
</ul>

<p>下面这段代码展示了不同变量的存储位置：</p>

<p><img src="/blog/assets/memory_check/variable_location.png" alt="variable" width="650px" height="450px" /></p>

<h1 id="2free-命令">2.free 命令</h1>

<p>free 命令用于显示系统的内存状态，包括物理内存、交换内存（swap）和内核缓冲区内存。详细输出如下：</p>

<p><img src="/blog/assets/memory_check/free.png" alt="variable" width="650px" height="60px" /></p>

<ul>
  <li>Mem 行（第二行）显示了内存的使用情况。</li>
  <li>
    <p>Swap行（第三行）显示了交换空间的使用情况。</p>
  </li>
  <li>total: 表示系统总的可用<u>物理内存</u>和<u>交换空间</u>大小。</li>
  <li>used : 表示已经被使用的<u>物理内存</u>和<u>交换空间</u>。</li>
  <li>free : 表示还有多少<u>物理内存</u>和<u>交换空间</u>可用使用。</li>
  <li>shared: 显示被共享使用的<u>物理内存</u>大小。</li>
  <li>buff/cache: 显示被 buffer 和 cache 使用的物<u>理内存</u>大小。</li>
  <li>available: 显示还可以被应用程序使用的<u>物理内存</u>大小。</li>
</ul>

<h2 id="21-buffer与cache">2.1 buffer与cache</h2>

<ul>
  <li>
    <p><span style="background-color: yellow">buffer</span>: 缓<font style="color:red">冲</font>区</p>

    <p>CPU 在进行一系列操作时，先在内存的一块区域进行，一系列操作完成后，再一次性把该内存区域提交给外部设备，来对这个区域操作。</p>

    <p>比如写一堆数据给硬盘，就先写到内存的一块区域，写好后一次写回到硬盘。又比如读数据，先在内存划出一块区域，让硬盘控制器写数据到这块区域，写好后，CPU 直接访问该区域得到数据。这个内存区域就叫buffer</p>

    <p>缓冲区是内存或存储的一部分，用于在等待从输入设备传输到输出设备时存放项目。</p>

    <p>操作系统通常在打印文档时使用缓冲区。这个过程称为排队（spooling），它将要打印的文档发送到缓冲区，而不是立即发送到打印机。如果打印机没有自己的内部存储器，或者内存已满，操作系统的缓冲区会保存等待打印的信息，同时打印机以自己的速度从缓冲区打印。</p>

    <p>通过将文档排队到缓冲区，处理器可以继续解释和执行指令，同时打印机进行打印。这使用户可以在打印机打印时继续在计算机上进行其他任务。多个打印作业在缓冲区中排队（发音为“Q”）。一个名为<strong>打印排队程序（print spooler）</strong>的程序拦截操作系统中要打印的文档，并将其放入队列中</p>
  </li>
  <li>
    <p><span style="background-color: yellow">cache</span>：缓<font style="color:red">存</font></p>

    <p>CPU 要访问一块数据时，首先访问内存的某个区域，看是否有该数据的缓存，有则直接访问，没有则访问它的来源地。
   CPU 利用内存或高速缓存对数据的再备份，为以后的再次访问提供方便</p>

    <p>缓存如今的大多数计算机通过缓存（发音为“cash”）来提高处理速度。</p>

    <p>缓存有两种主要类型：内存缓存和磁盘缓存。让我们详细了解一下内存缓存。</p>

    <p>L1 缓存：</p>

    <p>L1 缓存直接内置在处理器芯片中。     <br />
   它通常容量很小，范围从 8 KB 到 128 KB。
   L1 缓存存储经常使用的指令和数据，以便快速访问。</p>

    <p>L2 缓存：</p>

    <p>L2 缓存比 L1 缓存稍慢，但容量更大。
   它的大小范围从 64 KB 到 16 MB。
   一些现代处理器包括高级传输缓存，这是一种直接内置在处理器芯片上的 L2 缓存类型。
   使用高级传输缓存的处理器的性能比不使用它的处理器要快得多。
   现今的个人计算机通常具有 512 KB 到 12 MB 的高级传输缓存。</p>

    <p>缓存通过存储经常使用的指令和数据来显著加快处理时间。</p>

    <p>当处理器需要一条指令或数据时，它按照以下顺序搜索内存：L1 缓存，然后是 L2 缓存，然后是 RAM。</p>

    <p>如果所需信息在内存中找不到，处理器必须搜索速度较慢的存储介质，例如硬盘或光盘。</p>
  </li>
</ul>

<h2 id="22-手动释放缓存">2.2. 手动释放缓存</h2>

<ol>
  <li>首先，<u>使用sync命令将未写入磁盘的数据同步到磁盘，以确保文件系统的完整性。</u></li>
  <li>然后，通过设置/proc/sys/vm/drop_caches来释放内存缓存：
    <ul>
      <li>echo 1 &gt; /proc/sys/vm/drop_caches：释放页缓存。</li>
      <li>echo 2 &gt; /proc/sys/vm/drop_caches：释放 dentries 和 inodes。</li>
      <li>echo 3 &gt; /proc/sys/vm/drop_caches：释放所有缓存。</li>
    </ul>
  </li>
</ol>

<h1 id="3mtrace">3.mtrace</h1>

<p>mtrace 是 Linux 系统内核自带的一个内存追踪函数。它会在每个内存申请函数（malloc、realloc、calloc）的位置记录下信息，并在每个内存释放的位置记录下 free 的内存信息。其中包含有内存申请的地址、内存申请的大小、释放内存的地址、释放内存的大小。</p>

<p>具体来说，mtrace 函数的作用如下：</p>

<ul>
  <li>安装钩子函数，用于跟踪内存分配和释放。</li>
  <li>记录有关内存分配和释放的跟踪信息。</li>
  <li>可以用于发现程序中的内存泄漏和试图释放未分配内存的情况。</li>
</ul>

<p>使用方式：</p>

<ol>
  <li>在代码中包含 &lt;mcheck.h&gt; 头文件。</li>
  <li>在程序启动时调用 mtrace() 函数，开启内存分配和释放跟踪。</li>
  <li>程序结束时，可以调用 muntrace() 函数关闭内存分配和释放跟踪。</li>
  <li>运行mtrace脚本，分析跟踪日志，生成报告。</li>
</ol>

<p>请注意，mtrace 的跟踪输出通常是文本形式，不一定易于人类阅读。GNU C 库提供了一个 Perl 脚本 mtrace，用于解析跟踪日志并生成人类可读的输出。为了获得最佳效果，建议编译时启用调试，以便在可执行文件中记录行号信息。不过，mtrace 的跟踪会带来性能损耗.如果 MALLOC_TRACE 没有指向有效且可写的路径， 则mtrace不会记录信息。</p>

<p><img src="/blog/assets/memory_check/mtrace.png" alt="mtrace" width="500px" height="250px" />
<img src="/blog/assets/memory_check/mtrace_2.png" alt="mtrace" width="650px" height="250px" /></p>

<h1 id="4strace与ltrace">4.strace与ltrace</h1>

<p>ltrace 用于跟踪程序的库函数调用，而 strace 则用于跟踪系统调用。
它们都基于 ptrace 系统调用，但跟踪库函数和跟踪系统调用之间存在差异。 通过它们，我们也可以对应用的内存申请、释放进行跟踪。</p>

<p>ltrace 的工作原理：</p>
<ul>
  <li>ptrace 附加到正在运行的程序。</li>
  <li>定位程序的 PLT。</li>
  <li>使用 PTRACE_POKETEXT 设置软件断点（int $3 指令）覆盖库函数的 PLT 中的汇编 trampoline。</li>
  <li>恢复程序执行。</li>
</ul>

<p>strace 应该也是相类似的工作原理</p>

<h2 id="41-strace">4.1 strace</h2>

<p>strace 是一个强大的 Linux 命令，用于诊断、调试和统计。它允许您跟踪正在运行的程序的系统调用和接收的信号。下面是一些关于 strace 的参数使用方法。</p>

<ul>
  <li>-c：统计每个系统调用的执行时间、次数和错误次数。 示例：打印执行 uptime 时系统调用的时间、次数和错误次数：
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strace <span class="nt">-c</span> <span class="nb">uptime</span>
</code></pre></div>    </div>
  </li>
  <li>-f：跟踪子进程，这些子进程是由当前跟踪的进程创建的。</li>
  <li>-i：在系统调用时打印指令指针。</li>
  <li>-t：跟踪的每一行都以时间为前缀。</li>
  <li>-tt：如果给出两次，则打印时间将包括微秒。</li>
  <li>-ttt：如果给定三次，则打印时间将包括微秒，并且前导部分将打印为自启动以来的秒数。</li>
  <li>-T：显示花费在系统调用上的时间。</li>
</ul>

<p>限定表达式：</p>
<ul>
  <li>-e trace=set：仅跟踪指定的系统调用集。例如，trace=open,close,read,write 表示仅跟踪这四个系统调用。</li>
  <li>-e trace=file：跟踪所有以文件名作为参数的系统调用。示例：打印执行 ls 时与文件有关的系统调用：
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>file <span class="nb">ls</span>
</code></pre></div>    </div>
  </li>
  <li>-e trace=process：跟踪涉及进程管理的所有系统调用。</li>
  <li>-e trace=network：跟踪所有与网络相关的系统调用。</li>
  <li>-e trace=signal：跟踪所有与信号相关的系统调用。</li>
  <li>-e trace=ipc：跟踪所有与 IPC 相关的系统调用。</li>
  <li><span style="color: red;">-e trace=memory：跟踪所有与 momory 相关的系统调用。</span></li>
</ul>

<p>其他参数：</p>
<ul>
  <li>-o 文件名：将跟踪输出写入文件而不是 stderr。</li>
  <li>-p pid：使用进程 ID pid 附加到该进程并开始跟踪</li>
</ul>

<p>下面是运行 <code class="language-plaintext highlighter-rouge">strace ls</code> 的输出
<img src="/blog/assets/memory_check/strace.png" alt="strace" width="650px" height="500px" /></p>

<h2 id="42-ltrace">4.2 ltrace</h2>

<p>ltrace 是一个用于跟踪程序库调用的 Linux 工具。它可以拦截并记录被执行进程调用的动态库函数，以及该进程接收到的信号。此外，ltrace 还可以拦截并打印程序执行的系统调用。</p>

<p>常用参数和示例：
-c：统计每个系统调用的执行时间、次数和错误次数。 示例：打印执行 uptime 时系统调用的时间、次数和错误次数：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ltrace <span class="nt">-c</span> <span class="nb">uptime</span>
</code></pre></div></div>

<ul>
  <li>-f：跟踪子进程，这些子进程是由当前跟踪的进程创建的。</li>
  <li>-i：在系统调用时打印指令指针。</li>
  <li>-t：跟踪的每一行都以时间为前缀。</li>
  <li>-tt：如果给出两次，则打印时间将包括微秒。</li>
  <li>-ttt：如果给定三次，则打印时间将包括微秒，并且前导部分将打印为自启动以来的秒数。</li>
  <li>-T：显示花费在系统调用上的时间。</li>
</ul>

<p>限定表达式：</p>

<ul>
  <li>-e trace=set：仅跟踪指定的系统调用集。例如，trace=open,close,read,write 表示仅跟踪这四个系统调用。</li>
  <li>-e trace=file：跟踪所有以文件名作为参数的系统调用。示例：打印执行 ls 时与文件有关的系统调用：
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ltrace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>file <span class="nb">ls</span>
</code></pre></div>    </div>
  </li>
  <li>-e trace=process：跟踪涉及进程管理的所有系统调用。</li>
  <li>-e trace=network：跟踪所有与网络相关的系统调用。</li>
  <li>-e trace=signal：跟踪所有与信号相关的系统调用。</li>
  <li>-e trace=ipc：跟踪所有与 IPC 相关的系统调用。</li>
</ul>

<p>其他参数：</p>

<ul>
  <li>-o 文件名：将跟踪输出写入文件而不是 stderr。</li>
  <li>-p pid：使用进程 ID pid 附加到该进程并开始跟踪。</li>
</ul>

<p>下面是运行 <code class="language-plaintext highlighter-rouge">ltrace ls</code> 的输出</p>

<p><img src="/blog/assets/memory_check/ltrace.png" alt="ltrace" width="650px" height="500px" /></p>
</section>
            </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
    </div>
</div>

<!-- introduce mathjax support -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [ ['$', '$'], ['\\(', '\\)'] ]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script
  type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>


<!-- introduce per-page mermaid support -->

    <script>
    function render_mermaid() {
        mermaid.initialize({
            startOnLoad: false,
            theme: "default",
        });
        window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
    }

    function initialize_mermaid() {
        if (document.readyState === "loading") {
            // Loading hasn't finished yet
            document.addEventListener("DOMContentLoaded", render_mermaid);
        } else {
            // `DOMContentLoaded` has already fired
            render_mermaid();
        }
    }

    if (window.mermaid_script && window.mermaid) {
        initialize_mermaid();
    } else {
        window.mermaid_script = document.createElement("script");
        mermaid_script.onload = initialize_mermaid;
        document.head.appendChild(mermaid_script);
        mermaid_script.defer = true;
        mermaid_script.id = 'mermaid-script';
        mermaid_script.src = '/blog/assets/gitbook/mermaid.min.js';
    }
</script>



<!-- introduce mathjax support -->
<script>
    function fixes_chrome_anchors() {
        let chrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
        if (window.location.hash && chrome) {
            setTimeout(function () {
                var hash = window.location.hash;
                window.location.hash = "";
                window.location.hash = hash;
            }, 300);
        }
    }

    if (document.readyState === "loading") {
        // Loading hasn't finished yet
        document.addEventListener("DOMContentLoaded", fixes_chrome_anchors);
    } else {
        // `DOMContentLoaded` has already fired
        fixes_chrome_anchors();
    }
</script>


                        <a href="/blog/jekyll/2018-05-15-Wayland&Weston.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Wayland&Weston">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    

                    
                        <a href="/blog/drm/2018-06-21-DRM_IOCTL.html" class="navigation navigation-next navigation-unique" aria-label="Next page: DRM ioctl">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    
                </div>
            </div>

            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "DRM ioctl",
            "level": "1.2",
            "depth": 1,
            "path": "_posts/2018-06-11-DRM_IOCTL.md",
            "ref": "_posts/2018-06-11-DRM_IOCTL.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "expandable-chapter-small2": {
                "articlesExpand": true,
            },
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},            "sharing": {
                "facebook": false,

                "google": false,

                "github": false,
              
                "github_link": "https://github.com",
              

                "telegram": false,
                "telegram_link": "https://t.me",

                "instapaper": false,

                "twitter": false,
              

                "vk": false,

                "weibo": false,

                "all": ["facebook", "google", "twitter", "weibo", "instapaper", "github", "telegram"]
            },
"theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            },
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "学习笔记",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_posts/2018-05-20-memory_check.md",
        "mtime": "2018-05-20 00:00:00 +0800",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3"
    },
    "basePath": "/blog",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="/blog/assets/gitbook/gitbook.js"></script>
<script src="/blog/assets/gitbook/theme.js"></script>

<script src="/blog/assets/gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
<script src="/blog/assets/gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
<script src="/blog/assets/gitbook/gitbook-plugin-expandable-chapters-small2/expandable-chapters-small.js"></script>
<script src="/blog/assets/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="/blog/assets/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="/blog/assets/gitbook/gitbook-plugin-search-pro/search.js"></script>
<!-- <script src="/blog/assets/gitbook/gitbook-plugin-sharing/buttons.js"></script> -->
<script src="/blog/assets/gitbook/gitbook-plugin-splitter/splitter.js"></script>

<!--
<script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script>
-->

</body>
</html>