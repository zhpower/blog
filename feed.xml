<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/blog/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/blog/" rel="alternate" type="text/html" /><updated>2024-04-26T17:54:41+08:00</updated><id>http://localhost:4000/blog/feed.xml</id><title type="html">å­¦ä¹ ç¬”è®°</title><subtitle>Build Jekyll site with the GitBook style.
</subtitle><author><name>kevin_zh</name></author><entry><title type="html">misc</title><link href="http://localhost:4000/blog/jekyll/2022-06-22-misc.html" rel="alternate" type="text/html" title="misc" /><published>2022-06-22T00:00:00+08:00</published><updated>2022-06-22T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/misc</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2022-06-22-misc.html"><![CDATA[<h1 id="kref">kref</h1>

<p>kref_init æ˜¯ä¸€ä¸ªç”¨äºåˆå§‹åŒ–å†…æ ¸å¯¹è±¡å¼•ç”¨è®¡æ•°å™¨ï¼ˆkrefsï¼‰çš„å‡½æ•°ã€‚å®ƒå…è®¸ä½ ä¸ºä½ çš„å¯¹è±¡æ·»åŠ å¼•ç”¨è®¡æ•°ï¼Œç¡®ä¿åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨å’Œä¼ é€’å¯¹è±¡æ—¶ï¼Œä»£ç çš„æ­£ç¡®æ€§ã€‚ä»¥ä¸‹æ˜¯å…³äº kref_init çš„ä¸€äº›é‡è¦ä¿¡æ¯ï¼š</p>

<ul>
  <li>åˆå§‹åŒ–ï¼š</li>
</ul>

<p>åœ¨åˆ†é…å†…å­˜å¹¶åˆ›å»ºå¯¹è±¡åï¼Œä½ éœ€è¦è°ƒç”¨ kref_init æ¥åˆå§‹åŒ–å¼•ç”¨è®¡æ•°å™¨ã€‚ä¾‹å¦‚ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">my_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™å°†åœ¨ kref ä¸­çš„ refcount è®¾ç½®ä¸º 1ã€‚</p>

<ul>
  <li>ä½¿ç”¨è§„åˆ™ï¼š</li>
</ul>

<p>åœ¨å¯¹æŒ‡é’ˆè¿›è¡Œéä¸´æ—¶æ‹·è´ï¼ˆå°¤å…¶æ˜¯ä¼ é€’ç»™å¦ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼‰ä¹‹å‰ï¼Œå¿…é¡»ä½¿ç”¨ kref_get å¢åŠ å¼•ç”¨è®¡æ•°ã€‚
åœ¨å®Œæˆå¯¹æŒ‡é’ˆçš„å¤„ç†åï¼Œå¿…é¡»è°ƒç”¨ kref_putã€‚å¦‚æœè¿™æ˜¯å¯¹æŒ‡é’ˆçš„æœ€åä¸€æ¬¡å¼•ç”¨ï¼Œé‡Šæ”¾ç¨‹åºå°†è¢«è°ƒç”¨ã€‚</p>

<ul>
  <li>ç¤ºä¾‹ï¼š</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">data_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">my_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">my_data</span><span class="p">,</span> <span class="n">refcount</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">more_data_handling</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb_data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">my_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">cb_data</span><span class="p">;</span>
    <span class="c1">// å¤„ç† data</span>
    <span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">data_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">my_data_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">my_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
    <span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
    <span class="c1">// åˆ›å»ºçº¿ç¨‹å¤„ç†æ•°æ®</span>
    <span class="c1">// ...</span>
    <span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">data_release</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œä¸¤ä¸ªçº¿ç¨‹å¤„ç†æ•°æ®çš„é¡ºåºå¹¶ä¸é‡è¦ï¼Œkref_put ä¼šåœ¨æ•°æ®ä¸å†è¢«å¼•ç”¨æ—¶é‡Šæ”¾å®ƒã€‚
è¯·æ³¨æ„ï¼Œéµå¾ªè¿™äº›è§„åˆ™å¯ä»¥ç¡®ä¿æ­£ç¡®ç®¡ç†å†…æ ¸å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œæ‚¬æŒ‚æŒ‡é’ˆã€‚</p>

<h1 id="idrid-range">IDR(ID Range)</h1>

<p>IDR æ˜¯ä¸€ç§ç”¨äºç®¡ç†è¿ç»­æ•´æ•°èŒƒå›´çš„æ•°æ®ç»“æ„ï¼Œé€šå¸¸ç”¨äºå†…æ ¸ä¸­éœ€è¦ä¸ºå¯¹è±¡åˆ†é…å”¯ä¸€æ ‡è¯†ç¬¦çš„åœºæ™¯ã€‚
idr_alloc å‡½æ•°ç”¨äºåœ¨ Linux å†…æ ¸ä¸­åˆ†é… IDRï¼ˆID Rangeï¼‰å¯¹è±¡ä¸­çš„æœªä½¿ç”¨çš„ IDã€‚</p>

<p>ä»¥ä¸‹æ˜¯ idr_alloc å‡½æ•°çš„ç”¨æ³•ï¼š</p>

<ol>
  <li>é¦–å…ˆï¼Œæ‚¨éœ€è¦åˆå§‹åŒ–ä¸€ä¸ª IDRã€‚å¯¹äºé™æ€åˆ†é…çš„ IDRï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ DEFINE_IDR() å®ï¼›å¯¹äºåŠ¨æ€åˆ†é…çš„ IDRï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ idr_init() å‡½æ•°ã€‚</li>
  <li>è°ƒç”¨ idr_alloc() æ¥åˆ†é…ä¸€ä¸ªæœªä½¿ç”¨çš„ IDã€‚</li>
  <li>ä½¿ç”¨ idr_find() æŸ¥è¯¢ä¸è¯¥ ID ç›¸å…³çš„æŒ‡é’ˆã€‚</li>
  <li>ä½¿ç”¨ idr_remove() é‡Šæ”¾è¯¥ IDã€‚</li>
</ol>

<p>å¦‚æœéœ€è¦æ›´æ”¹ä¸æŸä¸ª ID ç›¸å…³è”çš„æŒ‡é’ˆï¼Œæ‚¨å¯ä»¥è°ƒç”¨ idr_replace()ã€‚è¿™é€šå¸¸ç”¨äºä¿ç•™ IDï¼Œé€šè¿‡å°† NULL æŒ‡é’ˆä¼ é€’ç»™åˆ†é…å‡½æ•°ï¼Œç„¶åä½¿ç”¨ä¿ç•™çš„ ID åˆå§‹åŒ–å¯¹è±¡ï¼Œæœ€åå°†åˆå§‹åŒ–çš„å¯¹è±¡æ’å…¥ IDRã€‚</p>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½æ»¡è¶³äº† UINT_MAX çš„é™åˆ¶ï¼Œå› æ­¤ä»–ä»¬ä½¿ç”¨ idr_alloc_u32()ã€‚</p>

<p>å¦‚æœéœ€è¦æŒ‰é¡ºåºåˆ†é… IDï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ idr_alloc_cyclic()ã€‚è¯·æ³¨æ„ï¼Œå¤„ç†è¾ƒå¤§æ•°é‡çš„ ID æ—¶ï¼ŒIDR çš„æ•ˆç‡ä¼šé™ä½ï¼Œå› æ­¤ä½¿ç”¨è¿™ä¸ªå‡½æ•°ä¼šæœ‰ä¸€äº›ä»£ä»·ã€‚</p>

<p>å½“æ‚¨ä½¿ç”¨å®Œ IDR åï¼Œå¯ä»¥è°ƒç”¨ idr_destroy() æ¥é‡Šæ”¾ IDR å ç”¨çš„å†…å­˜ã€‚è¿™ä¸ä¼šé‡Šæ”¾ IDR æŒ‡å‘çš„å¯¹è±¡ï¼›å¦‚æœæ‚¨æƒ³è¿™æ ·åšï¼Œè¯·ä½¿ç”¨å…¶ä¸­ä¸€ä¸ªè¿­ä»£å™¨æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚</p>

<p>æ‚¨å¯ä»¥ä½¿ç”¨ idr_is_empty() æ¥æŸ¥çœ‹å½“å‰æ˜¯å¦åˆ†é…äº†ä»»ä½• IDã€‚</p>

<p>å¦‚æœåœ¨ä» IDR åˆ†é…ä¸€ä¸ªæ–° ID æ—¶éœ€è¦å¸¦é”ï¼Œæ‚¨å¯èƒ½éœ€è¦ä¼ é€’ä¸€ç»„é™åˆ¶æ€§çš„ GFP æ ‡å¿—ï¼Œä½†è¿™å¯èƒ½å¯¼è‡´ IDR æ— æ³•åˆ†é…å†…å­˜ã€‚ä¸ºäº†è§£å†³è¯¥é—®é¢˜ï¼Œæ‚¨å¯ä»¥åœ¨è·å–é”ä¹‹å‰è°ƒç”¨ idr_preload()ï¼Œç„¶ååœ¨åˆ†é…ä¹‹åè°ƒç”¨ idr_preload_end()ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/idr.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">idr</span> <span class="n">my_idr</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">;</span>

    <span class="c1">// Initialize the IDR</span>
    <span class="n">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">);</span>

    <span class="c1">// Allocate two unused IDs</span>
    <span class="n">id1</span> <span class="o">=</span> <span class="n">idr_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="s">"sample1"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="n">id2</span> <span class="o">=</span> <span class="n">idr_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="s">"sample2"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

    <span class="c1">// Associate pointers with the IDs</span>
    <span class="n">ptr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xdeadbeef</span><span class="p">;</span>
    <span class="n">ptr2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="mh">0xcafebabe</span><span class="p">;</span>
    <span class="n">idr_replace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">,</span> <span class="n">id1</span><span class="p">);</span>
    <span class="n">idr_replace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="n">ptr2</span><span class="p">,</span> <span class="n">id2</span><span class="p">);</span>

    <span class="c1">// Look up pointers by ID</span>
    <span class="n">ptr1</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="n">id1</span><span class="p">);</span>
    <span class="n">ptr2</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="n">id2</span><span class="p">);</span>

    <span class="c1">// Free the IDs</span>
    <span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="n">id1</span><span class="p">);</span>
    <span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">,</span> <span class="n">id2</span><span class="p">);</span>

    <span class="c1">// Destroy the IDR</span>
    <span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_idr</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h1 id="éä¸€è‡´æ€§å†…å­˜-å’Œä¸€è‡´æ€§">éä¸€è‡´æ€§å†…å­˜ å’Œä¸€è‡´æ€§</h1>

<h2 id="dma_alloc_noncoherent">dma_alloc_noncoherent</h2>

<p>å®ƒæ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªDMAå†…å­˜åˆ†é…å‡½æ•°ï¼Œç”¨äºåˆ†é…ä¸€æ®µç‰©ç†å†…å­˜ï¼Œä½¿å…¶å¯ä»¥è¢«DMAç¡¬ä»¶è®¿é—®12. è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨éä¸€è‡´æ€§å†…å­˜ï¼ˆnon-coherent memoryï¼‰ä¸Šåˆ†é…ä¸€å—åŒºåŸŸï¼Œä»¥ä¾¿è®¾å¤‡å¯ä»¥ä½¿ç”¨å®ƒä½œä¸ºDMAçš„æºæˆ–ç›®æ ‡åœ°å€ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„ç”¨é€”å’Œå‚æ•°ã€‚</p>

<p>dma_alloc_noncoherentå‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">void *dma_alloc_noncoherent(struct device *dev, size_t size, dma_addr_t *dma_handle, gfp_t flag);</code></p>

<ul>
  <li>dev: æŒ‡å‘è®¾å¤‡ç»“æ„çš„æŒ‡é’ˆï¼Œè¡¨ç¤ºè¦ä¸ºå“ªä¸ªè®¾å¤‡åˆ†é…å†…å­˜ã€‚</li>
  <li>size: è¦åˆ†é…çš„å†…å­˜å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚</li>
  <li>dma_handle: ç”¨äºè¿”å›DMAåœ°å€çš„æŒ‡é’ˆã€‚è¿™ä¸ªåœ°å€å¯ä»¥è½¬æ¢ä¸ºä¸æ€»çº¿å®½åº¦ç›¸åŒçš„æ— ç¬¦å·æ•´æ•°ï¼Œå¹¶ä¼ é€’ç»™è®¾å¤‡ä½œä¸ºåˆ†é…åŒºåŸŸçš„DMAåœ°å€åŸºå€ã€‚</li>
  <li>flag: ç”¨äºæŒ‡å®šå†…å­˜åˆ†é…çš„GFP_æ ‡å¿—ï¼ˆç±»ä¼¼äºkmalloc()ä¸­çš„æ ‡å¿—ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨GFP_KERNELæ¥åˆ†é…æ™®é€šå†…æ ¸å†…å­˜ã€‚
éä¸€è‡´æ€§å†…å­˜æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å†…å­˜ï¼Œå†™å…¥å®ƒçš„æ•°æ®å¯ä»¥ç«‹å³è¢«å¤„ç†å™¨æˆ–è®¾å¤‡è¯»å–ï¼Œè€Œæ— éœ€è€ƒè™‘ç¼“å­˜æ•ˆåº”ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒCPUä¸èƒ½ç›´æ¥å¼•ç”¨dma_addr_tï¼Œå› ä¸ºç‰©ç†åœ°å€ç©ºé—´å’ŒDMAåœ°å€ç©ºé—´ä¹‹é—´å¯èƒ½å­˜åœ¨è½¬æ¢ã€‚</li>
</ul>

<p>ä½¿ç”¨dma_alloc_noncoherentåˆ†é…çš„å†…å­˜åŒºåŸŸä¸ä¿è¯ä¸€è‡´æ€§ï¼Œå› æ­¤åœ¨ä½¿ç”¨ä¹‹å‰ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ·æ–°å¤„ç†å™¨çš„å†™ç¼“å†²åŒºï¼Œä»¥ç¡®ä¿è®¾å¤‡å¯ä»¥æ­£ç¡®è¯»å–è¯¥å†…å­˜ã€‚
é‡Šæ”¾ç”±dma_alloc_noncoherentåˆ†é…çš„å†…å­˜æ—¶ï¼Œåº”ä½¿ç”¨dma_free_noncoherentå‡½æ•°ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">void dma_free_noncoherent(struct device *dev, size_t size, void *cpu_addr, dma_addr_t dma_handle);</code></p>

<p>devã€sizeå’Œdma_handleå‚æ•°å¿…é¡»ä¸ä¼ é€’ç»™dma_alloc_noncoherentçš„ç›¸åŒã€‚
cpu_addræ˜¯ç”±dma_alloc_noncoherentè¿”å›çš„è™šæ‹Ÿåœ°å€ã€‚
è¯·æ³¨æ„ï¼Œä¸å…¶ä»–å†…å­˜åˆ†é…å‡½æ•°ä¸åŒï¼Œè¿™äº›å‡½æ•°åªèƒ½åœ¨å¯ç”¨IRQçš„æƒ…å†µä¸‹è°ƒç”¨ã€‚</p>

<p>å¦‚æœä½ çš„é©±åŠ¨ç¨‹åºéœ€è¦å¤§é‡è¾ƒå°çš„DMAä¸€è‡´æ€§å†…å­˜åŒºåŸŸï¼Œä½ å¯ä»¥ä½¿ç”¨DMAæ± ï¼ˆdma_poolï¼‰æ¥åˆ†é…å’Œç®¡ç†è¿™äº›åŒºåŸŸï¼Œè€Œä¸æ˜¯ä½¿ç”¨dma_alloc_coherent()ã€‚DMAæ± ç±»ä¼¼äºkmem_cacheï¼Œä½†å®ƒä½¿ç”¨dma_alloc_coherent()è€Œä¸æ˜¯__get_free_pages()</p>

<h2 id="dma_alloc_wc">dma_alloc_wc</h2>
<p>è¿™ä¸ªå‡½æ•°å…è®¸é©±åŠ¨ç¨‹åºç”³è¯·å¸¦ç¼“å­˜ä¸€è‡´æ€§çš„DMAå†…å­˜ã€‚ç¼“å­˜ä¸€è‡´æ€§æ˜¯æŒ‡ç¡®ä¿CPUå’ŒDMAè®¾å¤‡ä¹‹é—´çš„æ•°æ®ä¸€è‡´æ€§ï¼Œä»¥é¿å…æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä½¿ç”¨dma_alloc_wcåˆ†é…çš„å†…å­˜åŒºåŸŸæ—¨åœ¨åœ¨CPUå’ŒDMAè®¾å¤‡ä¹‹é—´ä¿æŒä¸€è‡´ï¼Œä»¥ä¾¿æ•°æ®æ­£ç¡®ä¼ è¾“ã€‚</p>

<p>é‡Šæ”¾ç”±dma_alloc_wcåˆ†é…çš„å†…å­˜æ—¶ï¼Œåº”ä½¿ç”¨dma_free_wcå‡½æ•°ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">void dma_free_wc(struct device *dev, size_t size, void *cpu_addr, dma_addr_t dma_handle);</code></p>

<ul>
  <li>devã€sizeå’Œdma_handleå‚æ•°å¿…é¡»ä¸ä¼ é€’ç»™dma_alloc_wcçš„ç›¸åŒã€‚</li>
  <li>cpu_addræ˜¯ç”±dma_alloc_wcè¿”å›çš„è™šæ‹Ÿåœ°å€ã€‚</li>
</ul>

<p><u>adf</u></p>

<h1 id="å®šæ—¶å™¨">å®šæ—¶å™¨</h1>

<h2 id="timer_setup">timer_setup</h2>

<p>å®ƒæ˜¯Linuxå†…æ ¸ä¸­ç”¨äºåˆå§‹åŒ–å®šæ—¶å™¨çš„å‡½æ•°ã€‚å®ƒèƒ½å¤Ÿæ–¹ä¾¿åœ°è®¾ç½®å’Œåˆå§‹åŒ–ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œå¹¶é€šè¿‡è®¾ç½®å‚æ•°æ¥çµæ´»åœ°æ§åˆ¶è®¡æ—¶å™¨çš„è¡Œä¸º1. åˆç†ä½¿ç”¨timer_setupå‡½æ•°å¯ä»¥è®©æˆ‘ä»¬æ›´å¥½åœ°å¤„ç†æ—¶é—´ç›¸å…³çš„ä»»åŠ¡ï¼Œæé«˜æ“ä½œç³»ç»Ÿçš„æ€§èƒ½å’Œå¯é æ€§ã€‚</p>

<p>åœ¨Linuxå†…æ ¸ä¸­ï¼Œå®šæ—¶å™¨é€šå¸¸ä½¿ç”¨timer_listç»“æ„ä½“æ¥è¡¨ç¤ºã€‚ä¸‹é¢æ˜¯timer_listç»“æ„ä½“çš„ä¸€äº›å…³é”®å­—æ®µï¼š</p>

<ul>
  <li>entry: å®šæ—¶å™¨åˆ—è¡¨å…ƒç´ ï¼Œç”¨äºå°†å®šæ—¶å™¨æŒ‚è½½åœ¨å†…æ ¸å®šæ—¶å™¨é“¾è¡¨ä¸Šã€‚</li>
  <li>expires: å®šæ—¶å™¨å®šæ—¶æ—¶é—´ã€‚</li>
  <li>function: å®šæ—¶å™¨å›è°ƒå‡½æ•°ï¼Œå®šæ—¶å™¨æ—¶é—´åˆ°æ—¶æ‰§è¡Œè¯¥å‡½æ•°ã€‚</li>
  <li>flags: æ ‡å¿—ä½ï¼Œç”¨äºè®¾ç½®å®šæ—¶å™¨çš„å±æ€§ã€‚</li>
</ul>

<p>åœ¨æ—§ç‰ˆæœ¬çš„å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨init_timerå‡½æ•°æ¥åˆå§‹åŒ–å®šæ—¶å™¨ã€‚è€Œåœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å˜æˆäº†timer_setupå‡½æ•°ã€‚ä¸‹é¢æ˜¯timer_setupå‡½æ•°çš„å®šä¹‰ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">void timer_setup(struct timer_list *timer, void (*callback)(struct timer_list *), unsigned int flags);</code></p>

<p>ä½¿ç”¨timer_setupå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¼ å…¥ä»¥ä¸‹å‚æ•°ï¼š</p>

<ul>
  <li>timer: è¦åˆå§‹åŒ–çš„å®šæ—¶å™¨ã€‚</li>
  <li>callback: å®šæ—¶å™¨çš„å›è°ƒå‡½æ•°ï¼Œæ­¤å‡½æ•°çš„å½¢å‚æ˜¯å½“å‰å®šæ—¶å™¨çš„å˜é‡ã€‚</li>
  <li>flags: æ ‡å¿—ä½ï¼Œå¯ä»¥è®¾ç½®å®šæ—¶å™¨çš„å±æ€§ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/timer.h&gt;</span><span class="cp">
</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">my_timer</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">my_timer_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">timer_list</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"This line is printed after 5 seconds.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_module_with_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"Initializing a module with timer.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Setup the timer for initial use</span>
    <span class="n">timer_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_timer</span><span class="p">,</span> <span class="n">my_timer_callback</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// Set the timer interval to 5000 milliseconds (5 seconds)</span>
    <span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">exit_module_with_timer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">"Goodbye, cruel world!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_module_with_timer</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_module_with_timer</span><span class="p">);</span>

</code></pre></div></div>
<h2 id="é«˜ç²¾åº¦å®šæ—¶å™¨">é«˜ç²¾åº¦å®šæ—¶å™¨</h2>

<p><code class="language-plaintext highlighter-rouge">hrtimer_init</code> æ˜¯ Linux å†…æ ¸ä¸­ä¸é«˜ç²¾åº¦å®šæ—¶å™¨ï¼ˆHRTimerï¼‰ç›¸å…³çš„å‡½æ•°ä¹‹ä¸€ã€‚è®©æˆ‘ä¸ºæ‚¨è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Œå¹¶æä¾›ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š</p>

<ol>
  <li><strong>HRTimer ç®€ä»‹</strong>ï¼š
    <ul>
      <li>HRTimer æ˜¯ Linux å†…æ ¸ä¸­çš„é«˜ç²¾åº¦å®šæ—¶å™¨ï¼Œç”¨äºæä¾›çº³ç§’çº§åˆ«çš„æ—¶é’Ÿç²¾åº¦ã€‚</li>
      <li>ä¸ä¼ ç»Ÿçš„å®šæ—¶å™¨ç›¸æ¯”ï¼ŒHRTimer å…è®¸æ›´ç²¾ç¡®åœ°æ§åˆ¶å®šæ—¶äº‹ä»¶ï¼Œé€‚ç”¨äºå¯¹æ—¶é—´è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ï¼Œå¦‚çœ‹é—¨ç‹—ã€USBã€ä»¥å¤ªç½‘ã€å—è®¾å¤‡ã€è™šæ‹Ÿæœºç­‰å­ç³»ç»Ÿã€‚</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">hrtimer_init</code> å‡½æ•°</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">hrtimer_init</code> ç”¨äºåˆå§‹åŒ–ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">struct hrtimer</code> å®ä¾‹ã€‚</li>
      <li>å‚æ•°ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">timer</code>ï¼šæŒ‡å‘è¦åˆå§‹åŒ–çš„ HRTimer å®ä¾‹çš„æŒ‡é’ˆã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">clock_id</code>ï¼šæ—¶é’Ÿçš„ç§ç±»ï¼Œä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">CLOCK_MONOTONIC</code> è¡¨ç¤ºè‡ªç³»ç»Ÿå¼€æœºä»¥æ¥çš„å•è°ƒé€’å¢æ—¶é—´ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">mode</code>ï¼šå®šæ—¶å™¨çš„æ¨¡å¼ï¼Œå¯ä»¥æ˜¯ç»å¯¹æ—¶é—´ï¼ˆ<code class="language-plaintext highlighter-rouge">HRTIMER_MODE_ABS</code>ï¼‰æˆ–ç›¸å¯¹æ—¶é—´ï¼ˆ<code class="language-plaintext highlighter-rouge">HRTIMER_MODE_REL</code>ï¼‰ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>ç¤ºä¾‹ä»£ç </strong>ï¼š
    <ul>
      <li>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ HRTimer çš„ç®€å•ç¤ºä¾‹ä»£ç ï¼Œç”¨äºåœ¨å†…æ ¸ä¸­å¯åŠ¨ä¸€ä¸ªç›¸å¯¹æ—¶é—´çš„ HRTimerï¼š
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/hrtimer.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/ktime.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
</span>     
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
     
<span class="k">static</span> <span class="k">struct</span> <span class="n">hrtimer</span> <span class="n">my_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ktime_t</span> <span class="n">interval</span><span class="p">;</span>
     
<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">my_timer_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Your timer callback logic here</span>
    <span class="c1">// For demonstration purposes, let's print a message.</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"HRTimer callback executed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">HRTIMER_RESTART</span><span class="p">;</span>
<span class="p">}</span>
     
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initialize the HRTimer</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="n">ktime_set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// Set interval to 1 second</span>
    <span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
    <span class="n">my_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">my_timer_callback</span><span class="p">;</span>
     
    <span class="c1">// Start the timer</span>
    <span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_timer</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
     
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"HRTimer module initialized</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
     
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Cleanup: Stop the timer</span>
    <span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_timer</span><span class="p">);</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"HRTimer module removed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
     
<span class="n">module_init</span><span class="p">(</span><span class="n">my_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_module_exit</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
      <li>åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ªç›¸å¯¹æ—¶é—´çš„ HRTimerï¼Œè®¾ç½®äº†å›è°ƒå‡½æ•° <code class="language-plaintext highlighter-rouge">my_timer_callback</code>ï¼Œå¹¶å¯åŠ¨äº†å®šæ—¶å™¨ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="å†…æ ¸çº¿ç¨‹">å†…æ ¸çº¿ç¨‹</h1>

<p><strong>kthread_create_worker()</strong> å‡½æ•°æ˜¯Linuxå†…æ ¸ä¸­ç”¨äºåˆ›å»ºå†…æ ¸çº¿ç¨‹çš„ä¸€ä¸ªå‡½æ•°ã€‚é€šè¿‡è®¾ç½®æ ‡å¿—å‚æ•°å’Œæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯ä»¥æŒ‡å®šåˆ›å»ºå†…æ ¸çº¿ç¨‹çš„è¡Œä¸ºå’Œåç§°ã€‚å®ƒåˆ†é…å¹¶åˆå§‹åŒ–äº†ä¸€ä¸ªkthread_workerç»“æ„ä½“ï¼Œå¹¶ä½¿ç”¨å®ƒæ¥åˆ›å»ºå†…æ ¸çº¿ç¨‹.</p>

<p>ä»¥ä¸‹æ˜¯kthread_create_workerå‡½æ•°çš„ä¸€äº›å…³é”®å‚æ•°ï¼š</p>

<ul>
  <li>cpu: å¦‚æœå¤§äºç­‰äº0ï¼Œå°†åˆ›å»ºç‰¹å®šäºæŸä¸ªCPUçš„å·¥ä½œçº¿ç¨‹ï¼›å¦‚æœä¸æƒ³åˆ›å»ºç‰¹å®šäºCPUçš„å·¥ä½œçº¿ç¨‹ï¼Œå¯ä»¥å°†CPUåŸŸèµ‹å€¼ä¸º-1ã€‚</li>
  <li>flags: å¯ä»¥è®¾ç½®ä¸€äº›æ ‡å¿—ä½ï¼Œæ ¹æ®éœ€è¦æ¥æ§åˆ¶å†…æ ¸çº¿ç¨‹çš„è¡Œä¸ºã€‚</li>
  <li>namefmt: ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç”¨äºæŒ‡å®šå†…æ ¸çº¿ç¨‹çš„åç§°ã€‚</li>
</ul>

<p>è¿™ä¸ªå‡½æ•°ä¼šåˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–kthread_workerç»“æ„ï¼Œç„¶åè¿”å›æŒ‡å‘è¯¥ç»“æ„çš„æŒ‡é’ˆã€‚æ‚¨å¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ¥åˆ›å»ºå’Œç®¡ç†å†…æ ¸çº¿ç¨‹ã€‚</p>

<p>å¦‚æœæ‚¨éœ€è¦ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨æ¨¡å—åˆå§‹åŒ–æ—¶åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œä»¥åŠå¦‚ä½•åœ¨å¸è½½æ¨¡å—æ—¶å…³é—­è¯¥å†…æ ¸çº¿ç¨‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kthread.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/delay.h&gt;</span><span class="cp">
</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">demo_thr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"Thread is running...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">thr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kthread_demo_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">thr</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">demo_thr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"kthread-demo"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">"Failed to create kthread</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kthread_demo_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">thr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kthread_stop</span><span class="p">(</span><span class="n">thr</span><span class="p">);</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">kthread_demo_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">kthread_demo_exit</span><span class="p">);</span>
</code></pre></div></div>
<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨kthread_runå‡½æ•°åˆ›å»ºä¸€ä¸ªåä¸ºkthread-demoçš„å†…æ ¸çº¿ç¨‹ï¼Œå®ƒæ¯éš”2ç§’æ‰“å°ä¸€æ¡ä¿¡æ¯ã€‚åœ¨å¸è½½æ¨¡å—æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨kthread_stopæ¥å…³é—­è¯¥å†…æ ¸çº¿ç¨‹ã€‚</p>

<h1 id="å·¥ä½œé˜Ÿåˆ—">å·¥ä½œé˜Ÿåˆ—</h1>

<h2 id="schedule_work">schedule_work</h2>

<p>å‡½æ•°æ˜¯Linuxå†…æ ¸ä¸­çš„ä¸€ä¸ªé‡è¦å‡½æ•°ï¼Œç”¨äºå°†ä¸€ä¸ªå·¥ä½œé¡¹ï¼ˆworkï¼‰æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ï¼ˆworkqueueï¼‰ä¸­ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨åå°æ‰§è¡Œä¸€äº›å»¶è¿Ÿè¾ƒé•¿çš„ä»»åŠ¡ï¼Œè€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹çš„æ‰§è¡Œã€‚</p>

<p>ä»¥ä¸‹æ˜¯å…³äºschedule_workå‡½æ•°çš„ä¸€äº›è¦ç‚¹ï¼š</p>

<ul>
  <li>åŠŸèƒ½ï¼šå°†å·¥ä½œé¡¹æ·»åŠ åˆ°<strong>é»˜è®¤çš„å·¥ä½œé˜Ÿåˆ—</strong>ï¼ˆé€šå¸¸æ˜¯system_wqï¼‰ä¸­ï¼Œä»¥ä¾¿ç¨åæ‰§è¡Œã€‚</li>
  <li>è°ƒç”¨æ–¹å¼ï¼šschedule_work(&amp;my_work);ï¼Œå…¶ä¸­my_workæ˜¯ä¸€ä¸ªå·²ç»åˆå§‹åŒ–çš„å·¥ä½œé¡¹ã€‚</li>
  <li>å·¥ä½œé˜Ÿåˆ—ï¼šå·¥ä½œé˜Ÿåˆ—æ˜¯ä¸€ç§å¼‚æ­¥æ‰§è¡Œæœºåˆ¶ï¼Œç”¨äºå¤„ç†å»¶è¿Ÿçš„æˆ–éå®æ—¶çš„ä»»åŠ¡ã€‚</li>
  <li>å»¶è¿Ÿæ‰§è¡Œï¼šschedule_workä¼šå°†å·¥ä½œé¡¹æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…ç³»ç»Ÿè°ƒåº¦æ‰§è¡Œã€‚è¿™æ ·ï¼Œä¸»çº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸å¿…ç­‰å¾…å·¥ä½œé¡¹å®Œæˆã€‚</li>
  <li>å·¥ä½œé¡¹å›è°ƒå‡½æ•°ï¼šå·¥ä½œé¡¹çš„å®é™…æ‰§è¡Œé€»è¾‘ç”±å›è°ƒå‡½æ•°å®šä¹‰ã€‚å½“å·¥ä½œé¡¹è¢«è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒå‡½æ•°ã€‚</li>
</ul>

<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨INIT_WORKå’Œschedule_workæ¥åˆ›å»ºå’Œè°ƒåº¦ä¸€ä¸ªå·¥ä½œé¡¹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kernel.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/workqueue.h&gt;</span><span class="cp">
</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">work_struct</span> <span class="n">my_work</span><span class="p">;</span>

<span class="c1">// å·¥ä½œé¡¹çš„å›è°ƒå‡½æ•°</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">my_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"My work handler is running...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">// åœ¨è¿™é‡Œæ‰§è¡Œæ‚¨çš„å·¥ä½œé€»è¾‘</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_my_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"Initializing my kernel module with workqueue...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// åˆå§‹åŒ–å·¥ä½œé¡¹</span>
    <span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_work</span><span class="p">,</span> <span class="n">my_work_handler</span><span class="p">);</span>

    <span class="c1">// å°†å·¥ä½œé¡¹æ·»åŠ åˆ°å·¥ä½œé˜Ÿåˆ—</span>
    <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_work</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_my_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">"Cleaning up my kernel module...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_my_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cleanup_my_module</span><span class="p">);</span>
</code></pre></div></div>
<p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåä¸ºmy_workqueueçš„å·¥ä½œé˜Ÿåˆ—ç»“æ„ä½“ï¼Œä»¥åŠä¸€ä¸ªåä¸ºmy_workçš„å·¥ä½œé¡¹ã€‚ç„¶åï¼Œåœ¨init_my_moduleå‡½æ•°ä¸­ä½¿ç”¨create_singlethread_workqueueæ¥åˆ›å»ºä¸€ä¸ªåä¸ºmy_workqueueçš„å·¥ä½œé˜Ÿåˆ—ã€‚æ¥ç€ï¼Œæˆ‘ä»¬ä½¿ç”¨INIT_WORKæ¥åˆå§‹åŒ–å·¥ä½œé¡¹ï¼Œå¹¶ä½¿ç”¨schedule_workæ¥è°ƒåº¦å®ƒã€‚</p>

<h2 id="alloc_ordered_workqueue">alloc_ordered_workqueue</h2>

<p>ç”¨äºåˆ›å»º<strong>æœ‰åº</strong>çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆworkqueueï¼‰ã€‚è®©æˆ‘è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼Œå¹¶æä¾›ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">alloc_ordered_workqueue</code> ç®€ä»‹</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">alloc_ordered_workqueue</code> å‡½æ•°ç”¨äºåˆ†é…ä¸€ä¸ªæœ‰åºçš„å·¥ä½œé˜Ÿåˆ—ã€‚</li>
      <li>æœ‰åºå·¥ä½œé˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šç±»å‹çš„å·¥ä½œé˜Ÿåˆ—ï¼Œå®ƒç¡®ä¿å·¥ä½œé¡¹æŒ‰ç…§æäº¤çš„é¡ºåºæ‰§è¡Œã€‚</li>
    </ul>
  </li>
  <li><strong>å‡½æ•°ç­¾å</strong>ï¼š
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="nf">alloc_ordered_workqueue</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li><strong>å‚æ•°è¯´æ˜</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">name</code>ï¼šå·¥ä½œé˜Ÿåˆ—çš„åç§°ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">flags</code>ï¼šæ ‡å¿—ä½ï¼Œç”¨äºé…ç½®å·¥ä½œé˜Ÿåˆ—çš„è¡Œä¸ºã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>ç¤ºä¾‹ä»£ç </strong>ï¼š</p>

    <p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">alloc_ordered_workqueue</code> åˆ›å»ºä¸€ä¸ªæœ‰åºçš„å·¥ä½œé˜Ÿåˆ—ï¼š</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/workqueue.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">my_ordered_wq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">my_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"Work item executed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DECLARE_WORK</span><span class="p">(</span><span class="n">my_work</span><span class="p">,</span> <span class="n">my_work_handler</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">my_ordered_wq</span> <span class="o">=</span> <span class="n">alloc_ordered_workqueue</span><span class="p">(</span><span class="s">"my_ordered_wq"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_ordered_wq</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">"Failed to create ordered workqueue</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">queue_work</span><span class="p">(</span><span class="n">my_ordered_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_work</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">my_ordered_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">my_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_module_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"Ordered Workqueue Example"</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º â€œmy_ordered_wqâ€ çš„æœ‰åºå·¥ä½œé˜Ÿåˆ—ï¼Œå¹¶å°†ä¸€ä¸ªå·¥ä½œé¡¹ <code class="language-plaintext highlighter-rouge">my_work</code> æäº¤åˆ°é˜Ÿåˆ—ä¸­ã€‚å·¥ä½œé¡¹çš„å¤„ç†å‡½æ•° <code class="language-plaintext highlighter-rouge">my_work_handler</code> å°†åœ¨æœ‰åºçš„é¡ºåºä¸­æ‰§è¡Œã€‚</p>
  </li>
</ol>

<h2 id="create_singlethread_workqueue">create_singlethread_workqueue</h2>

<p><code class="language-plaintext highlighter-rouge">create_singlethread_workqueue</code> æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªåªåŒ…å«å•ä¸ªå·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ï¼ˆworkqueueï¼‰ã€‚è®©æˆ‘è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼šğŸ™‚</p>

<ol>
  <li><strong><code class="language-plaintext highlighter-rouge">create_singlethread_workqueue</code> ç®€ä»‹</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">create_singlethread_workqueue</code> å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªåªåŒ…å«ä¸€ä¸ªå·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ã€‚</li>
      <li><strong>æ— è®ºç³»ç»Ÿä¸­æœ‰å¤šå°‘ä¸ª CPUï¼Œè¿™ä¸ªå·¥ä½œé˜Ÿåˆ—éƒ½åªä¼šæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹</strong>ã€‚</li>
    </ul>
  </li>
  <li><strong>å‡½æ•°ç­¾å</strong>ï¼š
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="nf">create_singlethread_workqueue</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li><strong>å‚æ•°è¯´æ˜</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">name</code>ï¼šå·¥ä½œé˜Ÿåˆ—çš„åç§°ã€‚</li>
    </ul>
  </li>
  <li><strong>å·¥ä½œåŸç†</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">create_singlethread_workqueue</code> åˆ›å»ºçš„å·¥ä½œé˜Ÿåˆ—åªæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</li>
      <li>æ‰€æœ‰æäº¤åˆ°è¿™ä¸ªå·¥ä½œé˜Ÿåˆ—çš„å·¥ä½œé¡¹éƒ½ä¼šç”±è¿™ä¸ªå•ä¸€çš„å·¥ä½œçº¿ç¨‹æŒ‰é¡ºåºæ‰§è¡Œã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>ç¤ºä¾‹ä»£ç </strong>ï¼š
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">create_singlethread_workqueue</code> åˆ›å»ºä¸€ä¸ªåªåŒ…å«å•ä¸ªå·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—ï¼š</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/workqueue.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">my_singlethread_wq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">my_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"Work item executed!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="nf">DECLARE_WORK</span><span class="p">(</span><span class="n">my_work</span><span class="p">,</span> <span class="n">my_work_handler</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">my_singlethread_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">"my_singlethread_wq"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_singlethread_wq</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pr_err</span><span class="p">(</span><span class="s">"Failed to create singlethread workqueue</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">queue_work</span><span class="p">(</span><span class="n">my_singlethread_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_work</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">my_singlethread_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">my_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_module_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">"Singlethread Workqueue Example"</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º â€œmy_singlethread_wqâ€ çš„å·¥ä½œé˜Ÿåˆ—ï¼Œå¹¶å°†ä¸€ä¸ªå·¥ä½œé¡¹ <code class="language-plaintext highlighter-rouge">my_work</code> æäº¤åˆ°é˜Ÿåˆ—ä¸­ã€‚è¿™ä¸ªå·¥ä½œé¡¹çš„å¤„ç†å‡½æ•° <code class="language-plaintext highlighter-rouge">my_work_handler</code> å°†åœ¨å•ä¸€çš„å·¥ä½œçº¿ç¨‹ä¸­æŒ‰é¡ºåºæ‰§è¡Œã€‚</p>
  </li>
</ol>

<h1 id="completion">completion</h1>

<p>init_completion() æ˜¯Linuxå†…æ ¸ä¸­ç”¨äºå®Œæˆäº‹ä»¶é€šçŸ¥æœºåˆ¶çš„ä¸€ä¸ªå‡½æ•°ï¼Œä¸»è¦ç”¨äºè¿›ç¨‹é—´æˆ–çº¿ç¨‹é—´çš„åŒæ­¥ã€‚è¿™ä¸ªå‡½æ•°åˆå§‹åŒ–ä¸€ä¸ª completion ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“ç”¨äºè¡¨ç¤ºæŸä¸ªäº‹ä»¶æ˜¯å¦å·²ç»å‘ç”Ÿã€‚åœ¨å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹ç¼–ç¨‹ä¸­ï¼Œæœ‰æ—¶éœ€è¦ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹å®ŒæˆæŸä¸ªä»»åŠ¡ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹ init_completion() å‡½æ•°çš„åŠŸèƒ½å’Œç”¨æ³•ï¼š</p>

<ul>
  <li>åˆå§‹åŒ–completionç»“æ„ä½“ï¼š
    <ul>
      <li>completion ç»“æ„ä½“ç”¨äºç»´æŠ¤â€œcompleteâ€çŠ¶æ€ï¼Œè¡¨ç¤ºæŸä¸ªä»»åŠ¡æ˜¯å¦å·²å®Œæˆã€‚</li>
      <li>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">completion</span> <span class="p">{</span>
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">swait_queue_head</span> <span class="n">wait</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>        </div>
      </li>
      <li>done å­—æ®µè¡¨ç¤ºå®ŒæˆçŠ¶æ€ï¼Œåˆå§‹å€¼ä¸º 0ã€‚</li>
      <li>swait_queue_head æ˜¯ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å¤´ï¼Œç”¨äºç®¡ç†ç­‰å¾…è¯¥å®Œæˆäº‹ä»¶çš„çº¿ç¨‹ã€‚</li>
    </ul>
  </li>
  <li>init_completion() å‡½æ•°ï¼š
    <ul>
      <li>åŠ¨æ€å®šä¹‰åŠåˆå§‹åŒ–ä¸€ä¸ªä¿¡å·é‡ï¼š
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define init_completion(x) __init_completion(x)
</span><span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__init_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">x</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">init_swait_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>è¿™ä¸ªå‡½æ•°å®é™…ä¸Šæ˜¯åˆå§‹åŒ–äº† completion ç»“æ„ä½“ä¸­çš„ä¿¡å·é‡ã€‚</li>
    </ul>
  </li>
  <li>ç­‰å¾…å®Œæˆï¼š
    <ul>
      <li>ç­‰å¾…ä¿¡å·é‡çš„é‡Šæ”¾ï¼š
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">__sched</span> <span class="nf">wait_for_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wait_for_common</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">MAX_SCHEDULE_TIMEOUT</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>å‘ä¿¡ç«¯ï¼š</p>

    <ul>
      <li>complete() å‡½æ•°ç”¨äºå”¤é†’ç­‰å¾…è¯¥å®Œæˆäº‹ä»¶çš„å•ä¸ªçº¿ç¨‹ï¼š
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">!=</span> <span class="n">UINT_MAX</span><span class="p">)</span>
       <span class="n">x</span><span class="o">-&gt;</span><span class="n">done</span><span class="o">++</span><span class="p">;</span>
    <span class="n">swake_up_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
    <span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>åŒæ—¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼š
    <ul>
      <li>complete_all() å‡½æ•°ç”¨äºå”¤é†’ç­‰å¾…æ­¤ç‰¹å®šå®Œæˆäº‹ä»¶çš„æ‰€æœ‰çº¿ç¨‹ï¼š
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">complete_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">lockdep_assert_RT_in_threaded_ctx</span><span class="p">();</span>
    <span class="n">raw_spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">x</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
    <span class="n">swake_up_all_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
    <span class="n">raw_spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>å®Œæ•´ç¤ºä¾‹</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/completion.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/delay.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kthread.h&gt;</span><span class="cp">
</span><span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">"kevin"</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">completion</span> <span class="n">my_completion</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">my_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">){</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"My thread is waiting for completion...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_completion</span><span class="p">);</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"My thread woke up! Event completed.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_init</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"Initializing my module...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_completion</span><span class="p">);</span>
    <span class="c1">// Start a new kernel thread</span>
    <span class="n">kthread_run</span><span class="p">(</span><span class="n">my_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">"my_thread"</span><span class="p">);</span>
    <span class="c1">// Simulate some work...</span>
    <span class="n">msleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"Completing the event...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_completion</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
    <span class="n">pr_info</span><span class="p">(</span><span class="s">"Exiting my module...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">my_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_exit</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="kobject_uevent_env">kobject_uevent_env</h1>

<p>å®ƒæ˜¯ <strong>Linux å†…æ ¸</strong> ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåœ¨ <strong>kobject</strong> çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘é€ <strong>uevent</strong> åˆ°ç”¨æˆ·ç©ºé—´ã€‚è®©æˆ‘è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š</p>

<ol>
  <li><strong>kobject</strong>ï¼š
    <ul>
      <li><strong>kobject</strong> æ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªæŠ½è±¡å¯¹è±¡ï¼Œç”¨äºè¡¨ç¤ºå„ç§å†…æ ¸æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚è®¾å¤‡ã€é©±åŠ¨ç¨‹åºã€æ€»çº¿ç­‰ã€‚</li>
      <li>æ¯ä¸ª <strong>kobject</strong> éƒ½æœ‰ä¸€ä¸ªåç§°ã€å¼•ç”¨è®¡æ•°å’Œå…¶ä»–å±æ€§ã€‚</li>
    </ul>
  </li>
  <li><strong>uevent</strong>ï¼š
    <ul>
      <li><strong>uevent</strong> æ˜¯ç”¨æˆ·ç©ºé—´äº‹ä»¶çš„ç¼©å†™ï¼Œç”¨äºé€šçŸ¥ç”¨æˆ·ç©ºé—´ç¨‹åºå†…æ ¸ä¸­çš„çŠ¶æ€å˜åŒ–ã€‚</li>
      <li>ä¾‹å¦‚ï¼Œå½“è®¾å¤‡æ’å…¥æˆ–ç§»é™¤æ—¶ï¼Œå†…æ ¸ä¼šç”Ÿæˆç›¸åº”çš„ <strong>uevent</strong>ã€‚</li>
    </ul>
  </li>
  <li><strong><code class="language-plaintext highlighter-rouge">kobject_uevent_env</code> å‡½æ•°</strong>ï¼š
    <ul>
      <li>è¿™ä¸ªå‡½æ•°ç”¨äºå‘é€ <strong>uevent</strong> åˆ°ç”¨æˆ·ç©ºé—´ã€‚</li>
      <li>å®ƒæ¥å—ä¸€ä¸ªæŒ‡å‘ <strong>kobject</strong> çš„æŒ‡é’ˆå’Œä¸€ä¸ªè¡¨ç¤º <strong>uevent</strong> çš„ç¯å¢ƒå˜é‡æ•°ç»„ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥ç›‘å¬è¿™äº›äº‹ä»¶å¹¶åšå‡ºç›¸åº”çš„å¤„ç†ã€‚</li>
    </ul>
  </li>
  <li><strong>ä½¿ç”¨ç¤ºä¾‹</strong>ï¼š
    <ul>
      <li>åœ¨è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­ï¼Œå½“è®¾å¤‡çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¾‹å¦‚è®¾å¤‡æ’å…¥æˆ–ç§»é™¤ï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">kobject_uevent_env</code> å‘é€ç›¸åº”çš„ <strong>uevent</strong>ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºæ”¶åˆ°è¿™äº›äº‹ä»¶åï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ‰§è¡Œæ“ä½œã€‚</li>
    </ul>
  </li>
</ol>

<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨å†…æ ¸æ¨¡å—ä¸­ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">kobject_uevent_env</code> å‘é€ <strong>uevent</strong>ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;linux/module.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/init.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;linux/kobject.h&gt;</span><span class="cp">
</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">my_kobj</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">my_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">kset</span> <span class="o">*</span><span class="n">kset</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Add custom environment variables to the uevent</span>
    <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"MY_CUSTOM_VAR=hello_world"</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kset_uevent_ops</span> <span class="n">my_uevent_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">uevent</span> <span class="o">=</span> <span class="n">my_uevent</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">my_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">my_kobj</span> <span class="o">=</span> <span class="n">kobject_create_and_add</span><span class="p">(</span><span class="s">"my_kobject"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_kobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">my_kobj</span><span class="o">-&gt;</span><span class="n">kset</span> <span class="o">=</span> <span class="n">kset_create_and_add</span><span class="p">(</span><span class="s">"my_kset"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">my_kobj</span><span class="o">-&gt;</span><span class="n">kset</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">kobject_put</span><span class="p">(</span><span class="n">my_kobj</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">my_kobj</span><span class="o">-&gt;</span><span class="n">kset</span><span class="o">-&gt;</span><span class="n">uevent_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_uevent_ops</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">my_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">kset_unregister</span><span class="p">(</span><span class="n">my_kobj</span><span class="o">-&gt;</span><span class="n">kset</span><span class="p">);</span>
    <span class="n">kobject_put</span><span class="p">(</span><span class="n">my_kobj</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">my_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">my_module_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">"GPL"</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º <code class="language-plaintext highlighter-rouge">my_kobject</code> çš„ <strong>kobject</strong>ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°ä¸€ä¸ªåä¸º <code class="language-plaintext highlighter-rouge">my_kset</code> çš„ <strong>kset</strong> ä¸­ã€‚ç„¶åï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„ <strong>uevent</strong>ï¼Œå°†ç¯å¢ƒå˜é‡ <code class="language-plaintext highlighter-rouge">MY_CUSTOM_VAR</code> æ·»åŠ åˆ° <strong>uevent</strong> ä¸­ã€‚</p>

<p>è¯·æ³¨æ„ï¼Œå®é™…åº”ç”¨ä¸­ï¼Œæ‚¨éœ€è¦æ ¹æ®æ‚¨çš„éœ€æ±‚è‡ªå®šä¹‰æ›´å¤šçš„ç¯å¢ƒå˜é‡å’Œå¤„ç†é€»è¾‘ã€‚</p>

<h1 id="benchmark">benchmark</h1>

<ul>
  <li>
    <p>DRM kernel aspects (display and render):</p>

    <p>IGT GPU Tools (IGT): main DRM test suite, used for CI</p>

    <p><a href="https://gitlab.freedesktop.org/drm/igt-gpu-tools/">https://gitlab.freedesktop.org/drm/igt-gpu-tools/</a></p>
  </li>
  <li>
    <p>OpenGL aspects:</p>

    <ul>
      <li>
        <p>drawElements Quality Program (dEQP): OpenGL/OpenGL ES/Vulkan conformance tests</p>

        <p><a href="https://android.googlesource.com/platform/external/deqp/">https://android.googlesource.com/platform/external/deqp/</a></p>
      </li>
      <li>
        <p>glmark2: OpenGL 2.0 and ES 2.0 benchmark tool</p>

        <p><a href="https://github.com/glmark2/glmark2/">https://github.com/glmark2/glmark2/</a></p>
      </li>
    </ul>
  </li>
  <li>
    <p>Patch series continuous integration:</p>

    <p>EzBench: a collection of tools to benchmark graphics-related patch-series</p>

    <p><a href="https://github.com/freedesktop/ezbench/">https://github.com/freedesktop/ezbench/</a></p>
  </li>
  <li>
    <p>General benchmarking (including graphics):</p>

    <p>Phoronix Test Suite: automated benchmarking tool</p>

    <p><a href="https://github.com/phoronix-test-suite/phoronix-test-suite/">https://github.com/phoronix-test-suite/phoronix-test-suite/</a></p>
  </li>
</ul>]]></content><author><name>kevin</name></author><category term="Jekyll" /><summary type="html"><![CDATA[kref]]></summary></entry><entry><title type="html">ä½è¿ç®—</title><link href="http://localhost:4000/blog/jekyll/2022-04-27-bit.html" rel="alternate" type="text/html" title="ä½è¿ç®—" /><published>2022-04-27T00:00:00+08:00</published><updated>2022-04-27T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/bit</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2022-04-27-bit.html"><![CDATA[<h1 id="1ä½è¿ç®—æ¦‚è¿°">1.ä½è¿ç®—æ¦‚è¿°</h1>

<p>ä»ç°ä»£è®¡ç®—æœºä¸­æ‰€æœ‰çš„æ•°æ®äºŒè¿›åˆ¶çš„å½¢å¼å­˜å‚¨åœ¨è®¾å¤‡ä¸­ã€‚å³ 0ã€1 ä¸¤ç§çŠ¶æ€ï¼Œè®¡ç®—æœºå¯¹äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œçš„è¿ç®—(+ã€-ã€*ã€\/)éƒ½æ˜¯å«ä½è¿ç®—ï¼Œå³å°†ç¬¦å·ä½å…±åŒå‚ä¸è¿ç®—çš„è¿ç®—ã€‚</p>

<p>å£è¯´æ— å‡­ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥çœ‹ä¸‹ CPU æ˜¯å¦‚ä½•è¿›è¡Œè®¡ç®—çš„ï¼Œæ¯”å¦‚è¿™è¡Œä»£ç ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">47</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
</code></pre></div></div>
<p>è®¡ç®—ä¸¤ä¸ªæ•°çš„å’Œï¼Œå› ä¸ºåœ¨è®¡ç®—æœºä¸­éƒ½æ˜¯ä»¥äºŒè¿›åˆ¶æ¥è¿›è¡Œè¿ç®—ï¼Œæ‰€ä»¥ä¸Šé¢æˆ‘ä»¬æ‰€ç»™çš„ int å˜é‡ä¼šåœ¨æœºå™¨å†…éƒ¨å…ˆè½¬æ¢ä¸ºäºŒè¿›åˆ¶åœ¨è¿›è¡Œç›¸åŠ ï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>35:  0 0 1 0 0 0 1 1
47:  0 0 1 0 1 1 1 1
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
82:  0 1 0 1 0 0 1 0
</code></pre></div></div>

<p>æ‰€ä»¥ï¼Œç›¸æ¯”åœ¨ä»£ç ä¸­ç›´æ¥ä½¿ç”¨(<code class="language-plaintext highlighter-rouge">+ã€-ã€*ã€/ </code>)è¿ç®—ç¬¦ï¼Œåˆç†çš„è¿ç”¨ä½è¿ç®—æ›´èƒ½æ˜¾è‘—æé«˜ä»£ç åœ¨æœºå™¨ä¸Šçš„æ‰§è¡Œæ•ˆç‡ã€‚</p>

<h1 id="2ä½è¿ç®—æ¦‚è§ˆ">2.ä½è¿ç®—æ¦‚è§ˆ</h1>

<p>![[image-20230313173955848.png]]</p>

<h1 id="3ä¸è¿ç®—ç¬¦">3.ä¸è¿ç®—ç¬¦&amp;</h1>

<p>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€ä¸â€è¿ç®—ã€‚</p>

<h2 id="31-è¿ç®—è§„åˆ™">3.1 è¿ç®—è§„åˆ™ï¼š</h2>

<p><code class="language-plaintext highlighter-rouge">0&amp;0=0  0&amp;1=0  1&amp;0=0  1&amp;1=1</code></p>

<p>æ€»ç»“ï¼šä¸¤ä½åŒæ—¶ä¸º1ï¼Œç»“æœæ‰ä¸º1ï¼Œå¦åˆ™ç»“æœä¸º0ã€‚</p>

<p>ä¾‹å¦‚ï¼š3&amp;5 å³ 0000 0011&amp; 0000 0101 = 0000 0001ï¼Œå› æ­¤ 3&amp;5 çš„å€¼å¾—1ã€‚</p>

<p>æ³¨æ„ï¼šè´Ÿæ•°æŒ‰è¡¥ç å½¢å¼å‚åŠ æŒ‰ä½ä¸è¿ç®—ã€‚</p>

<h2 id="32-ä¸è¿ç®—ç¬¦ç”¨é€”">3.2 ä¸è¿ç®—ç¬¦ç”¨é€”</h2>

<h3 id="321æ¸…é›¶">3.2.1æ¸…é›¶</h3>

<p>å¦‚æœæƒ³å°†ä¸€ä¸ªå•å…ƒæ¸…é›¶ï¼Œå³ä½¿å…¶å…¨éƒ¨äºŒè¿›åˆ¶ä½ä¸º0ï¼Œåªè¦ä¸ä¸€ä¸ªå„ä½éƒ½ä¸ºé›¶çš„æ•°å€¼ç›¸ä¸ï¼Œç»“æœä¸ºé›¶ã€‚</p>

<h3 id="322å–ä¸€ä¸ªæ•°çš„æŒ‡å®šä½">3.2.2å–ä¸€ä¸ªæ•°çš„æŒ‡å®šä½</h3>

<p>æ¯”å¦‚å–æ•° X=1010 1110 çš„ä½4ä½ï¼Œåªéœ€è¦å¦æ‰¾ä¸€ä¸ªæ•°Yï¼Œä»¤Yçš„ä½4ä½ä¸º1ï¼Œå…¶ä½™ä½ä¸º0ï¼Œå³Y=0000 1111ï¼Œç„¶åå°†Xä¸Yè¿›è¡ŒæŒ‰ä½ä¸è¿ç®—ï¼ˆX&amp;Y=0000 1110ï¼‰å³å¯å¾—åˆ°Xçš„æŒ‡å®šä½ã€‚</p>

<h3 id="323åˆ¤æ–­å¥‡å¶">3.2.3åˆ¤æ–­å¥‡å¶</h3>

<p>åªè¦æ ¹æ®æœ€æœªä½æ˜¯0è¿˜æ˜¯1æ¥å†³å®šï¼Œä¸º0å°±æ˜¯å¶æ•°ï¼Œä¸º1å°±æ˜¯å¥‡æ•°ã€‚å› æ­¤å¯ä»¥ç”¨if ((a \&amp; 1) == 0)ä»£æ›¿if (a \% 2 == 0)æ¥åˆ¤æ–­aæ˜¯ä¸æ˜¯å¶æ•°ã€‚</p>

<h1 id="4-æˆ–è¿ç®—ç¬¦">4 æˆ–è¿ç®—ç¬¦|</h1>

<p>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€æˆ–â€è¿ç®—ã€‚</p>

<h2 id="41è¿ç®—è§„åˆ™">4.1è¿ç®—è§„åˆ™ï¼š</h2>

<table>
  <tbody>
    <tr>
      <td>0</td>
      <td>0=0  0</td>
      <td>1=1  1</td>
      <td>0=1  1</td>
      <td>1=1</td>
    </tr>
  </tbody>
</table>

<p>æ€»ç»“ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡åªè¦æœ‰ä¸€ä¸ªä¸º1ï¼Œå…¶å€¼ä¸º1ã€‚</p>

<table>
  <tbody>
    <tr>
      <td>ä¾‹å¦‚ï¼š3</td>
      <td>5å³ 0000 0011</td>
      <td>0000 0101 = 0000 0111ï¼Œå› æ­¤ï¼Œ3</td>
      <td>5çš„å€¼å¾—7ã€‚ã€€</td>
    </tr>
  </tbody>
</table>

<p>æ³¨æ„ï¼šè´Ÿæ•°æŒ‰è¡¥ç å½¢å¼å‚åŠ æŒ‰ä½æˆ–è¿ç®—ã€‚</p>

<h2 id="42æˆ–è¿ç®—çš„ç”¨é€”">4.2æˆ–è¿ç®—çš„ç”¨é€”ï¼š</h2>

<h3 id="421å¸¸ç”¨æ¥å¯¹ä¸€ä¸ªæ•°æ®çš„æŸäº›ä½è®¾ç½®ä¸º1">4.2.1å¸¸ç”¨æ¥å¯¹ä¸€ä¸ªæ•°æ®çš„æŸäº›ä½è®¾ç½®ä¸º1</h3>

<table>
  <tbody>
    <tr>
      <td>æ¯”å¦‚å°†æ•° X=1010 1110 çš„ä½4ä½è®¾ç½®ä¸º1ï¼Œåªéœ€è¦å¦æ‰¾ä¸€ä¸ªæ•°Yï¼Œä»¤Yçš„ä½4ä½ä¸º1ï¼Œå…¶ä½™ä½ä¸º0ï¼Œå³Y=0000 1111ï¼Œç„¶åå°†Xä¸Yè¿›è¡ŒæŒ‰ä½æˆ–è¿ç®—ï¼ˆX</td>
      <td>Y=1010 1111ï¼‰å³å¯å¾—åˆ°ã€‚</td>
    </tr>
  </tbody>
</table>

<h1 id="5å¼‚æˆ–è¿ç®—ç¬¦">5å¼‚æˆ–è¿ç®—ç¬¦^</h1>

<p>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶ä½è¿›è¡Œâ€å¼‚æˆ–â€è¿ç®—ã€‚</p>

<h2 id="51-è¿ç®—è§„åˆ™">5.1 è¿ç®—è§„åˆ™ï¼š</h2>

<p>0^0=0  0^1=1  1^0=1  1^1=0</p>

<p>æ€»ç»“ï¼šå‚åŠ è¿ç®—çš„ä¸¤ä¸ªå¯¹è±¡ï¼Œå¦‚æœä¸¤ä¸ªç›¸åº”ä½ç›¸åŒä¸º0ï¼Œç›¸å¼‚ä¸º1ã€‚</p>

<p>å¼‚æˆ–çš„å‡ æ¡æ€§è´¨:</p>

<ul>
  <li>1ã€äº¤æ¢å¾‹</li>
  <li>2ã€ç»“åˆå¾‹ (a^b)^c == a^(b^c)</li>
  <li>3ã€å¯¹äºä»»ä½•æ•°xï¼Œéƒ½æœ‰ x^x=0ï¼Œx^0=x</li>
  <li>4ã€è‡ªåæ€§: a^b^b=a^0=a;</li>
</ul>

<h2 id="52-å¼‚æˆ–è¿ç®—çš„ç”¨é€”">5.2 å¼‚æˆ–è¿ç®—çš„ç”¨é€”ï¼š</h2>

<h3 id="521ç¿»è½¬æŒ‡å®šä½">5.2.1ç¿»è½¬æŒ‡å®šä½</h3>

<p>æ¯”å¦‚å°†æ•° X=1010 1110 çš„ä½4ä½è¿›è¡Œç¿»è½¬ï¼Œåªéœ€è¦å¦æ‰¾ä¸€ä¸ªæ•°Yï¼Œä»¤Yçš„ä½4ä½ä¸º1ï¼Œå…¶ä½™ä½ä¸º0ï¼Œå³Y=0000 1111ï¼Œç„¶åå°†Xä¸Yè¿›è¡Œå¼‚æˆ–è¿ç®—ï¼ˆX^Y=1010 0001ï¼‰å³å¯å¾—åˆ°ã€‚</p>

<h3 id="522ä¸0ç›¸å¼‚æˆ–å€¼ä¸å˜">5.2.2ä¸0ç›¸å¼‚æˆ–å€¼ä¸å˜</h3>

<p>ä¾‹å¦‚ï¼š1010 1110 ^ 0000 0000 = 1010 1110</p>

<h3 id="523äº¤æ¢ä¸¤ä¸ªæ•°">5.2.3äº¤æ¢ä¸¤ä¸ªæ•°</h3>

<pre><code class="language-C">voidÂ Swap(intÂ &amp;a,Â intÂ &amp;b){  
Â  Â Â ifÂ (aÂ !=Â b){  
Â  Â  Â  Â  aÂ ^=Â b;  
Â  Â  Â  Â  bÂ ^=Â a;  
Â  Â  Â  Â  aÂ ^=Â b;  
Â  Â Â }  
}  
</code></pre>

<h1 id="6å–åè¿ç®—ç¬¦">6å–åè¿ç®—ç¬¦~</h1>

<p>å®šä¹‰ï¼šå‚åŠ è¿ç®—çš„ä¸€ä¸ªæ•°æ®ï¼ŒæŒ‰äºŒè¿›åˆ¶è¿›è¡Œâ€å–åâ€è¿ç®—ã€‚</p>

<h2 id="61-è¿ç®—è§„åˆ™">6.1 è¿ç®—è§„åˆ™ï¼šã€€</h2>

<p>~1=0
~0=1</p>

<p>æ€»ç»“ï¼šå¯¹ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æŒ‰ä½å–åï¼Œå³å°†0å˜1ï¼Œ1å˜0ã€‚</p>

<h2 id="62-å–åè¿ç®—ç¬¦çš„ç”¨é€”">6.2 å–åè¿ç®—ç¬¦çš„ç”¨é€”ï¼š</h2>

<h3 id="621ä½¿ä¸€ä¸ªæ•°çš„æœ€ä½ä½ä¸ºé›¶">6.2.1ä½¿ä¸€ä¸ªæ•°çš„æœ€ä½ä½ä¸ºé›¶</h3>

<p>ä½¿açš„æœ€ä½ä½ä¸º0ï¼Œå¯ä»¥è¡¨ç¤ºä¸ºï¼ša &amp; ~1ã€‚~1çš„å€¼ä¸º 1111 1111 1111 1110ï¼Œå†æŒ‰â€ä¸â€è¿ç®—ï¼Œæœ€ä½ä½ä¸€å®šä¸º0ã€‚å› ä¸ºâ€ ~â€è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§æ¯”ç®—æœ¯è¿ç®—ç¬¦ã€å…³ç³»è¿ç®—ç¬¦ã€é€»è¾‘è¿ç®—ç¬¦å’Œå…¶ä»–è¿ç®—ç¬¦éƒ½é«˜ã€‚</p>

<h1 id="7å·¦ç§»è¿ç®—ç¬¦">7.å·¦ç§»è¿ç®—ç¬¦Â«</h1>

<p>å®šä¹‰ï¼šå°†ä¸€ä¸ªè¿ç®—å¯¹è±¡çš„å„äºŒè¿›åˆ¶ä½å…¨éƒ¨å·¦ç§»è‹¥å¹²ä½ï¼ˆå·¦è¾¹çš„äºŒè¿›åˆ¶ä½ä¸¢å¼ƒï¼Œå³è¾¹è¡¥0ï¼‰ã€‚</p>

<p>è®¾ a=1010 1110ï¼Œa = aÂ«Â 2 å°†açš„äºŒè¿›åˆ¶ä½å·¦ç§»2ä½ã€å³è¡¥0ï¼Œå³å¾—a=1011 1000ã€‚</p>

<h2 id="71-1-å·¦ç§»-1ä½-ç›¸å½“äºä¹˜2">7.1 Â«1 å·¦ç§» 1ä½ ç›¸å½“äºä¹˜2</h2>
<p>è‹¥å·¦ç§»æ—¶èˆå¼ƒçš„é«˜ä½ä¸åŒ…å«1ï¼Œåˆ™æ¯å·¦ç§»ä¸€ä½ï¼Œç›¸å½“äºè¯¥æ•°ä¹˜ä»¥2ã€‚</p>

<h1 id="8å³ç§»è¿ç®—ç¬¦">8å³ç§»è¿ç®—ç¬¦Â»</h1>

<p>å®šä¹‰ï¼šå°†ä¸€ä¸ªæ•°çš„å„äºŒè¿›åˆ¶ä½å…¨éƒ¨å³ç§»è‹¥å¹²ä½ï¼Œæ­£æ•°å·¦è¡¥0ï¼Œè´Ÿæ•°å·¦è¡¥1ï¼Œå³è¾¹ä¸¢å¼ƒã€‚</p>

<p>ä¾‹å¦‚ï¼ša=aÂ»2 å°†açš„äºŒè¿›åˆ¶ä½å³ç§»2ä½ï¼Œå·¦è¡¥0 æˆ–è€… å·¦è¡¥1å¾—çœ‹è¢«ç§»æ•°æ˜¯æ­£è¿˜æ˜¯è´Ÿã€‚</p>

<h2 id="811-å³ç§»ä¸€ä½ç›¸å½“äºé™¤2">8.1Â Â»1 å³ç§»ä¸€ä½ç›¸å½“äºé™¤2</h2>
<p>æ“ä½œæ•°æ¯å³ç§»ä¸€ä½ï¼Œç›¸å½“äºè¯¥æ•°é™¤ä»¥2ã€‚</p>

<h1 id="9å¤åˆèµ‹å€¼è¿ç®—ç¬¦">9å¤åˆèµ‹å€¼è¿ç®—ç¬¦</h1>

<p>ä½è¿ç®—ç¬¦ä¸èµ‹å€¼è¿ç®—ç¬¦ç»“åˆï¼Œç»„æˆæ–°çš„å¤åˆèµ‹å€¼è¿ç®—ç¬¦ï¼Œå®ƒä»¬æ˜¯ï¼š</p>

<p>&amp;=        ä¾‹ï¼ša&amp;=b    ç›¸å½“äº     a=a&amp;b</p>

<table>
  <tbody>
    <tr>
      <td>=        ä¾‹ï¼ša</td>
      <td>=b    ç›¸å½“äº     a=a</td>
      <td>b</td>
    </tr>
  </tbody>
</table>

<p>&gt;&gt;=      ä¾‹ï¼šaÂ»=b   ç›¸å½“äº     a=aÂ»b</p>

<p>Â«=      ä¾‹ï¼šaÂ«=b     ç›¸å½“äº      a=aÂ«Â b</p>

<p>^=        ä¾‹ï¼ša^=b    ç›¸å½“äº   a=a^b</p>

<p>è¿ç®—è§„åˆ™ï¼šå’Œå‰é¢è®²çš„å¤åˆèµ‹å€¼è¿ç®—ç¬¦çš„è¿ç®—è§„åˆ™ç›¸ä¼¼ã€‚</p>

<p>ä¸åŒé•¿åº¦çš„æ•°æ®è¿›è¡Œä½è¿ç®—ï¼šå¦‚æœä¸¤ä¸ªä¸åŒé•¿åº¦çš„æ•°æ®è¿›è¡Œä½è¿ç®—æ—¶ï¼Œç³»ç»Ÿä¼šå°†äºŒè€…æŒ‰å³ç«¯å¯¹é½ï¼Œç„¶åè¿›è¡Œä½è¿ç®—ã€‚</p>

<p>ä»¥â€ä¸è¿ç®—â€ä¸ºä¾‹è¯´æ˜å¦‚ä¸‹ï¼šæˆ‘ä»¬çŸ¥é“åœ¨Cè¯­è¨€ä¸­longå‹å 4ä¸ªå­—èŠ‚ï¼Œintå‹å 2ä¸ªå­—èŠ‚ï¼Œå¦‚æœä¸€ä¸ªlongå‹æ•°æ®ä¸ä¸€ä¸ªintå‹æ•°æ®è¿›è¡Œâ€ä¸è¿ç®—â€ï¼Œå³ç«¯å¯¹é½åï¼Œå·¦è¾¹ä¸è¶³çš„ä½ä¾ä¸‹é¢ä¸‰ç§æƒ…å†µè¡¥è¶³ï¼Œ</p>

<ul>
  <li>1ï¼‰å¦‚æœæ•´å‹æ•°æ®ä¸ºæ­£æ•°ï¼Œå·¦è¾¹è¡¥16ä¸ª0ã€‚</li>
  <li>2ï¼‰å¦‚æœæ•´å‹æ•°æ®ä¸ºè´Ÿæ•°ï¼Œå·¦è¾¹è¡¥16ä¸ª1ã€‚</li>
  <li>3ï¼‰å¦‚æœæ•´å½¢æ•°æ®ä¸ºæ— ç¬¦å·æ•°ï¼Œå·¦è¾¹ä¹Ÿè¡¥16ä¸ª0ã€‚
å¦‚ï¼šlong a=123ï¼›int b=1ï¼›è®¡ç®—a&amp; bã€‚</li>
</ul>

<p>å¦‚ï¼šlong a=123ï¼›int b=-1ï¼›è®¡ç®—a&amp; bã€‚</p>

<p>å¦‚ï¼šlong a=123ï¼›unsigned intb=1ï¼›è®¡ç®—a &amp; bã€‚</p>]]></content><author><name>kevin_zh</name></author><category term="Jekyll" /><summary type="html"><![CDATA[1.ä½è¿ç®—æ¦‚è¿°]]></summary></entry><entry><title type="html">ffmpegå‘½ä»¤</title><link href="http://localhost:4000/blog/jekyll/2021-04-27-ffmpeg.html" rel="alternate" type="text/html" title="ffmpegå‘½ä»¤" /><published>2021-04-27T00:00:00+08:00</published><updated>2021-04-27T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/ffmpeg</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2021-04-27-ffmpeg.html"><![CDATA[<h3 id="01-è§†é¢‘åˆ†å‰²">01. è§†é¢‘åˆ†å‰²</h3>
<pre><code class="language-cobol">ffmpeg -ss 00:00:00 -i input.mp4 -c copy -t 60 output.mp4
</code></pre>
<p>-ss è¡¨ç¤ºè§†é¢‘åˆ†å‰²çš„èµ·å§‹æ—¶é—´ï¼Œ-t è¡¨ç¤ºåˆ†å‰²æ—¶é•¿ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç”¨ 00:01:00è¡¨ç¤º</p>

<p>==<em>æ³¨æ„</em>==Â ï¼š-ss è¦æ”¾åœ¨ -i ä¹‹å‰</p>

<h3 id="02-è§†é¢‘åŒºåŸŸè£å‰ª">02. è§†é¢‘åŒºåŸŸè£å‰ªï¼š</h3>
<pre><code class="language-cobol">ffmpeg -i 3.mkv -filter_complex crop=1024:50:0:550 -y 4.mkv  
</code></pre>
<h3 id="03-è§†é¢‘é¢„è§ˆ">03. è§†é¢‘é¢„è§ˆ</h3>
<p>ffplay 3.mkv -vf crop=1024:50:0:550</p>

<h3 id="04-è§†é¢‘æ”¾å¤§ç¼©å°">04. è§†é¢‘æ”¾å¤§,ç¼©å°</h3>
<pre><code class="language-cobol">ffmpeg  -i 2.mp4 -vf "scale=1280:64" 4.mp4
</code></pre>
<p>==scale== =w:h è¡¨ç¤ºæ”¾å¤§åçš„å¤§å°</p>

<h3 id="05-åˆ—å‡ºæ‰€æœ‰format">05. åˆ—å‡ºæ‰€æœ‰format</h3>
<p>// list all pix format</p>
<pre><code class="language-cobol">ffmpeg -pix_fmts 
</code></pre>
<h3 id="06-å›¾ç‰‡è½¬æ¢">06. å›¾ç‰‡è½¬æ¢</h3>
<pre><code class="language-cobol">ffmpeg -iÂ temp.jpgÂ -sÂ 1024x680Â -pix_fmtÂ yuvj420pÂ 9.yuv
ffmpeg.exe -i agf-dog-1280x960.jpg  -vf scale=1920:1080 agf-dog-1920x1080.jpg
</code></pre>
<h3 id="07-è§†é¢‘formatè½¬æ¢">07. è§†é¢‘formatè½¬æ¢</h3>

<p>YUV -&gt; RGB</p>

<pre><code class="language-cobol">ffmpeg -s 360x270 -pix_fmt yuv420p -i Â 2_test_360x270_50.yuv -pix_fmt rgb24 Â aaaa.rgb  
</code></pre>
<pre><code class="language-cobol">ffmpeg -s 640x480 -pix_fmt nv12 -i 640x480_1.jpg -vf scale=640:480,setsar=1:1 640x480_1_nv12.yuv -hide_banner  
</code></pre>
<h3 id="08-è§†é¢‘å åŠ ">08. è§†é¢‘å åŠ </h3>
<pre><code class="language-cobol"> ffmpeg -i input1 -i input2 -filter_complex overlay=x:yÂ output
</code></pre>
<h3 id="09-è§†é¢‘æ—‹è½¬">09. è§†é¢‘æ—‹è½¬</h3>

<p>//mp4å‘å·¦æ—‹è½¬90åº¦
 ffmpeg -i input.mp4 -metadata:s:v rotate=â€90â€ -codec copy outut.mp4</p>

<p>//mp4å‘å³æ—‹è½¬90åº¦
 ffmpeg -i input.mp4 -metadata:s:v rotate=â€-90â€ -codec copy outut.mp4</p>

<h3 id="10-è§†é¢‘é•œåƒ">10. è§†é¢‘é•œåƒ</h3>
<p>//mp4å·¦å³é•œåƒç¿»è½¬</p>
<pre><code class="language-cobol"> ffmpeg -i input.mp4 -vf "hflip" outut.mp4
</code></pre>
<p>//mp4ä¸Šä¸‹é•œåƒç¿»è½¬</p>
<pre><code class="language-cobol"> ffmpeg -i input.mp4 -vf "vflip" outut.mp4
</code></pre>

<h3 id="10-å›¾ç‰‡æ—‹è½¬">10. å›¾ç‰‡æ—‹è½¬</h3>
<p>//å›¾ç‰‡å‘å³æ—‹è½¬90åº¦</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf rotate='90*PI/180' -y rotate60.png
</code></pre>
<p>//å›¾ç‰‡å‘å³æ—‹è½¬90åº¦</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf rotate='-90*PI/180' -y rotate_90.png
</code></pre>
<p>//å›¾ç‰‡åƒå·¦æ—‹è½¬90åº¦</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf transpose=2 -y transpose2.png
</code></pre>
<p>//å›¾ç‰‡åƒå³æ—‹è½¬90åº¦</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf transpose=1 -y transpose2.png
</code></pre>
<p>//é€†æ—¶é’ˆ(å‘å·¦)æ—‹è½¬90Â°ï¼Œç„¶åå‚ç›´ï¼ˆä¸Šä¸‹ï¼‰ç¿»è½¬</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf transpose=0 -y transpose0.png
</code></pre>
<h3 id="11--å›¾ç‰‡é•œåƒ">11.  å›¾ç‰‡é•œåƒ</h3>
<p>//å›¾ç‰‡å·¦å³é•œåƒç¿»è½¬</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf hflip -y hflip.png
</code></pre>
<p>//å›¾ç‰‡ä¸Šä¸‹é•œåƒç¿»è½¬</p>
<pre><code class="language-cobol"> ffmpeg -i input.png -vf vflip -y vflip.png
</code></pre>
<p>//yuvæ•°æ®å·¦å³é•œåƒç¿»è½¬</p>
<pre><code class="language-cobol"> ffmpeg -s 1920x1080 -pix_fmt nv12 -i nv12_1.yuv -vf hflip -y hflip_nv12.yuv
</code></pre>
<p>//æ’­æ”¾å·¦å³ç¿»è½¬åçš„yuvæ•°æ®</p>
<pre><code class="language-cobol"> ffplay -video_size 1920x1080 -pixel_format nv12 hflip_nv12.yuv
</code></pre>

<h3 id="12-éŸ³é¢‘éŸ³é‡è°ƒèŠ‚å¤§å°">12. éŸ³é¢‘éŸ³é‡è°ƒèŠ‚å¤§å°</h3>
<p>//éŸ³é‡ç¿»å€ï¼Œå†™åœ¨æ»¤é•œé‡Œ</p>
<pre><code class="language-cobol"> ffmpeg -i input.wav -af volume=2 -y output.wav
</code></pre>
<p>//éŸ³é‡ç¿»å€ï¼Œä¸å†™åœ¨æ»¤é•œä¸­</p>
<pre><code class="language-cobol">ffmpeg -i input.wav -vol 2000 -y output.wav
</code></pre>
<h3 id="13-è°ƒèŠ‚æ’­æ”¾é€Ÿåº¦">13. è°ƒèŠ‚æ’­æ”¾é€Ÿåº¦</h3>

<pre><code class="language-cobol">ffmpeg -i test1.mp4 -vf  "setpts=0.25*PTS" test2.mp4
</code></pre>

<p>å››å€æ…¢é€Ÿï¼š</p>

<pre><code class="language-cobol">ffmpeg -i test1.mp4 -vf  "setpts=4*PTS" test2.mp4
</code></pre>]]></content><author><name>Tao He</name></author><category term="Jekyll" /><summary type="html"><![CDATA[01. è§†é¢‘åˆ†å‰² ffmpeg -ss 00:00:00 -i input.mp4 -c copy -t 60 output.mp4 -ss è¡¨ç¤ºè§†é¢‘åˆ†å‰²çš„èµ·å§‹æ—¶é—´ï¼Œ-t è¡¨ç¤ºåˆ†å‰²æ—¶é•¿ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ç”¨ 00:01:00è¡¨ç¤º]]></summary></entry><entry><title type="html">OpenGL Misc</title><link href="http://localhost:4000/blog/jekyll/2020-08-20-OpenGL_misc.html" rel="alternate" type="text/html" title="OpenGL Misc" /><published>2020-08-20T00:00:00+08:00</published><updated>2020-08-20T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/OpenGL_misc</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2020-08-20-OpenGL_misc.html"><![CDATA[<h1 id="glinvalidateframebuffer-vs-glclear">glInvalidateFramebuffer vs glClear</h1>

<p>glInvalidateFramebuffer å’Œ glClear æ˜¯OpenGLä¸­ä¸¤ä¸ªä¸åŒçš„å‡½æ•°ï¼Œå®ƒä»¬çš„ä½œç”¨å’Œç”¨æ³•æœ‰æ‰€ä¸åŒï¼š</p>

<ul>
  <li>glInvalidateFramebufferï¼š
    <ul>
      <li>åŠŸèƒ½ï¼šglInvalidateFramebuffer ç”¨äºæ˜¾å¼åœ°æ ‡è®°å¸§ç¼“å†²åŒºçš„æŸäº›éƒ¨åˆ†ä¸ºæ— æ•ˆã€‚è¿™æ ·ï¼ŒGPUå°±çŸ¥é“è¿™äº›éƒ¨åˆ†çš„å†…å®¹ä¸å†éœ€è¦ï¼Œå¯ä»¥é¿å…ä¸å¿…è¦çš„æ•°æ®äº¤æ¢ã€‚</li>
      <li>åº”ç”¨åœºæ™¯ï¼šé€šå¸¸åœ¨ä½¿ç”¨å¸§ç¼“å†²åŒºå¯¹è±¡ï¼ˆFBOï¼‰æ—¶ï¼Œå½“æˆ‘ä»¬åˆ‡æ¢åˆ°ä¸åŒçš„FBOæˆ–è€…ä¸å†éœ€è¦æŸäº›é¢œè‰²ã€æ·±åº¦æˆ–æ¨¡æ¿ç¼“å†²åŒºçš„å†…å®¹æ—¶ï¼Œå¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ã€‚</li>
      <li>æ€§èƒ½å½±å“ï¼šå°½ç®¡åœ¨RenderDocç­‰å·¥å…·ä¸­å¯èƒ½æ˜¾ç¤ºglInvalidateFramebufferçš„è€—æ—¶è¾ƒé«˜ï¼Œä½†å®é™…ä¸Šï¼Œåªæœ‰å°‘æ•°å‡ æ¬¡è°ƒç”¨ä¸ä¼šå¯¹æ¸²æŸ“æ€§èƒ½äº§ç”Ÿå½±å“ã€‚</li>
    </ul>
  </li>
  <li>glClearï¼š
    <ul>
      <li>åŠŸèƒ½ï¼šglClear ç”¨äºæ¸…é™¤å½“å‰å¸§ç¼“å†²åŒºçš„å†…å®¹ï¼ŒåŒ…æ‹¬é¢œè‰²ç¼“å†²åŒºã€æ·±åº¦ç¼“å†²åŒºå’Œæ¨¡æ¿ç¼“å†²åŒºã€‚</li>
      <li>åº”ç”¨åœºæ™¯ï¼šåœ¨æ¯ä¸€å¸§å¼€å§‹æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šè°ƒç”¨glClearæ¥å‡†å¤‡å¸§ç¼“å†²åŒºï¼Œä»¥ä¾¿è¿›è¡Œæ–°çš„ç»˜åˆ¶ã€‚</li>
      <li>æ€§èƒ½å½±å“ï¼šglClearçš„æ€§èƒ½å¼€é”€é€šå¸¸è¾ƒå°ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœé¢‘ç¹è°ƒç”¨ï¼Œå¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚</li>
    </ul>
  </li>
</ul>

<p>æ€»ç»“ï¼š</p>
<ul>
  <li>glInvalidateFramebuffer ç”¨äºæ ‡è®°å¸§ç¼“å†²åŒºçš„éƒ¨åˆ†å†…å®¹ä¸ºæ— æ•ˆï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„æ•°æ®äº¤æ¢ã€‚</li>
  <li>glClear ç”¨äºæ¸…é™¤æ•´ä¸ªå¸§ç¼“å†²åŒºçš„å†…å®¹ï¼Œä»¥å‡†å¤‡è¿›è¡Œæ–°çš„ç»˜åˆ¶ã€‚</li>
  <li>åœ¨ä½¿ç”¨RenderDocç­‰å·¥å…·æ—¶ï¼Œå¯ä»¥å¿½ç•¥glInvalidateFramebufferçš„è€—æ—¶ï¼Œä½†éœ€è¦å…³æ³¨ç‰‡ä¸Šé«˜é€Ÿç¼“å­˜å›å†™å†…å­˜çš„æ¶ˆè€—  ã€‚</li>
</ul>

<h1 id="gldiscardframebufferext">glDiscardFramebufferEXT</h1>

<p><code class="language-plaintext highlighter-rouge">void glDiscardFramebufferEXT(enum target, sizei numAttachments, const enum *attachments);</code></p>

<p>è¿™ä¸ªæ‰©å±•æä¾›äº†ä¸€ä¸ªæ–°çš„å‘½ä»¤ï¼ŒglDiscardFramebufferEXTï¼Œå®ƒä¼šä½¿å¾—æŒ‡å®šå¸§ç¼“å†²é™„ä»¶çš„å†…å®¹å˜ä¸ºæœªå®šä¹‰çŠ¶æ€ã€‚åœ¨æœªæ¥çš„æ“ä½œä¿®æ”¹å†…å®¹ä¹‹å‰ï¼Œè¿™äº›æŒ‡å®šç¼“å†²åŒºçš„å†…å®¹æ˜¯æœªå®šä¹‰çš„ï¼Œåªæœ‰è¢«ä¿®æ”¹çš„åŒºåŸŸä¿è¯åŒ…å«æœ‰æ•ˆå†…å®¹ã€‚æœ‰æ•ˆåœ°ä½¿ç”¨æ­¤å‘½ä»¤å¯ä»¥ä¸ºå®ç°æä¾›æ–°çš„ä¼˜åŒ–æœºä¼šã€‚
ä¸€äº› OpenGL ES å®ç°ä¼šå°†å¸§ç¼“å†²å›¾åƒç¼“å­˜åˆ°ä¸€ä¸ªå°çš„å¿«é€Ÿå†…å­˜æ± ä¸­ã€‚åœ¨æ¸²æŸ“ä¹‹å‰ï¼Œè¿™äº›å®ç°å¿…é¡»å°†é€»è¾‘ç¼“å†²åŒºï¼ˆå¦‚é¢œè‰²ã€æ·±åº¦ã€æ¨¡æ¿ç­‰ï¼‰çš„ç°æœ‰å†…å®¹åŠ è½½åˆ°è¯¥å†…å­˜ä¸­ã€‚æ¸²æŸ“åï¼Œè¿™äº›ç¼“å†²åŒºä¸­çš„ä¸€éƒ¨åˆ†æˆ–å…¨éƒ¨ä¹Ÿä¼šè¢«å­˜å‚¨å›å¤–éƒ¨å†…å­˜ï¼Œä»¥ä¾¿å°†æ¥å†æ¬¡ä½¿ç”¨å…¶å†…å®¹ã€‚åœ¨è®¸å¤šåº”ç”¨ç¨‹åºä¸­ï¼Œé€»è¾‘ç¼“å†²åŒºåœ¨æ¸²æŸ“å¼€å§‹æ—¶è¢«æ¸…é™¤ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼ŒåŠ è½½æˆ–å­˜å‚¨è¿™äº›ç¼“å†²åŒºçš„å·¥ä½œå°±æ˜¯æµªè´¹çš„ã€‚
å³ä½¿æ²¡æœ‰è¿™ä¸ªæ‰©å±•ï¼Œå¦‚æœæ¸²æŸ“çš„ä¸€å¸§ä»å…¨å±æ¸…é™¤å¼€å§‹ï¼ŒOpenGL ES å®ç°ä¹Ÿå¯ä»¥ä¼˜åŒ–æ‰åœ¨æ¸²æŸ“å¸§ä¹‹å‰åŠ è½½å¸§ç¼“å†²åŒºå†…å®¹çš„æ­¥éª¤ã€‚æœ‰äº†è¿™ä¸ªæ‰©å±•ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ DiscardFramebufferEXT æ¥è¡¨ç¤ºå¸§ç¼“å†²åŒºçš„å†…å®¹å°†ä¸å†éœ€è¦ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒOpenGL ES å®ç°ä¹Ÿå¯ä»¥ä¼˜åŒ–æ‰åœ¨æ¸²æŸ“å¸§åå­˜å‚¨å¸§ç¼“å†²åŒºå†…å®¹çš„æ­¥éª¤ã€‚</p>

<p>glDiscardFramebufferEXTçš„å·¥ä½œæ˜¯å‘ŠçŸ¥é©±åŠ¨ç¨‹åºä½ ä¸å…³å¿ƒframebufferçš„å†…å®¹ã€‚ä»€ä¹ˆé©±åŠ¨ç¨‹åº(æˆ–GPU)å†³å®šç”¨å®ƒåšä»€ä¹ˆ - è¿™ä¸å–å†³äºä½ ã€‚é©±åŠ¨ç¨‹åºå¯ä»¥å°†æ‰€æœ‰å†…å®¹é‡ç½®ä¸º0ï¼Œæˆ–è€…å®ƒå¯ä»¥ä¿æŒåŸæ ·ï¼Œæˆ–è€…å½“æ‚¨ä¸‹æ¬¡è°ƒç”¨glClearæ—¶å®ƒå°†ä½¿ç”¨æ­¤ä¿¡æ¯å¹¶ä¸”å°†æ›´æœ‰æ•ˆåœ°æ‰§è¡Œå®ƒ(ä¾‹å¦‚é€šè¿‡ä¸ºå†…å®¹åˆ†é…æ–°å†…å­˜ï¼Œè€Œä¸æ˜¯æ‰§è¡Œmemsetä¸0å€¼)ã€‚ä¸è¦æ‹…å¿ƒå®ƒä¼šåšä»€ä¹ˆ</p>

<h1 id="texture-objä¸rboçš„åŒºåˆ«">Texture objä¸RBOçš„åŒºåˆ«</h1>

<p>FBO(Frame Buffer Object)å³å¸§ç¼“å†²åŒºå¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå¯æ·»åŠ ç¼“å†²åŒºçš„å®¹å™¨ï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ çº¹ç†æˆ–æ¸²æŸ“ç¼“å†²åŒºå¯¹è±¡ï¼ˆRBO),å®ƒä»¬çš„åŒºåˆ«å¦‚ä¸‹å›¾</p>

<p><img src="/blog/assets/OpenGL/renderbuffer.png" alt="renderbuffer" /></p>

<h1 id="shader">shader</h1>

<h2 id="åˆå§‹åŒ–">åˆå§‹åŒ–</h2>
<p><img src="/blog/assets/OpenGL/shader.png" alt="shader" /></p>

<h2 id="å˜é‡">å˜é‡</h2>

<p><strong>uniformå˜é‡</strong></p>

<p>uniformå˜é‡æ˜¯å¤–éƒ¨applicationç¨‹åºä¼ é€’ç»™ï¼ˆvertexå’Œfragmentï¼‰shaderçš„å˜é‡ã€‚å› æ­¤å®ƒæ˜¯applicationé€šè¿‡å‡½æ•°glUniform**ï¼ˆï¼‰å‡½æ•°èµ‹å€¼çš„ã€‚åœ¨ï¼ˆvertexå’Œfragmentï¼‰shaderç¨‹åºå†…éƒ¨ï¼Œuniformå˜é‡å°±åƒæ˜¯Cè¯­è¨€é‡Œé¢çš„å¸¸é‡ï¼ˆconst ï¼‰ï¼Œå®ƒä¸èƒ½è¢«shaderç¨‹åºä¿®æ”¹ã€‚</p>

<p><strong>attributeå˜é‡</strong></p>

<p>attributeå˜é‡æ˜¯åªèƒ½åœ¨vertex shaderä¸­ä½¿ç”¨çš„å˜é‡ã€‚å®ƒä¸èƒ½åœ¨fragment shaderä¸­å£°æ˜attributeå˜é‡ï¼Œä¹Ÿä¸èƒ½è¢«fragment shaderä¸­ä½¿ç”¨ã€‚ä¸€èˆ¬ç”¨attributeå˜é‡æ¥è¡¨ç¤ºä¸€äº›é¡¶ç‚¹çš„æ•°æ®ï¼Œå¦‚ï¼šé¡¶ç‚¹åæ ‡ï¼Œæ³•çº¿ï¼Œçº¹ç†åæ ‡ï¼Œé¡¶ç‚¹é¢œè‰²ç­‰ã€‚åœ¨applicationä¸­ï¼Œä¸€èˆ¬ç”¨å‡½æ•°glBindAttribLocationï¼ˆï¼‰æ¥ç»‘å®šæ¯ä¸ªattributeå˜é‡çš„ä½ç½®ï¼Œç„¶åç”¨å‡½æ•°glVertexAttribPointerï¼ˆï¼‰ä¸ºæ¯ä¸ªattributeå˜é‡èµ‹å€¼ã€‚</p>

<p><strong>varyingå˜é‡</strong></p>

<p>varyingå˜é‡æ˜¯vertexå’Œfragment shaderä¹‹é—´åšæ•°æ®ä¼ é€’ç”¨çš„ã€‚ä¸€èˆ¬vertex shaderä¿®æ”¹varyingå˜é‡çš„å€¼ï¼Œç„¶åfragment shaderä½¿ç”¨è¯¥varyingå˜é‡çš„å€¼ã€‚å› æ­¤varyingå˜é‡åœ¨vertexå’Œfragment shaderäºŒè€…ä¹‹é—´çš„å£°æ˜å¿…é¡»æ˜¯ä¸€è‡´çš„ã€‚applicationä¸èƒ½ä½¿ç”¨æ­¤å˜é‡ã€‚</p>]]></content><author><name>kevin</name></author><category term="Jekyll" /><summary type="html"><![CDATA[glInvalidateFramebuffer vs glClear]]></summary></entry><entry><title type="html">Wayland Misc</title><link href="http://localhost:4000/blog/jekyll/2019-08-10-Wayland-Misc.html" rel="alternate" type="text/html" title="Wayland Misc" /><published>2019-08-10T00:00:00+08:00</published><updated>2019-08-10T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/Wayland-Misc</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2019-08-10-Wayland-Misc.html"><![CDATA[<h1 id="expat">Expat</h1>

<p><strong>Expat</strong> æ˜¯ä¸€ä¸ªç”¨ <strong>C</strong> ç¼–å†™çš„æµå¼ <strong>XML è§£æåº“</strong>ã€‚å®ƒåœ¨å¤„ç†æ–‡ä»¶å¤§å°è¶…å‡ºå†…å­˜é™åˆ¶ä¸”æ€§èƒ½å’Œçµæ´»æ€§è‡³å…³é‡è¦çš„æƒ…å†µä¸‹è¡¨ç°å‡ºè‰²ã€‚è®¸å¤šåº”ç”¨ç¨‹åºã€åº“å’Œç¡¬ä»¶éƒ½ä½¿ç”¨äº† <strong>Expat</strong>ï¼Œå¹¶ä¸”è¿˜æœ‰ä¸€äº›ç»‘å®šå’Œç¬¬ä¸‰æ–¹å°è£…ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å…³äº <strong>Expat</strong> çš„ä¸€äº›é‡è¦ä¿¡æ¯ï¼š</p>

<ul>
  <li><strong>ä»€ä¹ˆæ˜¯ Expatï¼Ÿ</strong> Expat æ˜¯ä¸€ä¸ªæµå¼è§£æå™¨ï¼Œåº”ç”¨ç¨‹åºåœ¨å¼€å§‹è§£æä¹‹å‰å‘è§£æå™¨æ³¨å†Œå¤„ç†ç¨‹åºï¼Œä»¥å¤„ç† XML æ–‡æ¡£ä¸­å‘ç°çš„ç›¸å…³ç»“æ„ï¼ˆä¾‹å¦‚å¼€å§‹æ ‡ç­¾ç­‰ï¼‰ã€‚</li>
  <li><strong>ä¸»è¦ç‰¹ç‚¹</strong>ï¼š
    <ul>
      <li><strong>æµå¼è§£æ</strong>ï¼šExpat æ˜¯æµå¼è§£æå™¨ï¼Œå®ƒåœ¨è§£æä¹‹å‰æ³¨å†Œå¤„ç†ç¨‹åºï¼Œç„¶ååœ¨æ–‡æ¡£ä¸­å‘ç°ç›¸å…³ç»“æ„æ—¶è°ƒç”¨è¿™äº›å¤„ç†ç¨‹åºã€‚</li>
      <li><strong>é€‚ç”¨äºå¤§æ–‡ä»¶</strong>ï¼šExpat é€‚ç”¨äºé‚£äº›æ–‡ä»¶å¤ªå¤§è€Œæ— æ³•æ”¾å…¥å†…å­˜çš„æƒ…å†µã€‚</li>
      <li><strong>æ€§èƒ½ä¼˜è¶Š</strong>ï¼šExpat åœ¨è§£æé€Ÿåº¦å’Œçµæ´»æ€§æ–¹é¢è¡¨ç°å‡ºè‰²ã€‚</li>
      <li><strong>å¹¿æ³›ä½¿ç”¨</strong>ï¼šè®¸å¤šåº”ç”¨ç¨‹åºã€åº“å’Œç¡¬ä»¶éƒ½ä½¿ç”¨äº† Expatã€‚</li>
      <li><strong>ç»‘å®šå’Œå°è£…</strong>ï¼šExpat è¿˜æœ‰ä¸€äº›ç»‘å®šå’Œç¬¬ä¸‰æ–¹å°è£…ï¼Œä½¿å…¶æ›´æ˜“äºåœ¨ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨ã€‚</li>
    </ul>
  </li>
</ul>

<p>è¯·æŸ¥çœ‹ <a href="https://libexpat.github.io/doc/getting-started/">è¿™ç¯‡ä»‹ç»æ€§æ–‡ç« </a></p>

<ul>
  <li>
    <p><strong>ç¤ºä¾‹</strong></p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;expat.h&gt;</span><span class="cp">
</span>    
  <span class="c1">// å›è°ƒå‡½æ•°ï¼šå¤„ç†å¼€å§‹æ ‡ç­¾</span>
  <span class="kt">void</span> <span class="nf">startElement</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">userData</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">atts</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"Start element: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
  <span class="p">}</span>
    
  <span class="c1">// å›è°ƒå‡½æ•°ï¼šå¤„ç†ç»“æŸæ ‡ç­¾</span>
  <span class="kt">void</span> <span class="nf">endElement</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">userData</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"End element: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
  <span class="p">}</span>
    
  <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// åˆ›å»ºè§£æå™¨</span>
      <span class="n">XML_Parser</span> <span class="n">parser</span> <span class="o">=</span> <span class="n">XML_ParserCreate</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parser</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error creating XML parser.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="c1">// è®¾ç½®å›è°ƒå‡½æ•°</span>
      <span class="n">XML_SetElementHandler</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">startElement</span><span class="p">,</span> <span class="n">endElement</span><span class="p">);</span>
    
      <span class="c1">// XML æ•°æ®ï¼ˆç¤ºä¾‹ï¼‰</span>
      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xmlData</span> <span class="o">=</span> <span class="s">"&lt;root&gt;&lt;item&gt;Apple&lt;/item&gt;&lt;item&gt;Banana&lt;/item&gt;&lt;/root&gt;"</span><span class="p">;</span>
    
      <span class="c1">// è§£æ XML æ•°æ®</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">XML_Parse</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">xmlData</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">xmlData</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">XML_STATUS_ERROR</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"Error parsing XML data.</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
          <span class="n">XML_ParserFree</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="c1">// é‡Šæ”¾è§£æå™¨</span>
      <span class="n">XML_ParserFree</span><span class="p">(</span><span class="n">parser</span><span class="p">);</span>
    
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

</code></pre></div>    </div>
  </li>
</ul>

<h1 id="libffi">libffi</h1>

<p><strong>libffi</strong> æ˜¯ä¸€ä¸ªç”¨ <strong>C</strong> ç¼–å†™çš„<strong>å¯ç§»æ¤çš„å¤–éƒ¨å‡½æ•°æ¥å£åº“</strong>ã€‚å®ƒä¸ºä¸åŒçš„è°ƒç”¨çº¦å®šæä¾›äº†ä¸€ä¸ªé«˜çº§åˆ«çš„ç¼–ç¨‹æ¥å£ï¼Œå…è®¸ç¨‹åºå‘˜åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»ä½•ç”±è°ƒç”¨æ¥å£æè¿°æŒ‡å®šçš„å‡½æ•°ã€‚<strong>FFI</strong> ä»£è¡¨<strong>å¤–éƒ¨å‡½æ•°æ¥å£</strong>ï¼Œæ˜¯å…è®¸åœ¨ä¸€ç§è¯­è¨€ä¸­ç¼–å†™çš„ä»£ç è°ƒç”¨å¦ä¸€ç§è¯­è¨€ä¸­ç¼–å†™çš„ä»£ç çš„æ¥å£ã€‚<strong>libffi</strong> å®é™…ä¸Šåªæä¾›äº†å®Œæ•´ç‰¹æ€§çš„å¤–éƒ¨å‡½æ•°æ¥å£çš„æœ€åº•å±‚ã€ä¸æœºå™¨ç›¸å…³çš„éƒ¨åˆ†ã€‚åœ¨<strong>libffi</strong>ä¹‹ä¸Šå¿…é¡»å­˜åœ¨ä¸€ä¸ªå¤„ç†ä¸¤ç§è¯­è¨€ä¹‹é—´ä¼ é€’çš„å€¼çš„ç±»å‹è½¬æ¢å±‚ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å…³äº <strong>libffi</strong> çš„ä¸€äº›é‡è¦ä¿¡æ¯ï¼š</p>

<ul>
  <li>
    <p><strong>ä»€ä¹ˆæ˜¯ libffiï¼Ÿ</strong> ç¼–è¯‘å™¨ä¸ºé«˜çº§è¯­è¨€ç”Ÿæˆéµå¾ªæŸäº›çº¦å®šçš„ä»£ç ã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯<strong>â€œè°ƒç”¨çº¦å®šâ€</strong>ã€‚<strong>â€œè°ƒç”¨çº¦å®šâ€</strong>å®é™…ä¸Šæ˜¯ç¼–è¯‘å™¨å¯¹å‡½æ•°å‚æ•°åœ¨è¿›å…¥å‡½æ•°æ—¶çš„ä½ç½®çš„ä¸€ç»„å‡è®¾ã€‚<strong>â€œè°ƒç”¨çº¦å®šâ€</strong>è¿˜æŒ‡å®šäº†å‡½æ•°çš„è¿”å›å€¼åœ¨å“ªé‡Œæ‰¾åˆ°ã€‚æœ‰äº›ç¨‹åºåœ¨ç¼–è¯‘æ—¶å¯èƒ½ä¸çŸ¥é“è¦ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œè§£é‡Šå™¨å¯èƒ½åœ¨è¿è¡Œæ—¶å‘ŠçŸ¥è°ƒç”¨ç»™å®šå‡½æ•°æ‰€ä½¿ç”¨çš„å‚æ•°çš„æ•°é‡å’Œç±»å‹ã€‚<strong>libffi</strong> å¯ä»¥åœ¨è¿™äº›ç¨‹åºä¸­ä½¿ç”¨ï¼Œä»¥æä¾›ä»è§£é‡Šå™¨ç¨‹åºåˆ°ç¼–è¯‘ä»£ç çš„æ¡¥æ¢ã€‚<strong>libffi</strong> åº“ä¸ºå„ç§è°ƒç”¨çº¦å®šæä¾›äº†ä¸€ä¸ªå¯ç§»æ¤çš„é«˜çº§åˆ«ç¼–ç¨‹æ¥å£ï¼Œå…è®¸ç¨‹åºå‘˜åœ¨è¿è¡Œæ—¶è°ƒç”¨ä»»ä½•ç”±è°ƒç”¨æ¥å£æè¿°æŒ‡å®šçš„å‡½æ•°ã€‚<strong>FFI</strong> ä»£è¡¨<strong>å¤–éƒ¨å‡½æ•°æ¥å£</strong>ã€‚å¤–éƒ¨å‡½æ•°æ¥å£æ˜¯å…è®¸åœ¨ä¸€ç§è¯­è¨€ä¸­ç¼–å†™çš„ä»£ç è°ƒç”¨å¦ä¸€ç§è¯­è¨€ä¸­ç¼–å†™çš„ä»£ç çš„æ¥å£ã€‚<strong>libffi</strong> å®é™…ä¸Šåªæä¾›äº†å®Œæ•´ç‰¹æ€§çš„å¤–éƒ¨å‡½æ•°æ¥å£çš„æœ€åº•å±‚ã€ä¸æœºå™¨ç›¸å…³çš„éƒ¨åˆ†ã€‚åœ¨<strong>libffi</strong>ä¹‹ä¸Šå¿…é¡»å­˜åœ¨ä¸€ä¸ªå¤„ç†ä¸¤ç§è¯­è¨€ä¹‹é—´ä¼ é€’çš„å€¼çš„ç±»å‹è½¬æ¢å±‚ã€‚</p>
  </li>
  <li>
    <p><strong>æ”¯æŒçš„å¹³å°</strong>ï¼š<strong>libffi</strong> å·²ç»ç§»æ¤åˆ°è®¸å¤šä¸åŒçš„å¹³å°ã€‚å‘å¸ƒæ—¶ï¼Œå·²ç»æµ‹è¯•äº†ä»¥ä¸‹åŸºæœ¬é…ç½®ï¼š</p>
    <ul>
      <li><strong>æ¶æ„</strong>ï¼šAArch64ï¼ˆARM64ï¼‰ã€Alphaã€ARCã€ARMã€AVR32ã€Blackfin ç­‰ã€‚</li>
      <li><strong>æ“ä½œç³»ç»Ÿ</strong>ï¼šLinuxã€iOSã€Windows ç­‰ã€‚</li>
      <li><strong>ç¼–è¯‘å™¨</strong>ï¼šClangã€GCCã€MSVC ç­‰ã€‚</li>
    </ul>
  </li>
</ul>

<p>å¦‚æƒ³äº†è§£æ›´å¤šå…³äº <strong>libffi</strong> çš„ç»†èŠ‚ï¼Œå¯ä»¥æŸ¥çœ‹ <a href="http://sourceware.org/libffi/">libffi å®˜æ–¹ç½‘é¡µ</a>ã€‚</p>

<ul>
  <li>
    <p><strong>ç¤ºä¾‹</strong> : åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† libffi æ¥è°ƒç”¨æ ‡å‡†åº“å‡½æ•° putsï¼Œå¹¶ä¼ é€’äº†ä¸åŒçš„å­—ç¬¦ä¸²ä½œä¸ºå‚æ•°ã€‚è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ libffi åŠ¨æ€åœ°è°ƒç”¨å¤–éƒ¨å‡½æ•°ã€‚</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>  <span class="cp">#include</span> <span class="cpf">&lt;ffi.h&gt;</span><span class="cp">
</span>    
  <span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">ffi_cif</span> <span class="n">cif</span><span class="p">;</span>
      <span class="n">ffi_type</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="kt">void</span> <span class="o">*</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
      <span class="n">ffi_arg</span> <span class="n">rc</span><span class="p">;</span>
    
      <span class="c1">// åˆå§‹åŒ–å‚æ•°ä¿¡æ¯å‘é‡</span>
      <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ffi_type_pointer</span><span class="p">;</span>
      <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">;</span>
    
      <span class="c1">// åˆå§‹åŒ– cif</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ffi_prep_cif</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="p">,</span> <span class="n">FFI_DEFAULT_ABI</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ffi_type_sint</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="n">FFI_OK</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">s</span> <span class="o">=</span> <span class="s">"Hello World!"</span><span class="p">;</span>
          <span class="n">ffi_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">puts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
          <span class="c1">// rc ç°åœ¨ä¿å­˜äº†å¯¹ puts çš„è°ƒç”¨ç»“æœ</span>
          <span class="c1">// æ›´æ”¹ s çš„å€¼åï¼Œå¯ä»¥å†æ¬¡è°ƒç”¨ puts()</span>
          <span class="n">s</span> <span class="o">=</span> <span class="s">"This is cool!"</span><span class="p">;</span>
          <span class="n">ffi_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cif</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">puts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">,</span> <span class="n">values</span><span class="p">);</span>
      <span class="p">}</span>
    
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

</code></pre></div>    </div>
  </li>
</ul>]]></content><author><name>kevin</name></author><category term="Jekyll" /><summary type="html"><![CDATA[Expat]]></summary></entry><entry><title type="html">ç¡¬ä¸­æ–­</title><link href="http://localhost:4000/blog/jekyll/2019-02-03-interrupte.html" rel="alternate" type="text/html" title="ç¡¬ä¸­æ–­" /><published>2019-02-03T00:00:00+08:00</published><updated>2019-02-03T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/interrupte</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2019-02-03-interrupte.html"><![CDATA[<p>ã€è½¬å¸–ã€‘</p>

<p>æœ¬æ¥æƒ³å†™å†…æ ¸å¦‚ä½•æ¥æ”¶ä¸€ä¸ªç½‘ç»œåŒ…è¿™ä¸ªè¿‡ç¨‹ï¼Œä½†å‘ç°æŠŠæ•´ä¸ªè¿‡ç¨‹æ‹é¡ºäº†ï¼Œè¿˜æ˜¯å¾ˆéš¾çš„ã€‚</p>

<p>æ¨å¯¼æ•´ä¸ªè¿‡ç¨‹çš„èµ·ç‚¹æ˜¯<strong>ä¸­æ–­</strong>ï¼ŒåŒ…æ‹¬<strong>ç¡¬ä¸­æ–­</strong>å’Œ<strong>è½¯ä¸­æ–­</strong>ã€‚</p>

<p>è€Œè¿™ä¸ªè¿‡ç¨‹è¦æ˜¯è®²æ¸…æ¥šå§ï¼Œæ„Ÿè§‰åœ¨æ•´ä¸ªç½‘ç»œåŒ…æ¥æ”¶åŸç†çš„å¤§æµç¨‹ä¸­æœ‰ç‚¹å–§å®¾å¤ºä¸»ã€‚ä½†è¦æ˜¯ä¸€ç¬”å¸¦è¿‡å§ï¼Œé‚£å¯¹äºè¿™å—æœ‰å›°æƒ‘çš„äººå°±å¾ˆéš¾å—ï¼Œä¸€åˆ‡çš„èµ·ç‚¹æ²¡æ•´æ˜ç™½åœ¨å¿ƒé‡Œæ€»æ˜¯ä¸ªç–™ç˜©ã€‚æ‰€ä»¥ï¼Œå•æ‹å‡ºæ¥ä¸€ä¸ªä¸»é¢˜ä¸­æ–­ï¼Œç»™å¤§å®¶æŠŠè¿™ä¸ªé—®é¢˜ææ˜ç™½äº†ã€‚</p>

<p>å¦å¤–ï¼Œ<strong>æ•´ä¸ªæ“ä½œç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªä¸­æ–­é©±åŠ¨çš„æ­»å¾ªç¯</strong>ï¼Œæ“ä½œç³»ç»ŸåŸç†å¦‚æœç”¨ä¸€è¡Œä»£ç è§£é‡Šï¼Œä¸‹é¢è¿™æ ·å†åˆé€‚ä¸è¿‡äº†ã€‚</p>

<pre><code class="language-C">while(true)Â {
	doNothing();
}
</code></pre>

<p><strong>å…¶ä»–æ‰€æœ‰äº‹æƒ…éƒ½æ˜¯ç”±æ“ä½œç³»ç»Ÿæå‰æ³¨å†Œçš„ä¸­æ–­æœºåˆ¶å’Œå…¶å¯¹åº”çš„ä¸­æ–­å¤„ç†å‡½æ•°å®Œæˆ</strong>ï¼Œæˆ‘ä»¬ç‚¹å‡»ä¸€ä¸‹é¼ æ ‡ï¼Œæ•²å‡»ä¸€ä¸‹é”®ç›˜ï¼Œæ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œéƒ½æ˜¯ç”¨ä¸­æ–­çš„æ–¹å¼æ¥é€šçŸ¥æ“ä½œç³»ç»Ÿå¸®æˆ‘ä»¬å¤„ç†è¿™äº›äº‹ä»¶ï¼Œå½“æ²¡æœ‰ä»»ä½•éœ€è¦æ“ä½œç³»ç»Ÿå¤„ç†çš„äº‹ä»¶æ—¶ï¼Œå®ƒå°±ä¹–ä¹–åœåœ¨æ­»å¾ªç¯é‡Œä¸å‡ºæ¥ã€‚</p>

<p>æ‰€ä»¥ï¼Œä¸­æ–­ï¼Œéå¸¸é‡è¦ï¼Œå®ƒä¹Ÿæ˜¯ç†è§£æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„æ ¹åŸºï¼ŒæŒæ¡å®ƒï¼Œä¸äºï¼</p>

<p>é‚£æˆ‘ä»¬å¼€å§‹å§ã€‚</p>

<p><strong>äº”èŠ±å…«é—¨çš„ä¸­æ–­åˆ†ç±»</strong></p>

<p>å…³äºä¸­æ–­çš„åˆ†ç±»ï¼Œæ•™ç§‘ä¹¦ä¸Šå’Œç½‘ä¸Šæœ‰å¾ˆå¤šâ€æ ‡å‡†â€ç­”æ¡ˆäº†ï¼Œå¦‚æœä½ ç”¨æœç´¢å¼•æ“å»å¯»æ‰¾ç­”æ¡ˆï¼Œå¯èƒ½ä¼šæ‰¾å‡ºå¾ˆå¤šä¸ä¸€æ ·çš„åˆ†ç±»ç»“æœã€‚</p>

<p>æ‰€ä»¥æˆ‘æ‰“ç®—ç›´æ¥åœ¨ Intel æ‰‹å†Œä¸Šæ‰¾ä¸ªæœ€å®˜æ–¹çš„æ ‡å‡†ç­”æ¡ˆã€‚</p>

<p>åœ¨Â <em>Intel æ‰‹å†Œ Volume 1 Chapter 6.4 Interrupts and Exception</em>Â ç»™å‡ºã€‚</p>

<p><img src="https://mmbiz.qpic.cn/mmbiz_png/GLeh42uInXRaebHKiaWevE73umedjHIDmQ3eQXdDdbee9wMwIwic5eNK9N2Erm01239eKbz1hl6ZWLSo3BRf6UBg/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡" /></p>

<p>ç¿»è¯‘è¿‡æ¥å°±æ˜¯ï¼Œ<strong>ä¸­æ–­å¯ä»¥åˆ†ä¸ºä¸­æ–­å’Œå¼‚å¸¸ï¼Œå¼‚å¸¸åˆå¯ä»¥åˆ†ä¸ºæ•…éšœã€é™·é˜±ã€ä¸­æ­¢</strong>ã€‚</p>

<p>ç¬¬ä¸€å¥è¯æœ‰ç‚¹å¥‡æ€ªï¼Œå•¥å«ä¸­æ–­åˆ†ä¸ºä¸­æ–­å’Œå¼‚å¸¸å‘¢ï¼Ÿä½ çœ‹å¥½å¤šæ–‡ç« çš„æ—¶å€™ä¹Ÿæ˜¯è¿™ä¹ˆå†™çš„ï¼Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ›¾ç–‘æƒ‘è¿‡ã€‚</p>

<p>ä½†å…¶å®åŸæ–‡çš„æ„æ€å‡†ç¡®è¯´æ˜¯ï¼Œ<strong>CPU æä¾›äº†ä¸¤ç§ä¸­æ–­ç¨‹åºæ‰§è¡Œçš„æœºåˆ¶ï¼Œä¸­æ–­å’Œå¼‚å¸¸</strong>ã€‚ç¬¬ä¸€ä¸ªä¸­æ–­æ˜¯ä¸ªåŠ¨è¯ï¼Œç¬¬äºŒä¸ªä¸­æ–­æ‰æ˜¯çœŸæ­£çš„æœºåˆ¶ç§ç±»ã€‚</p>

<p>å¥½å§ï¼Œæˆ‘æ„Ÿè§‰åŸæ–‡ä¹ŸæŒºå¥‡æ€ªçš„ï¼Œä½†äººå®¶å°±è¿™ä¹ˆå«ï¼Œæ²¡è¾™ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘åªéœ€è¦ç¿»è¯‘ä¸€ä¸‹å°±å¥½äº†ï¼Œå†å¤¹æ‚ç‚¹è‡ªå·±çš„è§£è¯»ã€‚</p>

<p>An interrupt is an asynchronous event that is typically triggered by an I/O device.</p>

<p>å…ˆè¯´ç¬¬ä¸€ä¸ªæœºåˆ¶ä¸­æ–­ï¼ˆinterruptï¼‰ï¼Œ<strong>ä¸­æ–­æ˜¯ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶ï¼Œé€šå¸¸ç”± IO è®¾å¤‡è§¦å‘</strong>ã€‚æ¯”å¦‚ç‚¹å‡»ä¸€ä¸‹é¼ æ ‡ã€æ•²å‡»ä¸€ä¸‹é”®ç›˜ç­‰ã€‚</p>

<p>An exception is a synchronous event that is generated when the processor detects one or more predefined conditions while executing an instruction.</p>

<p>å†è¯´ç¬¬äºŒä¸ªæœºåˆ¶å¼‚å¸¸ï¼ˆexceptionï¼‰ï¼Œ<strong>å¼‚å¸¸æ˜¯ä¸€ä¸ªåŒæ­¥äº‹ä»¶ï¼Œæ˜¯ CPU åœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶æ£€æµ‹åˆ°çš„åå¸¸æ¡ä»¶</strong>ã€‚æ¯”å¦‚é™¤æ³•å¼‚å¸¸ã€é”™è¯¯æŒ‡ä»¤å¼‚å¸¸ï¼Œç¼ºé¡µå¼‚å¸¸ç­‰ã€‚</p>

<p>è¿™ä¸¤ä¸ªæœºåˆ¶ï¼Œæ®Šé€”åŒå½’ï¼Œ<strong>éƒ½æ˜¯è®© CPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­å·</strong>ï¼Œè‡³äº CPU æ”¶åˆ°è¿™ä¸ªä¸­æ–­å·ä¹‹åå¹²å˜›ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸ç®¡ã€‚</p>

<p><img src="https://mmbiz.qpic.cn/mmbiz_png/GLeh42uInXRaebHKiaWevE73umedjHIDmq0gPkgWwLqjwEibZabXqibsCoCtG03GLQzxIvXh7UK3WYHYNHYWluPNQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡" /></p>

<p>æˆ‘ä»¬å…ˆçœ‹çœ‹æ”¶åˆ°ä¸­æ–­å·ä¹‹å‰ï¼Œå…·ä½“å°±æ˜¯ä¸­æ–­å’Œå¼‚å¸¸åˆ°åº•æ˜¯æ€ä¹ˆåšåˆ°ç»™ CPU ä¸€ä¸ªä¸­æ–­å·çš„ã€‚</p>

<p>å…ˆè¯´ä¸­æ–­ï¼Œåˆ«çœ¨çœ¼ã€‚</p>

<p>æœ‰ä¸€ä¸ªè®¾å¤‡å«åš<strong>å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨</strong>ï¼Œå®ƒæœ‰å¾ˆå¤šçš„Â <strong>IRQ</strong>Â å¼•è„šçº¿ï¼Œæ¥å…¥äº†ä¸€å †èƒ½å‘å‡ºä¸­æ–­è¯·æ±‚çš„ç¡¬ä»¶è®¾å¤‡ï¼Œå½“è¿™äº›ç¡¬ä»¶è®¾å¤‡ç»™ IRQ å¼•è„šçº¿å‘ä¸€ä¸ªä¿¡å·æ—¶ï¼Œç”±äºå¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨æå‰è¢«è®¾ç½®å¥½äº† IRQ ä¸ä¸­æ–­å·çš„å¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥å°±è½¬åŒ–æˆäº†å¯¹åº”çš„ä¸­æ–­å·ï¼ŒæŠŠè¿™ä¸ªä¸­æ–­å·å­˜å‚¨åœ¨è‡ªå·±çš„ä¸€ä¸ªç«¯å£ä¸Šï¼Œç„¶åç»™ CPU çš„Â <strong>INTR</strong>Â å¼•è„šå‘é€ä¸€ä¸ªä¿¡å·ï¼ŒCPU æ”¶åˆ° INTR å¼•è„šä¿¡å·åå»åˆšåˆšçš„é‚£ä¸ªç«¯å£è¯»å–åˆ°è¿™ä¸ªä¸­æ–­å·çš„å€¼ã€‚</p>

<p>ä¼°è®¡ä½ è¢«ç»•æ™•äº†ï¼Œä½†è¯»æˆ‘çš„æ–‡ç« æœ‰ä¸ªå¥½å¤„ï¼Œå¤ªå¤æ‚å°±ä¸ŠåŠ¨å›¾ï¼Œæ¥å§ã€‚
![[image-20230320094930185.png]]</p>

<p>ä½ çœ‹ï¼Œ<strong>æœ€ç»ˆçš„ç›®æ ‡ï¼Œå°±æ˜¯è®© CPU çŸ¥é“ï¼Œæœ‰ä¸­æ–­äº†ï¼Œå¹¶ä¸”ä¹ŸçŸ¥é“ä¸­æ–­å·æ˜¯å¤šå°‘</strong>ã€‚</p>

<p>æ¯”å¦‚ä¸Šå›¾ä¸­æŒ‰ä¸‹äº†é”®ç›˜ï¼Œæœ€ç»ˆåˆ° CPU é‚£é‡Œçš„ååº”å°±æ˜¯ï¼Œå¾—åˆ°äº†ä¸€ä¸ªä¸­æ–­å·Â <strong>0x21</strong>ã€‚</p>

<p>é‚£å¼‚å¸¸çš„æœºåˆ¶å°±æ›´ç®€å•äº†ï¼Œæ˜¯ CPU è‡ªå·±æ‰§è¡ŒæŒ‡ä»¤æ—¶æ£€æµ‹åˆ°çš„ä¸€äº›åå¸¸æƒ…å†µï¼Œç„¶åè‡ªå·±ç»™è‡ªå·±ä¸€ä¸ªä¸­æ–­å·å³å¯ï¼Œæ— éœ€å¤–ç•Œç»™ã€‚</p>

<p>æ¯”å¦‚ CPU æ‰§è¡Œåˆ°äº†ä¸€ä¸ªæ— æ•ˆçš„æŒ‡ä»¤ï¼Œåˆ™è‡ªå·±ç»™è‡ªå·±ä¸€ä¸ªä¸­æ–­å·Â <strong>0x06</strong>ï¼Œè¿™ä¸ªä¸­æ–­å·æ˜¯ Intel çš„ CPU æå‰å°±è§„å®šå¥½å†™æ­»äº†çš„ç¡¬å¸ƒçº¿é€»è¾‘ã€‚</p>

<p>å¥½äº†ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ— è®ºæ˜¯<strong>ä¸­æ–­</strong>è¿˜æ˜¯<strong>å¼‚å¸¸</strong>ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡å„ç§æ–¹å¼ï¼Œè®© CPU å¾—åˆ°ä¸€ä¸ªä¸­æ–­å·ã€‚åªä¸è¿‡ä¸­æ–­æ˜¯é€šè¿‡å¤–éƒ¨è®¾å¤‡ç»™ CPU çš„ INTR å¼•è„šå‘ä¿¡å·ï¼Œå¼‚å¸¸æ˜¯ CPU è‡ªå·±æ‰§è¡ŒæŒ‡ä»¤çš„æ—¶å€™å‘ç°ç‰¹æ®Šæƒ…å†µè§¦å‘çš„ï¼Œè‡ªå·±ç»™è‡ªå·±ä¸€ä¸ªä¸­æ–­å·ã€‚</p>

<p>è¿˜æœ‰ä¸€ç§æ–¹å¼å¯ä»¥ç»™åˆ° CPU ä¸€ä¸ªä¸­æ–­å·ï¼Œä½† Intel æ‰‹å†Œå†™åœ¨äº†åé¢ï¼Œ<em>Chapter 6.4.4 INT n</em>ï¼Œå°±æ˜¯å¤§åé¼é¼çš„Â <strong>INT æŒ‡ä»¤</strong>ã€‚
![[image-20230320095004648.png]]</p>

<p>INT æŒ‡ä»¤åé¢è·Ÿä¸€ä¸ªæ•°å­—ï¼Œå°±ç›¸å½“äºç›´æ¥ç”¨æŒ‡ä»¤çš„å½¢å¼ï¼Œå‘Šè¯‰ CPU ä¸€ä¸ªä¸­æ–­å·ã€‚</p>

<p>æ¯”å¦‚Â <strong>INT 0x80</strong>ï¼Œå°±æ˜¯å‘Šè¯‰ CPU ä¸­æ–­å·æ˜¯Â <strong>0x80</strong>ã€‚Linux å†…æ ¸æä¾›çš„<strong>ç³»ç»Ÿè°ƒç”¨</strong>ï¼Œå°±æ˜¯ç”¨äº† INT 0x80 è¿™ç§æŒ‡ä»¤ã€‚</p>

<p>é‚£æˆ‘ä»¬ä¸Šé¢çš„å›¾åˆä¸°å¯Œäº†èµ·æ¥ã€‚
![[image-20230320095040034.png]]</p>

<p>æœ‰çš„åœ°æ–¹å–œæ¬¢æŠŠä»–ä»¬åšä¸€äº›åŒºåˆ†ï¼ŒæŠŠ INT n è¿™ç§æ–¹å¼å«åš<strong>è½¯ä»¶ä¸­æ–­</strong>ï¼Œå› ä¸ºä»–æ˜¯ç”±è½¯ä»¶ç¨‹åºä¸»åŠ¨è§¦å‘çš„ã€‚ç›¸åº”çš„æŠŠä¸Šé¢çš„ä¸­æ–­å’Œå¼‚å¸¸å«åš<strong>ç¡¬ä»¶ä¸­æ–­</strong>ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯ç¡¬ä»¶è‡ªåŠ¨è§¦å‘çš„ã€‚</p>

<p>ä½†æˆ‘è§‰å¾—å¤§å¯ä¸å¿…ï¼Œä¸€å…±å°±è¿™ä¹ˆå‡ ä¸ªåˆ†ç±»ï¼Œå¹²å˜›è¿˜è¦å¢åŠ ä¸€å±‚ç†è§£çš„æˆæœ¬å‘¢ï¼Œè®°ä¸‰ä¸ªæ–¹å¼ä¸å¥½ä¹ˆï¼Ÿ</p>

<p>å¥½äº†ï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œç»™ CPU ä¸€ä¸ªä¸­æ–­å·æœ‰ä¸‰ç§æ–¹å¼ï¼Œè€Œè¿™ä¹Ÿæ˜¯ä¸­æ–­åˆ†ç±»çš„ä¾æ®ã€‚</p>

<p><em><strong>1.</strong></em>Â <strong>é€šè¿‡ä¸­æ–­æ§åˆ¶å™¨ç»™ CPU çš„ INTR å¼•è„šå‘é€ä¿¡å·</strong>ï¼Œå¹¶ä¸”å…è®¸ CPU ä»ä¸­æ–­æ§åˆ¶å™¨çš„ä¸€ä¸ªç«¯å£ä¸Šè¯»å–ä¸­æ–­å·ï¼Œæ¯”å¦‚æŒ‰ä¸‹é”®ç›˜çš„ä¸€ä¸ªæŒ‰é”®ï¼Œæœ€ç»ˆä¼šç»™åˆ° CPU ä¸€ä¸ª 0x21 ä¸­æ–­å·ã€‚</p>

<p><em><strong>2.</strong></em>Â <strong>CPU æ‰§è¡ŒæŸæ¡æŒ‡ä»¤å‘ç°äº†å¼‚å¸¸</strong>ï¼Œä¼šè‡ªå·±è§¦å‘å¹¶ç»™è‡ªå·±ä¸€ä¸ªä¸­æ–­å·ï¼Œæ¯”å¦‚æ‰§è¡Œåˆ°äº†æ— æ•ˆæŒ‡ä»¤ï¼ŒCPU ä¼šç»™è‡ªå·±ä¸€ä¸ª 0x06 çš„ä¸­æ–­å·ã€‚</p>

<p><em><strong>3.</strong></em>Â <strong>æ‰§è¡Œ INT n æŒ‡ä»¤</strong>ï¼Œä¼šç›´æ¥ç»™ CPU ä¸€ä¸ªä¸­æ–­å· nï¼Œæ¯”å¦‚è§¦å‘äº† Linux çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº† INT 0x80 æŒ‡ä»¤ï¼Œé‚£ä¹ˆ CPU æ”¶åˆ°çš„å°±æ˜¯ä¸€ä¸ª 0x80 ä¸­æ–­å·ã€‚</p>

<p>å†å¾€åï¼ŒCPU ä»¥å„ç§ä¸åŒçš„æ–¹å¼æ”¶åˆ°çš„è¿™äº› 0x21 0x06 0x80ï¼Œéƒ½ä¼š<strong>ä¸€è§†åŒä»</strong>ï¼ŒåšåŒæ ·çš„åç»­å¤„ç†æµç¨‹ï¼Œæ‰€ä»¥ä»ç°åœ¨å¼€å§‹ï¼Œå‰é¢çš„äº‹æƒ…å°±ä¸ç”¨å†ç®¡äº†ï¼Œè¿™ä¹Ÿä½“ç°äº†åˆ†å±‚çš„å¥½å¤„ã€‚</p>

<p><strong>æ”¶åˆ°ä¸­æ–­å·ä¹‹å CPU å¹²å˜›ï¼Ÿ</strong></p>

<p>é‚£ CPU æ”¶åˆ°ä¸­æ–­å·åï¼Œå¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p>

<p>å…ˆç”¨ä¸€å¥ä¸å¤ªå‡†ç¡®çš„è¯æ€»ç»“ï¼Œ<strong>CPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­å· n åï¼Œä¼šå»ä¸­æ–­å‘é‡è¡¨ä¸­å¯»æ‰¾ç¬¬ n ä¸ªä¸­æ–­æè¿°ç¬¦ï¼Œä»ä¸­æ–­æè¿°ç¬¦ä¸­æ‰¾åˆ°ä¸­æ–­å¤„ç†ç¨‹åºçš„åœ°å€ï¼Œç„¶åè·³è¿‡å»æ‰§è¡Œ</strong>ã€‚</p>

<p>ä¸ºä»€ä¹ˆè¯´ä¸å‡†ç¡®å‘¢ï¼Ÿå› ä¸ºä»ä¸­æ–­æè¿°ç¬¦ä¸­æ‰¾åˆ°çš„ï¼Œå¹¶ä¸ç›´æ¥æ˜¯ç¨‹åºçš„åœ°å€ï¼Œè€Œæ˜¯<strong>æ®µé€‰æ‹©å­</strong>å’Œ<strong>æ®µå†…åç§»åœ°å€</strong>ã€‚ç„¶åæ®µé€‰æ‹©å­åˆä¼šå»<strong>å…¨å±€æè¿°ç¬¦è¡¨</strong>ä¸­å¯»æ‰¾<strong>æ®µæè¿°ç¬¦</strong>ï¼Œä»ä¸­å–å‡º<strong>æ®µåŸºå€</strong>ã€‚ä¹‹åæ®µåŸºå€ + æ®µå†…åç§»åœ°å€ï¼Œæ‰æ˜¯æœ€ç»ˆå¤„ç†ç¨‹åºçš„å…¥å£åœ°å€ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" />å½“ç„¶è¿™ä¸ªå…¥å£åœ°å€ï¼Œè¿˜ä¸æ˜¯æœ€ç»ˆçš„ç‰©ç†åœ°å€ï¼Œå¦‚æœå¼€å¯äº†åˆ†é¡µï¼Œåˆè¦ç»å†åˆ†é¡µæœºåˆ¶çš„è½¬æ¢ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" />ä¸è¿‡ä¸è¦æ‹…å¿ƒï¼Œè¿™ä¸æ˜¯ä¸­æ–­çš„ä¸»æµç¨‹ï¼Œ<strong>å› ä¸ºåˆ†æ®µæœºåˆ¶å’Œåˆ†é¡µæœºåˆ¶æ˜¯æ‰€æœ‰åœ°å€è½¬æ¢è¿‡ç¨‹çš„å¿…ç»ä¹‹è·¯ï¼Œå¹¶ä¸æ˜¯ä¸­æ–­è¿™ä¸ªæµç¨‹æ‰€ç‰¹æœ‰çš„</strong>ã€‚</p>

<p>æ‰€ä»¥æˆ‘ä»¬ç®€å•çš„æŠŠä¸­æ–­æè¿°ç¬¦è¡¨ä¸­å­˜å‚¨çš„åœ°å€ï¼Œç›´æ¥å½“åš CPU å¯ä»¥è·³è¿‡å»æ‰§è¡Œçš„ä¸­æ–­å¤„ç†ç¨‹åºçš„å…¥å£åœ°å€ï¼Œå°±å¥½äº†ï¼Œä¸å½±å“ç†è§£ä»–ä»¬ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>ä½ çœ‹ï¼Œè¿™æ˜¯ä¸æ˜¯ç®€å•å¾ˆå¤šã€‚</p>

<p>é‚£æ¥ä¸‹æ¥çš„é—®é¢˜å°±å¾ˆç®€å•äº†ï¼Œè¿™é‡Œå‡ºç°äº†ä¸¤ä¸ªåè¯ï¼Œé‚£å°±åˆ†åˆ«å¯¹ä»–ä»¬è¿›è¡Œå‘é—®ã€‚</p>

<p><em><strong>1.</strong></em>Â ä¸­æ–­æè¿°ç¬¦è¡¨æ˜¯å•¥ï¼Ÿ</p>

<p><em><strong>2.</strong></em>Â ä¸­æ–­æè¿°ç¬¦æ˜¯å•¥ï¼Ÿ</p>

<p><em><strong>3.</strong></em>Â å»å“ªé‡Œæ‰¾ä»–ä»¬ï¼Ÿ</p>

<p>åˆ†åˆ«å›ç­”å³å¯</p>

<blockquote>
  <blockquote>
    <p><strong>ä¸­æ–­æè¿°ç¬¦è¡¨æ˜¯å•¥ï¼Ÿ</strong></p>

  </blockquote>
</blockquote>

<p><strong>å°±æ˜¯ä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„æ•°ç»„è€Œå·²</strong>ï¼Œæ“ä½œç³»ç»Ÿåˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæœ‰å¾ˆå¤šç»“æ„éƒ½ç§°ä¹‹ä¸º XXX è¡¨ï¼Œå…¶å®å°±æ˜¯ä¸ªæ•°ç»„ç½¢äº†ã€‚</p>

<p>ä»¥ linux-2.6.0 æºç ä¸ºä¾‹ï¼Œå°±å¾ˆç›´è§‚äº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>structÂ desc_structÂ idt_table[256]Â =Â {Â {0,Â 0},Â };
</code></pre></div></div>

<p>ä½ çœ‹ï¼Œæ˜¯ä¸€ä¸ªå¤§å°ä¸º 256 çš„æ•°ç»„ã€‚idt_table è¿™ä¸ªåå­—å°±æ˜¯Â <strong>Interrupt Descriptor Table</strong>ï¼Œé€å­—ç¿»è¯‘è¿‡æ¥ç¡®å®å°±æ˜¯<strong>ä¸­æ–­æè¿°ç¬¦è¡¨</strong>ã€‚</p>

<blockquote>
  <blockquote>
    <p><strong>ä¸­æ–­æè¿°ç¬¦æ˜¯å•¥ï¼Ÿ</strong></p>

  </blockquote>
</blockquote>

<p><strong>å°±æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨è¿™ä¸ªæ•°ç»„é‡Œçš„å­˜å‚¨çš„æ•°æ®ç»“æ„</strong>ï¼Œé€šè¿‡åˆšåˆšçš„æºç ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ˜¯ä¸€ä¸ªå«Â <strong>desc_struct</strong>Â çš„ç»“æ„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>structÂ desc_structÂ {Â Â Â Â unsignedÂ longÂ a,b;};
</code></pre></div></div>

<p>å¥½å®¶ä¼™ï¼ŒLinux æºç é‡Œå°±è¿™ä¹ˆç®€å•ç²—æš´è¡¨ç¤ºï¼Œä¸€ä¸ªä¸­æ–­æè¿°ç¬¦çš„å¤§å°ä¸º 64 ä½ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œå…·ä½“é‡Œé¢å­˜çš„å•¥é€šè¿‡è¿™ä¸ªæºç çœ‹ä¸å‡ºæ¥ã€‚</p>

<p>ç¿»ä¸€ä¸‹ Intel æ‰‹å†Œï¼Œåœ¨Â <em>Volumn 3 Chapter 5.11 IDT Descriptors</em>Â ä¸­æ‰¾åˆ°äº†ä¸€å¼ å›¾ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸­æ–­æè¿°ç¬¦å…·ä½“è¿˜åˆ†æˆå¥½å‡ ä¸ªç§ç±»ï¼Œæœ‰ï¼š</p>

<p><strong>Task Gate</strong>ï¼šä»»åŠ¡é—¨æè¿°ç¬¦</p>

<p><strong>Interrupt Gate</strong>ï¼šä¸­æ–­é—¨æè¿°ç¬¦</p>

<p><strong>Trap Gate</strong>ï¼šé™·é˜±é—¨æè¿°ç¬¦</p>

<p>ä¸è¦æ…Œï¼Œå…¶ä¸­ä»»åŠ¡é—¨æè¿°ç¬¦ Linux ä¸­å‡ ä¹æ²¡æœ‰ç”¨åˆ°ã€‚</p>

<p>ä¸­æ–­é—¨æè¿°ç¬¦å’Œé™·é˜±é—¨æè¿°ç¬¦çš„åŒºåˆ«ä»…ä»…æ˜¯<strong>æ˜¯å¦å…è®¸ä¸­æ–­åµŒå¥—</strong>ï¼Œå®ç°æ–¹å¼éå¸¸ç®€å•ç²—æš´ï¼Œå°±æ˜¯ CPU å¦‚æœæ”¶åˆ°çš„ä¸­æ–­å·å¯¹åº”çš„æ˜¯ä¸€ä¸ªä¸­æ–­é—¨æè¿°ç¬¦ï¼Œå°±ä¿®æ”¹ IF æ ‡å¿—ä½ï¼ˆå°±æ˜¯ä¸€ä¸ªå¯„å­˜å™¨ä¸­ä¸€ä½çš„å€¼ï¼‰ï¼Œä¿®æ”¹äº†è¿™ä¸ªå€¼åå°±å±è”½äº†ä¸­æ–­ï¼Œä¹Ÿå°±é˜²æ­¢äº†ä¸­æ–­çš„åµŒå¥—ã€‚è€Œé™·é˜±é—¨æ²¡æœ‰æ”¹è¿™ä¸ªæ ‡å¿—ä½ï¼Œä¹Ÿå°±å…è®¸äº†ä¸­æ–­çš„åµŒå¥—ã€‚</p>

<p>æ‰€ä»¥ç®€å•ç†è§£çš„è¯ï¼Œä½ æŠŠä»–ä»¬å½“åšåŒæ ·ä¸€ä¸ªæè¿°ç¬¦å°±å¥½äº†ï¼Œå…ˆåˆ«ç®¡è¿™äº›ç»†èŠ‚ï¼Œä»–ä»¬çš„ç»“æ„å‡ ä¹å®Œå…¨ä¸€æ ·ï¼Œåªæ˜¯å·®äº†ä¸€ä¸ªç±»å‹æ ‡è¯†ç½¢äº†ã€‚</p>

<p>é‚£è¿™ä¸ªä¸­æ–­æè¿°ç¬¦çš„ç»“æ„é•¿ä»€ä¹ˆæ ·å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼Œé‡Œé¢æœ‰<strong>æ®µé€‰æ‹©å­</strong>å’Œ<strong>æ®µå†…åç§»åœ°å€</strong>ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>å›é¡¾ä¸‹åˆšåˆšè¯´çš„ä¸­æ–­å¤„ç†æµç¨‹ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" />æ²¡éª—ä½ å§ã€‚</p>

<p>ä½†ä»¥ä¸Šè¿™äº›å¦‚æœä½ éƒ½æä¸æ˜ç™½ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œè®°è¿™ä¸ªæœ€ç®€å•çš„æµç¨‹å°±å¥½äº†ï¼Œä¸å½±å“ç†è§£ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬ç›´è§‚åœ°çœ‹åˆ°äº†ä¸­æ–­æè¿°ç¬¦è¡¨è¿™ä¸ª 256 å¤§å°çš„æ•°ç»„ï¼Œä»¥åŠå®ƒé‡Œé¢å­˜çš„ä¸­æ–­æè¿°ç¬¦é•¿ä»€ä¹ˆæ ·å­ï¼Œ<strong>æœ€ç»ˆçš„ç›®çš„ï¼Œè¿˜æ˜¯å¸®åŠ© CPU æ‰¾åˆ°ä¸€ä¸ªç¨‹åºçš„å…¥å£åœ°å€ï¼Œç„¶åè·³è½¬è¿‡å»</strong>ã€‚</p>

<p>OKï¼Œä¸‹ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ CPU æ€ä¹ˆå¯»æ‰¾åˆ°è¿™ä¸ªä¸­æ–­æè¿°ç¬¦è¡¨çš„ä½ç½®å‘¢ï¼Ÿå®ƒæ˜¯åœ¨å†…å­˜ä¸­ä¸€ä¸ªå›ºå®šçš„ä½ç½®ä¹ˆï¼Ÿ</p>

<blockquote>
  <blockquote>
    <p><strong>CPU æ€ä¹ˆæ‰¾åˆ°ä¸­æ–­æè¿°ç¬¦è¡¨</strong></p>

  </blockquote>
</blockquote>

<p>ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œ<strong>ä¸­æ–­æè¿°ç¬¦è¡¨åœ¨å“ªé‡Œï¼Œå…¨å‡­å„ä¸ªæ“ä½œç³»ç»Ÿçš„å–œå¥½ï¼Œæƒ³æ”¾åœ¨å“ªé‡Œå°±æ”¾åœ¨å“ªé‡Œ</strong>ï¼Œä½†éœ€è¦é€šè¿‡æŸç§æ–¹å¼å‘Šè¯‰ CPUï¼Œå³å¯ã€‚</p>

<p>æ€ä¹ˆå‘Šè¯‰å‘¢ï¼ŸCPU æå‰é¢„ç•™äº†ä¸€ä¸ªå¯„å­˜å™¨å«Â <strong>IDTR å¯„å­˜å™¨</strong>ï¼Œè¿™é‡Œé¢å­˜æ”¾çš„å°±æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨çš„èµ·å§‹åœ°å€ï¼Œä»¥åŠä¸­æ–­æè¿°ç¬¦è¡¨çš„å¤§å°ã€‚</p>

<p>åœ¨Â <em>Volumn 3 Chapter 5.10 Interrupt Descriptor Table</em>Â ä¸­å‘Šè¯‰äº†æˆ‘ä»¬ IDTR å¯„å­˜å™¨çš„ç»“æ„ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>æ“ä½œç³»ç»Ÿçš„ä»£ç å¯ä»¥é€šè¿‡Â <strong>LIDT æŒ‡ä»¤</strong>ï¼Œå°†ä¸­æ–­æè¿°ç¬¦è¡¨çš„åœ°å€æ”¾åœ¨è¿™ä¸ªå¯„å­˜å™¨é‡Œã€‚</p>

<p>è¿˜è®°å¾—åˆšåˆšçœ‹çš„æºç ä¹ˆï¼Ÿä¸­æ–­æè¿°ç¬¦è¡¨å°±æ˜¯è¿™ä¸ªã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>structÂ desc_structÂ idt_table[256]Â =Â {Â {0,Â 0},Â };
</code></pre></div></div>

<p>ç„¶åæ“ä½œç³»ç»ŸæŠŠè¿™ä¸ªçš„åœ°å€ç”¨Â <strong>LIDT</strong>Â æŒ‡ä»¤æ”¾åœ¨Â <strong>IDTR å¯„å­˜å™¨</strong>å°±è¡Œäº†ã€‚IDTR å¯„å­˜å™¨é‡Œçš„å€¼ä¸€å…± 48 ä½ï¼Œå‰ 16 ä½æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨å¤§å°ï¼ˆå­—èŠ‚æ•°ï¼‰ï¼Œå 32 ä½æ˜¯ä¸­æ–­æè¿°ç¬¦è¡¨çš„èµ·å§‹å†…å­˜åœ°å€ï¼Œå°±æ˜¯è¿™ä¸ª idt_table çš„ä½ç½®ã€‚</p>

<p>Linux-2.6.0 æºç ä¸­æ˜¯è¿™æ ·æ„é€ è¿™ä¸ªç»“æ„çš„ï¼Œç®€å•ç²—æš´ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>idt_descr:Â Â Â Â .wordÂ 256Â *Â 8Â -Â 1Â Â Â Â .longÂ idt_table
</code></pre></div></div>

<p>ç´§æ¥ç€ï¼Œä¸€ä¸ª LIDT æŒ‡ä»¤æŠŠè¿™ä¸ªç»“æ„æ”¾åˆ° IDTR å¯„å­˜å™¨ä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lidtÂ idt_descr
</code></pre></div></div>

<p>æ•´ä¸ªè¿‡ç¨‹ä¸€æ°”å‘µæˆï¼Œå‘µå¾—æˆ‘è¿ä»£ç æ ¼å¼éƒ½æ‡’å¾—è°ƒäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ¸…æ™°æ˜äº†ã€‚</p>

<p>è¿™æ ·ï¼ŒCPU æ”¶åˆ°ä¸€ä¸ªä¸­æ–­å·åï¼Œ<strong>ä¸­æ–­æè¿°ç¬¦è¡¨çš„èµ·å§‹ä½ç½®ä» IDTR å¯„å­˜å™¨ä¸­å¯ä»¥çŸ¥é“ï¼Œè€Œä¸”é‡Œé¢çš„æ¯ä¸ªä¸­æ–­æè¿°ç¬¦éƒ½æ˜¯ 64 ä½å¤§å°ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªå­—èŠ‚ï¼Œé‚£è‡ªç„¶å°±å¯ä»¥æ‰¾åˆ°è¿™ä¸ªä¸­æ–­å·å¯¹åº”çš„ä¸­æ–­æè¿°ç¬¦</strong>ã€‚</p>

<p>æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªä¸­æ–­æè¿°ç¬¦è¡¨æ˜¯è°æ¥æå‰å†™å¥½çš„ï¼Ÿåˆæ˜¯æ€ä¹ˆå†™çš„ï¼Ÿ</p>

<blockquote>
  <blockquote>
    <p><strong>è°æŠŠä¸­æ–­æè¿°ç¬¦è¡¨è¿™ä¸ªç»“æ„å†™åœ¨å†…å­˜çš„</strong></p>

  </blockquote>
</blockquote>

<p>å¾ˆç®€å•ï¼Œæ“ä½œç³»ç»Ÿå‘—ã€‚</p>

<p>åœ¨ Linux-2.6.0 å†…æ ¸æºç çš„ traps.c æ–‡ä»¶ä¸­ï¼Œæœ‰è¿™æ ·ä¸€æ®µä»£ç ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>voidÂ __initÂ trap_init(void)Â {Â Â Â Â set_trap_gate(0,Â &amp;divide_error);Â Â Â Â ...Â Â Â Â set_trap_gate(6,Â &amp;invalid_op);Â Â Â Â ...Â Â Â Â set_intr_gate(14,Â &amp;page_fault);Â Â Â Â ...Â Â Â Â set_system_gate(0x80,Â &amp;system_call);}
</code></pre></div></div>

<p>ä½ çœ‹ï¼Œæˆ‘ä»¬åˆšåˆšæåˆ°çš„<strong>é™¤æ³•å¼‚å¸¸ã€éæ³•æŒ‡ä»¤å¼‚å¸¸ã€ç¼ºé¡µå¼‚å¸¸</strong>ï¼Œä»¥åŠä¹‹åå¯èƒ½é€šè¿‡ INT 0x80 è§¦å‘<strong>ç³»ç»Ÿè°ƒç”¨</strong>çš„ä¸­æ–­å¤„ç†å‡½æ•° system_callï¼Œå°±æ˜¯è¿™æ ·è¢«å†™åˆ°äº†ä¸­æ–­æè¿°ç¬¦è¡¨é‡Œã€‚</p>

<p>ç»è¿‡è¿™æ ·ä¸€ç•ªæ“ä½œåï¼Œæˆ‘ä»¬çš„ä¸­æ–­æè¿°ç¬¦è¡¨é‡Œçš„å€¼å°±ä¸°å¯Œäº†èµ·æ¥ã€‚</p>

<p>å¥½äº†ï¼Œç°åœ¨åªå‰©ä¸‹æœ€åä¸€ä¸ªé—®é¢˜äº†ï¼ŒCPU åœ¨æ‰¾åˆ°ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦åï¼Œå¦‚ä½•è·³è¿‡å»æ‰§è¡Œï¼Ÿ</p>

<blockquote>
  <blockquote>
    <p><strong>æ‰¾åˆ°ä¸­æ–­æè¿°ç¬¦åï¼Œå¹²å˜›</strong></p>

  </blockquote>
</blockquote>

<p>ç°åœ¨è¿™ä¸ªé—®é¢˜å¯ä»¥å†é—®å¾—å¤§ä¸€äº›äº†ï¼Œå°±æ˜¯Â <strong>CPU åœ¨æ”¶åˆ°ä¸€ä¸ªä¸­æ–­å·å¹¶ä¸”æ‰¾åˆ°äº†ä¸­æ–­æè¿°ç¬¦ä¹‹åï¼Œç©¶ç«Ÿåšäº†å“ªäº›äº‹</strong>ï¼Ÿ</p>

<p>å½“ç„¶ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯ï¼Œ<strong>ç›´æ¥æŠŠä¸­æ–­æè¿°ç¬¦é‡Œçš„ä¸­æ–­ç¨‹åºåœ°å€å–å‡ºæ¥ï¼Œæ”¾åœ¨è‡ªå·±çš„ CS:IP å¯„å­˜å™¨ä¸­</strong>ï¼Œå› ä¸ºè¿™é‡Œå­˜çš„å€¼å°±æ˜¯ä¸‹ä¸€è·³æŒ‡ä»¤çš„åœ°å€ï¼Œåªè¦æ”¾è¿›å»äº†ï¼Œåˆ°ä¸‹ä¸€ä¸ª CPU æŒ‡ä»¤å‘¨æœŸæ—¶ï¼Œå°±ä¼šå»é‚£é‡Œç»§ç»­æ‰§è¡Œäº†ã€‚</p>

<p>ä½† CPU å¹¶æ²¡æœ‰è¿™æ ·ç®€å•ç²—æš´ï¼Œè€Œæ˜¯å¸®åŠ©æˆ‘ä»¬ç¨‹åºå‘˜åšäº†å¥½å¤šé¢å¤–çš„äº‹æƒ…ï¼Œè¿™å¢åŠ äº†æˆ‘ä»¬çš„å­¦ä¹ å’Œç†è§£æˆæœ¬ï¼Œä½†æ–¹ä¾¿äº†å†™æ“ä½œç³»ç»Ÿçš„ç¨‹åºå‘˜ï¼Œæ‹¿åˆ°ä¸€äº›ä¸­æ–­çš„ä¿¡æ¯ï¼Œä»¥åŠä¸­æ–­ç¨‹åºç»“æŸåçš„è¿”å›å·¥ä½œã€‚</p>

<p>ä½†å…¶å®ï¼Œå°±æ˜¯åšäº†ä¸€äº›<strong>å‹æ ˆæ“ä½œ</strong>ã€‚</p>

<p><em><strong>1.</strong></em>Â å¦‚æœå‘ç”Ÿäº†ç‰¹æƒçº§è½¬ç§»ï¼Œå‹å…¥ä¹‹å‰çš„å †æ ˆæ®µå¯„å­˜å™¨ SS åŠæ ˆé¡¶æŒ‡é’ˆ ESP ä¿å­˜åˆ°æ ˆä¸­ï¼Œå¹¶å°†å †æ ˆåˆ‡æ¢ä¸º TSS ä¸­çš„å †æ ˆã€‚</p>

<p><em><strong>2.</strong></em>Â å‹å…¥æ ‡å¿—å¯„å­˜å™¨ EFLAGSã€‚</p>

<p><em><strong>3.</strong></em>Â å‹å…¥ä¹‹å‰çš„ä»£ç æ®µå¯„å­˜å™¨ CS å’ŒæŒ‡ä»¤å¯„å­˜å™¨ EIPï¼Œç›¸å½“äºå‹å…¥è¿”å›åœ°å€ã€‚</p>

<p><em><strong>4.</strong></em>Â å¦‚æœæ­¤ä¸­æ–­æœ‰é”™è¯¯ç çš„ï¼Œå‹å…¥é”™è¯¯ç  ERROR_CODE</p>

<p><em><strong>5.</strong></em>Â ç»“æŸï¼ˆä¹‹åå°±è·³è½¬åˆ°ä¸­æ–­ç¨‹åºäº†ï¼‰</p>

<p>å‹æ ˆæ“ä½œç»“æŸåï¼Œæ ˆå°±å˜æˆäº†è¿™ä¸ªæ ·å­ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>ç‰¹æƒçº§çš„è½¬ç§»éœ€è¦åˆ‡æ¢æ ˆï¼Œæ‰€ä»¥æå‰å°†ä¹‹å‰çš„<strong>æ ˆæŒ‡é’ˆ</strong>å‹å…¥ã€‚<strong>é”™è¯¯ç </strong>å¯ä»¥æ–¹ä¾¿ä¸­æ–­å¤„ç†ç¨‹åºåšä¸€äº›å·¥ä½œï¼Œå¦‚æœéœ€è¦ï¼Œä»æ ˆé¡¶æ‹¿åˆ°å°±å¥½äº†ã€‚</p>

<p>æŠ›å¼€è¿™ä¸¤è€…ä¸è¯´ï¼Œå‰©ä¸‹çš„å°±åªæœ‰<strong>æ ‡å¿—å¯„å­˜å™¨</strong>å’Œ<strong>ä¸­æ–­å‘ç”Ÿå‰çš„ä»£ç åœ°å€</strong>ï¼Œè¢«å‹å…¥äº†æ ˆï¼Œè¿™å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æ–¹ä¾¿ä¸­æ–­ç¨‹åºç»“æŸåï¼Œè¿”å›åŸæ¥çš„ä»£ç å˜›~</p>

<p>å…·ä½“çš„å‹æ ˆå·¥ä½œï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨è¿™äº›æ ˆçš„ä¿¡æ¯è¾¾åˆ°ç»“æŸä¸­æ–­å¹¶è¿”å›åŸç¨‹åºçš„æ•ˆæœï¼ŒIntel æ‰‹å†Œä¸­ä¹Ÿå†™å¾—å¾ˆæ¸…æ¥šã€‚</p>

<p><em>Volumn 3AÂ System Programming GuideÂ Â ChapterÂ 5.12.1Exception- or Interrupt-Handler Procedures</em></p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p>çœ‹ä¸‹é¢çš„è¯ï¼Œé€šè¿‡é…åˆÂ <strong>IRET</strong>Â æˆ–Â <strong>IRETD</strong>Â æŒ‡ä»¤è¿”å›ã€‚</p>

<p>ç”±äºåç»­ç‰ˆæœ¬çš„ Linux è‡ªå·±çš„ç©æ³•æ¯”è¾ƒå¤šï¼Œå·²ç»ä¸ç”¨ Intel æä¾›çš„ç°æˆæŒ‡ä»¤äº†ï¼Œæ‰€ä»¥è¿™å›æˆ‘ä»¬ä» Linux-0.11 ç‰ˆæºç ä¸­å¯»æ‰¾ç­”æ¡ˆã€‚</p>

<p>æ¯”å¦‚é™¤æ³•å¼‚å¸¸çš„ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œåœ¨ asm.s ä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_divide_error: push dword ptr _do_divide_error ;no_error_code: ; xchg [esp],eax ; push ebx push ecx push edx push edi push esi push ebp push ds ; push es push fs push 0 ; lea edx,[esp+44] ; push edx mov edx,10h ; mov ds,dx mov es,dx mov fs,dx call eax ; add esp,8 ; pop fs pop es pop ds pop ebp pop esi pop edi pop edx pop ecx pop ebx pop eax ;// å¼¹å‡ºåŸæ¥eax ä¸­çš„å†…å®¹ã€‚ iretd
</code></pre></div></div>

<p>åªçœ‹æœ€åä¸€è¡Œï¼Œç¡®å®ç”¨äº† iretd æŒ‡ä»¤ã€‚</p>

<p>è¿™ä¸ªæŒ‡ä»¤ä¼šä¾æ¬¡å¼¹å‡ºæ ˆé¡¶çš„ä¸‰ä¸ªå…ƒç´ ï¼ŒæŠŠå®ƒä»¬åˆ†åˆ«èµ‹å€¼ç»™Â <strong>EIPï¼ŒCS å’Œ EFLAGS</strong>ï¼Œè€Œæ ˆé¡¶çš„ä¸‰ä¸ªå…ƒç´ ï¼Œåˆæ°å¥½æ˜¯Â <strong>EIPï¼ŒCS å’Œ EFLAGS</strong>Â è¿™æ ·çš„é¡ºåºï¼Œä½ è¯´è¿™å·§ä¸å·§ï¼Ÿ</p>

<p>å½“ç„¶ä¸å·§ï¼Œäººå®¶ CPU æ‰§è¡Œä¸­æ–­å‡½æ•°å‰åšäº†å‹æ ˆæ“ä½œï¼Œç„¶ååˆæä¾›äº† iret æŒ‡ä»¤åšå¼¹æ ˆæ“ä½œï¼Œå½“ç„¶æ˜¯ç»™ä½ é…å¥—ä½¿ç”¨çš„ï¼</p>

<p>ä½ çœ‹ï¼Œ<strong>ä¸­æ–­æ˜¯å¦‚ä½•åˆ‡åˆ°ä¸­æ–­å¤„ç†ç¨‹åºçš„ï¼Ÿå°±æ˜¯é ä¸­æ–­æè¿°ç¬¦è¡¨ä¸­è®°å½•çš„åœ°å€ã€‚é‚£ä¸­æ–­åˆå¦‚ä½•å›åˆ°åŸæ¥çš„ä»£ç ç»§ç»­æ‰§è¡Œå‘¢ï¼Ÿæ˜¯é€šè¿‡ CPU å¸®æˆ‘ä»¬æŠŠä¸­æ–­å‘ç”Ÿå‰çš„åœ°å€å‹å…¥äº†æ ˆä¸­</strong>ï¼Œç„¶åæˆ‘ä»¬ç¨‹åºè‡ªå·±åˆ©ç”¨ä»–ä»¬å»è¿”å›ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸è¿”å›ã€‚</p>

<p>è¿™å°±æ˜¯ CPU å’Œæ“ä½œç³»ç»Ÿé…åˆçš„ç»“æœï¼ŒæŠŠä¸­æ–­è¿™ä¸ªäº‹ç»™è§£å†³äº†ã€‚</p>

<p><img src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Ctitle%3E%3C/title%3E%3Cg stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'%3E%3Cg transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'%3E%3Crect x='249' y='126' width='1' height='1'%3E%3C/rect%3E%3C/g%3E%3C/g%3E%3C/svg%3E" alt="å›¾ç‰‡" /></p>

<p><strong>æ€»ç»“</strong></p>

<p>æ‰€ä»¥æ€»ç»“èµ·æ¥å°±æ˜¯ï¼Œç†è§£ä¸­æ–­ï¼Œåªè¦å›ç­”äº†è¿™å‡ ä¸ªé—®é¢˜å°±å¥½ã€‚</p>

<p><strong>å¦‚ä½•ç»™ CPU ä¸€ä¸ªä¸­æ–­å·ï¼Ÿ</strong></p>

<p>å¤–éƒ¨è®¾å¤‡é€šè¿‡ INTR å¼•è„šï¼Œæˆ–è€… CPU æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹ä¸­è‡ªå·±è§¦å‘ï¼Œæˆ–è€…ç”±è½¯ä»¶é€šè¿‡ INT n æŒ‡ä»¤å¼ºè¡Œè§¦å‘ã€‚</p>

<p>åŒæ ·ä¸­æ–­ä¹Ÿæ˜¯è¿™æ ·è¿›è¡Œåˆ†ç±»çš„ã€‚</p>

<p><strong>CPU æ”¶åˆ°ä¸­æ–­å·åå¦‚ä½•å¯»æ‰¾åˆ°ä¸­æ–­ç¨‹åºçš„å…¥å£åœ°å€ï¼Ÿ</strong></p>

<p>é€šè¿‡ IDTR å¯„å­˜å™¨æ‰¾åˆ°ä¸­æ–­æè¿°ç¬¦è¡¨ï¼Œé€šè¿‡ä¸­æ–­æè¿°ç¬¦è¡¨å’Œä¸­æ–­å·å®šä½åˆ°ä¸­æ–­æè¿°ç¬¦ï¼Œå–å‡ºä¸­æ–­æè¿°ç¬¦è¡¨ä¸­å­˜å‚¨çš„ç¨‹åºå…¥å£åœ°å€ã€‚</p>

<p><strong>ä¸­æ–­æè¿°ç¬¦è¡¨æ˜¯è°å†™çš„ï¼Ÿ</strong></p>

<p>æ“ä½œç³»ç»Ÿä»£ç å†™ä¸Šå»çš„ã€‚</p>

<p><strong>æ‰¾åˆ°ç¨‹åºå…¥å£åœ°å€ä¹‹åï¼ŒCPU åšäº†ä»€ä¹ˆï¼Ÿ</strong></p>

<p>ç®€å•è¯´ï¼Œå®é™…ä¸Šåšçš„äº‹æƒ…å°±æ˜¯å‹æ ˆï¼Œå¹¶è·³è½¬åˆ°å…¥å£åœ°å€å¤„æ‰§è¡Œä»£ç ã€‚è€Œå‹æ ˆçš„ç›®çš„ï¼Œå°±æ˜¯ä¿æŠ¤ç°åœºï¼ˆåŸæ¥çš„ç¨‹åºåœ°å€ã€åŸæ¥çš„ç¨‹åºå †æ ˆã€åŸæ¥çš„æ ‡å¿—ä½ï¼‰å’Œä¼ é€’ä¿¡æ¯ï¼ˆé”™è¯¯ç ï¼‰</p>

<p>å¥½äº†ï¼Œä¸­æ–­è®²å®Œäº†ï¼Œå¦‚æœå†å¾€åæ‰©å¤§ä¸€ç‚¹ç‚¹æ¦‚å¿µï¼Œä»¥ä¸Šè¯´çš„ä¸­æ–­ï¼Œç»Ÿç»Ÿéƒ½æ˜¯<strong>ç¡¬ä¸­æ–­</strong>ã€‚æ³¨æ„ï¼Œä¸å«ç¡¬ä»¶ä¸­æ–­å“¦ã€‚</p>

<p>ä¸ºä»€ä¹ˆå«ç¡¬ä¸­æ–­å‘¢ï¼Ÿå› ä¸ºè¿™æ˜¯ Intel CPU è¿™ä¸ªç¡¬ä»¶å®ç°çš„ä¸­æ–­æœºåˆ¶ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å®ç°æœºåˆ¶ï¼Œå¹¶ä¸æ˜¯è§¦å‘æœºåˆ¶ï¼Œå› ä¸ºè§¦å‘å¯ä»¥é€šè¿‡å¤–éƒ¨ç¡¬ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è½¯ä»¶çš„ INT æŒ‡ä»¤ã€‚</p>

<p>é‚£ä¸ç¡¬ä¸­æ–­å¯¹åº”çš„è¿˜æœ‰<strong>è½¯ä¸­æ–­</strong>ï¼Œè¿™ä¸ªæ¦‚å¿µç½‘ä¸Šå¥½å¤šåœ°æ–¹éƒ½è®²é”™äº†ï¼ŒæŠŠè½¯ä¸­æ–­å’Œ INT æŒ‡ä»¤è¿™ç§è½¯ä»¶ä¸­æ–­æ··æ·†äº†ï¼Œ<strong>æ‰€ä»¥æˆ‘è§‰å¾—è½¯ä»¶ä¸­æ–­æœ€å¥½ç§°å…¶ä¸ºï¼Œç”±è½¯ä»¶è§¦å‘çš„ä¸­æ–­ï¼Œè€Œè½¯ä¸­æ–­ç§°å…¶ä¸ºè½¯ä»¶å®ç°çš„ä¸­æ–­</strong>ã€‚</p>

<p><strong>è½¯ä¸­æ–­æ˜¯çº¯ç²¹ç”±è½¯ä»¶å®ç°çš„ä¸€ç§ç±»ä¼¼ä¸­æ–­çš„æœºåˆ¶</strong>ï¼Œå®é™…ä¸Šå®ƒå°±æ˜¯æ¨¡ä»¿ç¡¬ä»¶ï¼Œåœ¨å†…å­˜ä¸­æœ‰ä¸€ä¸ªåœ°æ–¹å­˜å‚¨ç€è½¯ä¸­æ–­çš„æ ‡å¿—ä½ï¼Œç„¶åç”±å†…æ ¸çš„ä¸€ä¸ªçº¿ç¨‹ä¸æ–­è½®è¯¢è¿™äº›æ ‡å¿—ä½ï¼Œå¦‚æœæœ‰å“ªä¸ªæ ‡å¿—ä½æœ‰æ•ˆï¼Œåˆ™å†å»å¦ä¸€ä¸ªåœ°æ–¹å¯»æ‰¾è¿™ä¸ªè½¯ä¸­æ–­å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚</p>

<p>è½¯ä¸­æ–­æ˜¯ Linux å®ç°ä¸­æ–­çš„<strong>ä¸‹åŠéƒ¨</strong>çš„ä¸€ç§éå¸¸å¸¸è§çš„æ–¹å¼ï¼Œä¹‹åæˆ‘è®² Linux å†…æ ¸å¦‚ä½•æ¥å—ç½‘ç»œåŒ…è¿™ä¸ªäº‹æƒ…çš„æ—¶å€™ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè½¯ä¸­æ–­æ˜¯ç ”ç©¶æ•´ä¸ªè¿‡ç¨‹çš„ä¸€ä¸ªçªç ´å£ã€‚</p>

<ul>
  <li>EOF -</li>
</ul>

<p>æ¨èé˜…è¯»Â Â ç‚¹å‡»æ ‡é¢˜å¯è·³è½¬</p>

<p>1ã€<a href="http://mp.weixin.qq.com/s?__biz=MzAxODI5ODMwOA==&amp;mid=2666558962&amp;idx=1&amp;sn=ede9eea879107df21557e1b9dcfeeb28&amp;chksm=80dcb159b7ab384f22e68fc32d5556afd3e98c29d08757a871582d526bf5985b0c7c3fd3ec6d&amp;scene=21#wechat_redirect">10 åˆ†é’Ÿçœ‹æ‡‚ Docker å’Œ K8S</a></p>

<p>2ã€<a href="http://mp.weixin.qq.com/s?__biz=MzAxODI5ODMwOA==&amp;mid=2666558647&amp;idx=1&amp;sn=f9f02d09c89ec081c61a717b3724b7fd&amp;chksm=80dcb01cb7ab390a0d89664294542d564e7cc4d539cc6dc30ef997158d1b1ac496a21a991407&amp;scene=21#wechat_redirect">è¿™æ‰æ˜¯ä¸­å›½è¢«å¡è„–å­æœ€ä¸¥é‡çš„è½¯ä»¶ï¼</a></p>

<p>3ã€<a href="http://mp.weixin.qq.com/s?__biz=MzAxODI5ODMwOA==&amp;mid=2666558954&amp;idx=2&amp;sn=775617c1787bb8ab5251444c8762cd44&amp;chksm=80dcb141b7ab38576e44e8149b6f64aab5812d557f7f50a6b8543b375c7a67acac0fe75f00ac&amp;scene=21#wechat_redirect">å¦‚æœè®©ä½ æ¥è®¾è®¡ç½‘ç»œï¼Œä½ ä¼šæŠŠå®ƒå¼„æˆå•¥æ ·ï¼Ÿ</a></p>

<p>çœ‹å®Œæœ¬æ–‡æœ‰æ”¶è·ï¼Ÿè¯·åˆ†äº«ç»™æ›´å¤šäºº</p>

<p>æ¨èå…³æ³¨ã€ŒLinux çˆ±å¥½è€…ã€ï¼Œæå‡LinuxæŠ€èƒ½</p>

<p><img src="http://mmbiz.qpic.cn/mmbiz_png/9aPYe0E1fb3sjicd8JxDra10FRIqT54Zke2sfhibTDdtdnVhv5Qh3wLHZmKPjiaD7piahMAzIH6Cnltd1Nco17Ihjw/0?wx_fmt=png" alt="" /></p>

<p><strong>Linuxçˆ±å¥½è€…</strong></p>

<p>ç‚¹å‡»è·å–ã€Šæ¯å¤©ä¸€ä¸ªLinuxå‘½ä»¤ã€‹ç³»åˆ—å’Œç²¾é€‰LinuxæŠ€æœ¯èµ„æºã€‚ã€ŒLinuxçˆ±å¥½è€…ã€æ—¥å¸¸åˆ†äº« Linux/Unix ç›¸å…³å†…å®¹ï¼ŒåŒ…æ‹¬ï¼šå·¥å…·èµ„æºã€ä½¿ç”¨æŠ€å·§ã€è¯¾ç¨‹ä¹¦ç±ç­‰ã€‚</p>

<p>75ç¯‡åŸåˆ›å†…å®¹</p>

<p>å…¬ä¼—å·</p>

<p>ç‚¹èµå’Œåœ¨çœ‹å°±æ˜¯æœ€å¤§çš„æ”¯æŒâ¤ï¸</p>

<p>åˆ†äº«æ”¶è—</p>

<p><img src="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=102&amp;__biz=MzAxODI5ODMwOA==&amp;mid=2666559053&amp;idx=2&amp;sn=cdd9e3e14102740664c93bfe99bb0044&amp;send_time=" alt="" /></p>

<p>å¾®ä¿¡æ‰«ä¸€æ‰«<br />
å…³æ³¨è¯¥å…¬ä¼—å·</p>]]></content><author><name>Tao He</name></author><category term="Jekyll" /><summary type="html"><![CDATA[ã€è½¬å¸–ã€‘]]></summary></entry><entry><title type="html">Weston</title><link href="http://localhost:4000/blog/jekyll/2019-01-11-Weston.html" rel="alternate" type="text/html" title="Weston" /><published>2019-01-11T00:00:00+08:00</published><updated>2019-01-11T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/Weston</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2019-01-11-Weston.html"><![CDATA[<h1 id="1-å¯åŠ¨weston">1. å¯åŠ¨Weston</h1>

<h2 id="11-å®ç°å†…å®¹">1.1 å®ç°å†…å®¹</h2>

<ol>
  <li>è§£æcmdline</li>
  <li>åˆå§‹åŒ–logç³»ç»Ÿ</li>
  <li>åˆ›å»ºwl_displayå¯¹è±¡ï¼Œå¹¶<strong>ä¾¦å¬clientæ¥å…¥</strong></li>
  <li>åˆ›å»ºweston_compositorå¯¹è±¡ï¼Œä»è€Œåˆ›å»ºglobal resource <strong>compositor</strong> å’Œ <strong>shm</strong>ï¼Œ ä»¥å‰å…¶ä»–èµ„æº</li>
  <li><strong>load backend</strong>ï¼Œ é»˜è®¤ä¸ºdrm_backend, åœ¨drm_backendåˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼š<strong>load gl_renderer</strong></li>
  <li><strong>load shell</strong>, é»˜è®¤ä¸ºdesktop-shell.so</li>
  <li>è°ƒç”¨wl_display_run( ) <strong>å¾ªç¯ç­‰å¾…eventçš„å‘ç”Ÿ</strong></li>
</ol>

<h2 id="12-ä¼ªä»£ç ">1.2 ä¼ªä»£ç </h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">wet_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">weston_testsuite_data</span> <span class="o">*</span><span class="n">test_data</span><span class="p">){</span>

    <span class="c1">// åˆå§‹åŒ– layoutput_list</span>
    <span class="n">wl_list_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wet</span><span class="p">.</span><span class="n">layoutput_list</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="c1">//  parse command line</span>
    <span class="p">...</span>
    <span class="c1">//  init log system</span>
    <span class="p">...</span>
    
    <span class="c1">// è°ƒç”¨waylandæä¾›çš„å‡½æ•°wl_display_create()</span>
    <span class="c1">// åˆ›å»º wl_display å¯¹è±¡</span>
    <span class="n">display</span> <span class="o">=</span> <span class="n">wl_display_create</span><span class="p">();</span>
    <span class="p">...</span>
    
    <span class="c1">// åˆ›å»º weston_compositor å¯¹è±¡  </span>
    <span class="c1">// --&gt; åˆ›å»º global resource compositor and shm ä»¥åŠå…¶ä»–resource</span>
    <span class="n">weston_compositor_create</span><span class="p">(</span> <span class="p">);</span>    
    <span class="c1">// è¯»å–config for compositor</span>
    <span class="p">...</span>
    
    <span class="c1">// load backendï¼Œé€šç”¨çš„ä¸ºload_drm_backend( )</span>
    <span class="c1">// æœ€ç»ˆè°ƒç”¨ å¯¹åº”backendå®ç°çš„weston_backend_init( )</span>
    <span class="c1">// åœ¨backend åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ä¼šè£…è½½ gl_renderer</span>
    <span class="n">load_backend</span><span class="p">(</span><span class="n">compositor</span><span class="p">,</span> <span class="n">backend</span><span class="p">)</span>
    <span class="p">...</span>
    
    <span class="c1">// åˆ›å»ºsocketï¼Œ ä¾¦å¬clientçš„è¿æ¥è¯·æ±‚</span>
    <span class="n">weston_create_listening_socket</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">socket_name</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="c1">// load shell, é»˜è®¤ä¸º desktop-shell.so</span>
    <span class="n">wet_load_shell</span><span class="p">(</span><span class="n">compositor</span><span class="p">,</span> <span class="n">shell</span><span class="p">,</span> <span class="p">...)</span>
    <span class="p">...</span>
    <span class="c1">// loop, å¾ªç¯ç­‰å¾…eventçš„å‘ç”Ÿ</span>
    <span class="n">wl_display_run</span><span class="p">(</span><span class="n">display</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="c1">// é€€å‡ºæµç¨‹ï¼Œèµ„æºçš„é‡Šæ”¾</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="13-backend-renderer-shellçš„ä½œç”¨">1.3 backend, renderer, shellçš„ä½œç”¨</h2>

<p>ç»“æ„å›¾</p>

<p><img src="/blog/assets/wayland/image-20230209140244854.png" alt="image" /></p>

<p>backend</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
 <span class="n">destroy</span><span class="p">()</span>
 <span class="n">repaint_begin</span><span class="p">()</span>   <span class="c1">//compositeä¹‹å‰è°ƒç”¨</span>
 <span class="n">repaint_cancel</span><span class="p">()</span>  <span class="c1">// ä¸­é€”å–æ¶ˆ</span>
 <span class="n">repaint_flush</span><span class="p">()</span>   <span class="c1">// composite å®Œæˆåè°ƒç”¨ï¼Œ å¯ç”¨äºå®ç°æäº¤åˆ°display</span>
 <span class="n">create_output</span><span class="p">()</span>   <span class="c1">// åˆ›å»ºweston_output</span>
 <span class="n">device_changed</span><span class="p">()</span>
 <span class="n">can_scanout_dmabuf</span><span class="p">()</span>
<span class="p">}</span><span class="n">Weston_backend</span><span class="p">,</span> <span class="n">Compositor</span><span class="o">-&gt;</span><span class="n">backend</span>

</code></pre></div></div>

<p>renderer: 
rendereræ¥å£ä¾›backendå†…éƒ¨ä½¿ç”¨ï¼Œå¤–éƒ¨é€šè¿‡è°ƒç”¨backendæ¥å£è§¦å‘</p>
<pre><code class="language-C">{
   display_create()
   output_window_create()
   output_pbuffer_create()
   output_destroy()
   output_set_border()
   create_fence_fd()
} gl_renderer_interface
</code></pre>

<h1 id="2-client-åŠ¨ä½œ">2. Client åŠ¨ä½œ</h1>

<h2 id="21-clientçš„æ¥å…¥å’Œglobalèµ„æºä»£ç†çš„åˆ›å»º">2.1 Clientçš„æ¥å…¥å’Œglobalèµ„æºä»£ç†çš„åˆ›å»º</h2>

<h3 id="æµç¨‹">æµç¨‹</h3>
<ol>
  <li>è¿æ¥display</li>
  <li>è·å¾—registryï¼Œæ³¨å†Œlistenerï¼Œç”¨äºå¤„ç†westonèµ„æºå˜åŒ–æ—¶çš„callback</li>
  <li>æ ¹æ®èµ„æºå˜åŒ–çš„callbackï¼Œ åˆ›å»ºå„ç±»èµ„æºçš„proxy</li>
  <li>è¿›å…¥loopï¼Œä¸æ–­è°ƒç”¨wl_display_dispatch( )ï¼Œä½¿å¾—waylandå†…éƒ¨å¾ªç¯å¤„ç†å„ç±»event</li>
</ol>

<h3 id="ä¼ªä»£ç ">ä¼ªä»£ç </h3>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">global_resource_found</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl_registry</span><span class="o">*</span> <span class="n">registry</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">interface</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// é€šè¿‡å­—ç¬¦ä¸²interface åˆ¤æ–­æ˜¯ä»€ä¹ˆresourceï¼Œ</span>
    <span class="c1">// é€šè¿‡wl_registry_bind() åˆ›å»ºå¯¹åº”çš„ resource proxy</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="s">"wl_compositor"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ„å»ºäº† compositor çš„ proxy    </span>
        <span class="n">compositor</span> <span class="o">=</span> <span class="n">wl_registry_bind</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl_compositor_interface</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
        
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="s">"wl_shm"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ„å»ºäº† shm çš„proxy</span>
        <span class="n">shm</span> <span class="o">=</span> <span class="n">wl_registry_bind</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl_shm_interface</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>

<span class="p">}</span>

<span class="c1">// å½“westonçš„global resoureå‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šè¿‡å¦‚ä¸‹å›è°ƒå‡½æ•°é€šçŸ¥åˆ°client</span>
<span class="n">wl_registry_listener</span> <span class="n">registry_listener</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// å‘ç°æ–°global resourceçš„å›è°ƒå‡½æ•°</span>
    <span class="n">global_resource_found</span><span class="p">,</span>
    <span class="c1">// global resource removeçš„å›è°ƒå‡½æ•°</span>
    <span class="n">global_resource_remove</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 1. è°ƒç”¨waylandæä¾›çš„ wl_display_connect( ), è¿æ¥åˆ°weston( wayland server)</span>
    <span class="c1">//    å¯¹åº”åˆ°westonå¯åŠ¨ä¸­çš„weston_create_listening_socket()</span>
    <span class="n">display</span> <span class="o">=</span> <span class="n">wl_display_connect</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">...</span>
    
    <span class="c1">// 2. è·å– wl_registry, å¹¶ä¾¦å¬å®ƒçš„callback</span>
    <span class="n">registry</span><span class="o">=</span> <span class="n">wl_display_get_registry</span><span class="p">(</span><span class="n">display</span><span class="p">);</span>
    <span class="n">wl_registry_add_listener</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">registry_listener</span><span class="p">,</span> <span class="n">display</span><span class="p">);</span>
    <span class="p">...</span>
    
    <span class="c1">// 3. å¾ªç¯ç­‰å¾…ï¼Œ</span>
    <span class="c1">//    è°ƒç”¨wl_display_dispatch( )ï¼Œç”±waylandå¤„ç†westonå‘æ¥çš„event</span>
    <span class="k">while</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">wl_display_dispatch</span><span class="p">(</span> <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="22-å†…éƒ¨weston---client-é€šè®¯æœºåˆ¶">2.2 å†…éƒ¨weston - client é€šè®¯æœºåˆ¶</h2>

<p><mark>request</mark>:  Client â€“&gt; Server</p>

<p><mark>event</mark>  :  Server â€“&gt; Client</p>

<p>æœ¯è¯­ä¸Šï¼ŒWayland ä¸­æŠŠ Client å‘ç»™ Server çš„è·¨è¿›ç¨‹å‡½æ•°è°ƒç”¨ç§°ä¸º requestï¼Œåæ–¹å‘çš„è·¨è¿›ç¨‹å‡½æ•°è°ƒç”¨ç§°ä¸º eventã€‚ æœ¬è´¨ä¸Šï¼Œå®ƒä»¬å¤„ç†çš„æ–¹å¼æ˜¯ç±»ä¼¼çš„ã€‚</p>

<p>è¦è®©ä¸¤ä¸ªè¿›ç¨‹é€šè¿‡ socket è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œé¦–å…ˆéœ€è¦å°†è°ƒç”¨æŠ½è±¡æˆæ•°æ®æµçš„å½¢å¼ã€‚è¿™ä¸ªæ•°æ®æµåº”è¯¥åŒ…å«å‡½æ•°åã€å‚æ•°ç­‰ä¿¡æ¯ã€‚</p>

<p>RPC å‡½æ•°çš„æ¥å£å®šä¹‰æ˜¯åº”è¯¥åŒæ—¶åŒ…å«åœ¨ Client å’Œ Server ç«¯çš„åº“ä¸­çš„ï¼Œå…¶ä¸­åŒ…å«äº†æ¥å£å¯¹è±¡æ‰€æ”¯æŒçš„ request å’Œ event çš„å‡½æ•°ç­¾åã€‚å› æ­¤è¿™éƒ¨åˆ†ä¸ç”¨ä¼ è¾“ï¼Œåªè¦ä¼ è¾“ç›®æ ‡<strong>å¯¹è±¡ id</strong>ï¼Œ<strong>æ–¹æ³• id</strong> å’Œ<strong>å‚æ•°åˆ—è¡¨</strong>è¿™äº›ä¿¡æ¯å°±å¯ä»¥äº†ã€‚</p>

<p>è¿™äº›ä¿¡æ¯ä¼šé€šè¿‡ wl_closure_marshal()å†™å…¥ wl_closure ç»“æ„ï¼Œå†ç”± serialize_closure()å˜æˆæ•°æ®æµã€‚</p>

<p>ç­‰åˆ°äº†ç›®æ ‡è¿›ç¨‹åï¼Œ ä¼šä»æ•°æ®æµé€šè¿‡ wl_connection_demarshal()è½¬å› wl_closureã€‚</p>

<h3 id="rpc-å›¾ç¤º">RPC å›¾ç¤º</h3>
<p><img src="/blog/assets/wayland/image-20230210145327279.png" alt="image-20230210145327279.png" /></p>

<h3 id="object-rpc-æœºåˆ¶">object RPC æœºåˆ¶</h3>

<p>è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äº Android ä¸­çš„ Parcel æœºåˆ¶ã€‚é‚£ä¹ˆ é—®é¢˜æ¥äº†ï¼Œå‚æ•°ä¸­çš„æ•´å½¢ï¼Œå­—ç¬¦ä¸²ä»€ä¹ˆçš„éƒ½å¥½æï¼Œæ‹·è´å°±è¡Œã€‚ä½†å¦‚æœå‚æ•°ä¸­åŒ…å«å¯¹è±¡ï¼Œæˆ‘ä»¬ä¸èƒ½æŠŠæ•´ä¸ªå¯¹è±¡ æ‹·è´è¿‡å»ï¼Œä¹Ÿä¸èƒ½ä¼ å¼•ç”¨è¿‡å»ã€‚é‚£ä¹ˆéœ€è¦ä¸€ç§æœºåˆ¶æ¥ä½œ<strong>åŒä¸€å¯¹è±¡åœ¨ Server å’Œ Client ç«¯çš„æ˜ å°„</strong>ï¼Œè¿™æ˜¯é€šè¿‡ wl_map å®ç°çš„ã€‚</p>

<p>wl_map åœ¨ Client å’Œ Server ç«¯å„æœ‰ä¸€ä¸ªï¼Œå®ƒä»¬åˆ†åˆ«å­˜äº† wl_proxy å’Œ wl_resource çš„æ•°ç»„ï¼Œä¸”æ˜¯ ä¸€ä¸€å¯¹åº”çš„ã€‚è¿™äº›å¯¹è±¡åœ¨è¿™ä¸ªæ•°ç»„ä¸­çš„ç´¢å¼•ä½œä¸ºå®ƒä»¬çš„ idã€‚è¿™æ ·ï¼Œå‚æ•°ä¸­çš„å¯¹è±¡åªè¦ä¼  idï¼Œè¿™ä¸ª id è¢«ä¼ åˆ°ç›® çš„åœ°åä¼šé€šè¿‡æŸ¥æ‰¾è¿™ä¸ª wl_map è¡¨æ¥å¾—åˆ°æœ¬åœ°ç›¸åº”çš„å¯¹è±¡ã€‚åœ¨åŠŸèƒ½ä¸Šç±»ä¼¼äº Android ä¸­çš„ BpXXX å’Œ BnXXXã€‚</p>

<p>wl_proxy å’Œ wl_resource éƒ½åŒ…å« wl_object å¯¹è±¡ã€‚è¿™ä¸ª wl_object å’Œé¢å‘å¯¹è±¡è¯­è¨€é‡Œçš„å¯¹è±¡æ¦‚å¿µç±»ä¼¼ï¼Œå®ƒæœ‰ interface æˆå‘˜æè¿°äº†è¿™ä¸ªå¯¹è±¡æ‰€å®ç°çš„æ¥å£ï¼Œimplementation æ˜¯è¿™äº›æ¥å£çš„å®ç°å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œid å°±æ˜¯ åœ¨ wl_map ç»“æ„é‡Œæ•°ç»„ä¸­çš„ç´¢å¼•ã€‚</p>

<p>å‰é¢æ‰€è¯´çš„ Client ç»‘å®š Server ç«¯èµ„æºçš„è¿‡ç¨‹å°±æ˜¯åœ¨ Client ç«¯åˆ›å»º wl_proxyï¼Œ åœ¨ Server ç«¯åˆ›å»º wl_resourceã€‚ç„¶å Client å°±å¯ä»¥é€šè¿‡ wl_proxy è°ƒç”¨ Server ç«¯å¯¹åº” wl_resource çš„ requestï¼Œ Server ç«¯å°±å¯ä»¥é€šè¿‡ wl_resource è°ƒç”¨ Client ç«¯å¯¹åº” wl_proxy çš„ eventã€‚</p>

<p>è¿™ä¸ªæ˜ å°„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º(ä»¥ wl_registry ä¸ºä¾‹)</p>

<p><img src="/blog/assets/wayland/20141019204223671.png" alt="image" /></p>

<h2 id="23-client-åˆ›å»ºå„ç±»èµ„æºproxy">2.3 Client åˆ›å»ºå„ç±»èµ„æºproxy</h2>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// wl_surface</span>
<span class="n">wl_surface</span> <span class="o">=</span> <span class="n">wl_compositor_create_surface</span><span class="p">(</span><span class="n">compositor</span><span class="p">)</span>

<span class="c1">// wl_buffer</span>
<span class="n">wl_shm_pool</span> <span class="o">=</span> <span class="n">wl_shm_create_pool</span><span class="p">(</span> <span class="p">)</span>
<span class="n">wl_buffer</span> <span class="o">=</span> <span class="n">wl_shm_pool_create_buffer</span><span class="p">(</span> <span class="p">)</span>

<span class="c1">// attach buffer to surface</span>
<span class="n">wl_surface_attach</span><span class="p">(</span><span class="n">wl_surface</span><span class="p">,</span> <span class="n">wl_buffer</span><span class="p">)</span>

<span class="cm">/* ä»¥ä¸‹ä¸çª—å£çš„ç®¡ç†\æ˜¾ç¤ºç›¸å…³ */</span>

<span class="c1">// xdg_surface</span>
<span class="c1">// xdg_wm_base å®ƒä¹Ÿæ˜¯ä¸€ä¸ªglobal resouceï¼Œå¯¹åº”åˆ° desktop-shell</span>
<span class="n">xdg_surface</span> <span class="o">=</span> <span class="n">xdg_wm_base_get_xdg_surface</span><span class="p">(</span><span class="n">xdg_wm_base</span><span class="p">,</span> <span class="n">wl_surface</span><span class="p">)</span>

<span class="c1">// xdg_toplevel</span>
<span class="n">xdg_toplevel</span> <span class="o">=</span> <span class="n">xdg_surface_get_toplevel</span><span class="p">(</span><span class="n">xdg_toplevel</span><span class="p">)</span>

<span class="c1">// wl_keyboard</span>
<span class="c1">// wl_seat æ˜¯ä¸€ä¸ªglobal resource</span>
<span class="c1">// é€šè¿‡wl_keyboard åˆ›å»ºä¸€ä¸ªlistenerå°±å¯æ¥æ”¶æŒ‰é”®</span>
<span class="n">wl_keyboard</span> <span class="o">=</span> <span class="n">wl_seat_get_keyboard</span><span class="p">(</span><span class="n">wl_seat</span><span class="p">)</span>
<span class="n">wl_keyboard_add_listener</span><span class="p">(</span><span class="n">wl_keyboard</span><span class="p">,</span> <span class="n">keyboard_listener</span><span class="p">)</span>

<span class="c1">// wl_pointer é¼ æ ‡æŒ‡é’ˆ</span>
<span class="c1">// é€šè¿‡wl_pointer åˆ›å»ºä¸€ä¸ªlistenerå¯ä»¥æ¥æ”¶é¼ æ ‡çš„ç§»åŠ¨ä¿¡æ¯</span>
<span class="n">wl_pointre</span> <span class="o">=</span> <span class="n">wl_seat_get_pointer</span><span class="p">(</span><span class="n">wl_weat</span><span class="p">)</span>
<span class="n">wl_pointer_add_listener</span><span class="err">ï¼ˆ</span><span class="n">wl_pointer</span><span class="p">,</span> <span class="n">pointer_listener</span><span class="p">)</span>

<span class="p">...</span> <span class="p">...</span>

</code></pre></div></div>

<h2 id="24-client-æ¸²æŸ“">2.4 Client æ¸²æŸ“</h2>

<p>ä¼ªä»£ç 
simple-egl.c</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*-------------------- egl åˆå§‹åŒ–å·¥ä½œ ------------------------*/</span>

<span class="c1">// egl lib åº”è¯¥è¦æ”¯æŒwaylandã€‚</span>
<span class="c1">// è¿™æ ·åœ¨è°ƒç”¨ä¸€äº›eglæ¥å£æ—¶ï¼Œåœ¨å…¶å†…éƒ¨ä¼šè°ƒç”¨waylandæ¥å£ä¸Wayland serveräº¤æ¢ä¿¡æ¯</span>
<span class="c1">// å¦‚å‡½æ•°ï¼šeglGetDisplay( ) , eglCreateWindowSurface( )ï¼Œ eglSwapBuffers ç­‰</span>

<span class="c1">// 1. è·å–egl_display</span>
<span class="n">egl_display</span> <span class="o">=</span> <span class="n">weston_platform_get_egl_display</span><span class="p">(</span><span class="n">EGL_PLATFORM_WAYLAND_KHR</span><span class="p">,</span> <span class="n">wl_display</span><span class="p">,</span> <span class="p">...)</span>
<span class="n">or</span>
<span class="n">egl_display</span> <span class="o">=</span> <span class="n">eglGetDisplay</span><span class="p">(</span><span class="n">wl_display</span><span class="p">)</span>

<span class="c1">// 2. åˆå§‹åŒ– egl</span>
<span class="n">eglInitialize</span><span class="p">(</span><span class="n">egl_display</span><span class="p">)</span>

<span class="c1">// 3. é€šç”¨elg é…ç½®</span>
<span class="n">eglGetConfigs</span><span class="p">()</span>
<span class="n">eglChooseConfig</span><span class="p">(</span> <span class="p">)</span>
<span class="n">eglCreateContext</span><span class="p">(</span> <span class="p">)</span>


<span class="cm">/* ----------------------gl å‡†å¤‡å·¥ä½œ------------------------------*/</span>

<span class="c1">// 1.åˆ›å»º shader</span>
<span class="n">glCreateShader</span><span class="p">(</span> <span class="p">)</span>
<span class="c1">// 2.åˆ›å»º Program</span>
<span class="n">glCreateProgram</span><span class="p">(</span> <span class="p">)</span>
<span class="c1">// 3. attach shader to program</span>
<span class="n">glAttachShader</span><span class="p">(</span> <span class="p">)</span>
<span class="c1">// 4. Link program</span>
<span class="n">glLinkProgram</span><span class="p">(</span> <span class="p">)</span>
<span class="c1">// 5. ä½¿ç”¨program</span>
<span class="n">glUseProgram</span><span class="p">(</span> <span class="p">)</span>

<span class="cm">/*-------------------------wl_surface å…³è”egl_surface----------------*/</span>
<span class="n">wl_egl_window</span><span class="o">-&gt;</span><span class="n">surface</span> <span class="o">=</span> <span class="n">wl_surface</span><span class="p">;</span>
<span class="n">wl_egl_window</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
<span class="n">wl_egl_window</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
<span class="n">eglCreateWindowSurface</span><span class="p">(</span><span class="n">egl_display</span><span class="p">,</span> <span class="p">...</span> <span class="p">,</span> <span class="n">wl_egl_window</span><span class="p">)</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="n">gl</span> <span class="err">ç»˜åˆ¶å›¾å½¢</span>
<span class="cm">/*-------------------------------------------------------------------*/</span>

<span class="c1">// å†…éƒ¨å®ç°åº”è¯¥è°ƒç”¨waylandæ¥å£æ¥swap buffer</span>
<span class="n">eglSwapBuffers</span><span class="p">(</span><span class="n">egl_display</span><span class="p">,</span> <span class="n">egl_surface</span><span class="p">)</span>
<span class="p">...</span>
</code></pre></div></div>

<h2 id="25-client-æäº¤æ¸²æŸ“å¥½çš„surface">2.5. Client æäº¤æ¸²æŸ“å¥½çš„surface</h2>

<p>wl_surface_commit( )</p>

<h1 id="3-å„ä¸ªsurfaceçš„åˆæˆä¸å‘ˆç°å‘ˆç°">3. å„ä¸ªSurfaceçš„åˆæˆä¸å‘ˆç°å‘ˆç°Â·</h1>

<h2 id="31-æµç¨‹">3.1 æµç¨‹</h2>
<ol>
  <li>compositoréå†æ¯ä¸ªweston_output å‘èµ·repaintã€‚weston_output_schedule_repaint( )</li>
  <li>é€šçŸ¥weston_outputå…·ä½“å®ç°â€“backend_output, å¼€å§‹repaintçš„å‰æœŸå‡†å¤‡å·¥ä½œ, å¯¹åº”å‡½æ•°start_repaint_loop( )ï¼Œ drmå®ç°æš‚æ— å†…å®¹</li>
  <li>backend_outputé€šçŸ¥compositorå¯ä»¥å¼€å§‹output repaint</li>
  <li>compositor è°ƒç”¨weston_outputç›¸å…³backendçš„repaint_begin( )ï¼Œdrm_backend åˆ›å»ºäº†pending_state</li>
  <li>compoistor è°ƒç”¨weston_output_repaint(), å¼€å§‹repaintã€‚
 è°ƒç”¨weston_compositor_build_view_list( ) æ„å»ºview_list, å¾—åˆ°outputçš„ä¸€ä¸ªpaint_node_z_order_list</li>
  <li>è°ƒç”¨drm_backend  assign_planes( ) è®¾ç½®è¾“å‡ºplane</li>
  <li>è°ƒç”¨drm_backend  drm_output_repaint( ), æœ€ç»ˆæŒ‡å‘gl_renderer_repaint_output( )</li>
  <li>ä¾æ®paint_node_z_order_list, OpenGLä¾æ¬¡å»ºç«‹shaderï¼Œtextureç­‰è¿›è¡Œæ¸²æŸ“</li>
  <li>å…¨éƒ¨å®Œæˆåï¼Œæäº¤å‘ˆç°</li>
</ol>

<pre><code class="language-mermaid">sequenceDiagram
participant C as Compositor
participant O as Weston_output
participant B as Backend

loop éå†weston_output_list
    C -&gt;&gt; O: è¦å¼€å§‹repaint_loop &lt;br /&gt;call backend_output start_repaint_loop( )    
    C -&gt;&gt; B: repaint_begin( )
    Note right of B: åˆ›å»º pending_state
    C -&gt;&gt; O: é€šçŸ¥output repaint
    O -&gt;&gt; C: æ„å»ºview_list, build_view_list( )
    Note left of C:æ„å»ºpaint_node_z_order_list

    C -&gt;&gt; B: assign_planes( ),è®¾ç½®è¾“å‡ºplane
    C -&gt;&gt; B: drm_output_repaint( )
    Note right of B: è°ƒç”¨OpenGL API &lt;br/&gt;ç»“åˆpaint_node_z_order_list&lt;br/&gt;è¿›è¡Œæ¸²æŸ“
end
</code></pre>]]></content><author><name>Kevin</name></author><category term="Jekyll" /><summary type="html"><![CDATA[1. å¯åŠ¨Weston]]></summary></entry><entry><title type="html">è®¾å¤‡èµ„æºç®¡ç†æ¨¡å—</title><link href="http://localhost:4000/blog/linux/2018-08-01-DeviceResourceManage.html" rel="alternate" type="text/html" title="è®¾å¤‡èµ„æºç®¡ç†æ¨¡å—" /><published>2018-08-01T00:00:00+08:00</published><updated>2018-08-01T00:00:00+08:00</updated><id>http://localhost:4000/blog/linux/DeviceResourceManage</id><content type="html" xml:base="http://localhost:4000/blog/linux/2018-08-01-DeviceResourceManage.html"><![CDATA[<h1 id="1è§£å†³çš„é—®é¢˜">1.è§£å†³çš„é—®é¢˜</h1>

<p>ç›¸ä¿¡æ¯ä¸€ä¸ªå†™è¿‡Linux driverçš„å·¥ç¨‹å¸ˆï¼Œéƒ½åœ¨probeå‡½æ•°ä¸­é‡åˆ°è¿‡ä¸Šé¢çš„å›°æƒ‘ï¼šåœ¨é¡ºåºç”³è¯·å¤šç§èµ„æºï¼ˆIRQã€Clockã€memoryã€regionsã€ioremapã€dmaã€ç­‰ç­‰ï¼‰çš„è¿‡ç¨‹ä¸­ï¼Œåªè¦ä»»æ„ä¸€ç§èµ„æºç”³è¯·å¤±è´¥ï¼Œå°±è¦å›æ»šé‡Šæ”¾ä¹‹å‰ç”³è¯·çš„æ‰€æœ‰èµ„æºã€‚ äºæ˜¯åœ¨å‡½æ•°çš„æœ€åï¼Œå°±ä¸€å®šä¼šå‡ºç°å¾ˆå¤šçš„gotoæ ‡ç­¾ï¼Œç”¨äºé‡Šæ”¾ä¸åŒçš„èµ„æºï¼ˆå¦‚ä¸Šé¢çš„exit_free_irqã€exit_free_dmaã€ç­‰ç­‰ï¼‰ã€‚ åœ¨ç”³è¯·èµ„æºå‡ºé”™æ—¶ï¼Œå°å¿ƒç¿¼ç¿¼çš„gotoåˆ°æ­£ç¡®çš„æ ‡ç­¾ä¸Šï¼Œä»¥ä¾¿é‡Šæ”¾å·²ç”³è¯·èµ„æºã€‚</p>

<p>è¿™æ ·åœ¨ä»£ç ä¸­ï¼Œæ•´ä¸ªå‡½æ•°è¢«å¤§æ®µçš„ã€é‡å¤çš„å¦‚ä¸‹ä»£ç å……æ–¥ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">condition</span><span class="p">)</span> 
<span class="p">{</span> 
    <span class="n">err</span> <span class="o">=</span> <span class="n">xxx</span><span class="p">;</span> 
    <span class="k">goto</span> <span class="n">xxx</span><span class="p">;</span> 
<span class="p">}</span>
</code></pre></div></div>
<p>æ—¢æµªè´¹ç²¾åŠ›å®¹æ˜“å‡ºé”™ï¼Œä¹Ÿä¸ç¾è§‚ã€‚ æœ‰å›°æƒ‘ï¼Œå°±æœ‰æ”¹å–„çš„åŠæ³•ã€‚ æ–¹æ³•å°±æ˜¯Linuxè®¾å¤‡æ¨¡å‹ä¸­çš„device resource managementï¼ˆè®¾å¤‡èµ„æºç®¡ç†ï¼‰ã€‚</p>

<h1 id="2è§£å†³çš„æ€è·¯">2.è§£å†³çš„æ€è·¯</h1>

<p>devresæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œ<font style="background:#8EE5EE">ç”¨èµ„æºèŠ‚ç‚¹çš„å½¢å¼è®°å½•å®ƒç”³è¯·çš„èµ„æºï¼Œå¹¶åœ¨ç³»ç»Ÿä¸­ä¸ºè®¾å¤‡åˆ†é…ä¸€ä¸ªé“¾è¡¨ï¼Œå½“ç”³è¯·æŸä¸ªèµ„æºæ—¶ï¼Œå°±æ„å»ºä¸€ä¸ªèµ„æºèŠ‚ç‚¹ï¼Œç„¶åæŠŠå®ƒåŠ å…¥åˆ°è¿™ä¸ªé“¾è¡¨ä¸­ï¼Œå¯¹åº”çš„é‡Šæ”¾å‡½æ•°ä¹Ÿä¼šè¢«è®°å½•ï¼Œä»¥ä¾¿åœ¨driver detachçš„æ—¶å€™ï¼Œè‡ªåŠ¨é‡Šæ”¾ã€‚</font></p>

<p>ä¸ºäº†ä½¿ç”¨devresæœºåˆ¶ï¼Œèµ„æºè¦å¯¹å„è‡ªçš„èµ„æºåˆ†é…å‡½æ•°é‡æ–°å°è£…ï¼ŒåŠ å…¥èµ„æºèŠ‚ç‚¹çš„ç”³è¯·ã€æ·»åŠ å’Œé‡Šæ”¾ï¼Œä¸€èˆ¬æ–°å‡½æ•°åæ”¹æˆäº†<font color="#ff0000">devm_xxx()</font>çš„å½¢å¼ã€‚driverä½œè€…åªç®¡è°ƒç”¨è¿™äº›devm_xxx()æ¥å£æ¥ç”³è¯·èµ„æºï¼Œä¸ç”¨è€ƒè™‘é‡Šæ”¾ï¼Œè®¾å¤‡æ¨¡å‹ä¼šåœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾å®ƒä»¬ã€‚</p>

<p>device resource managementä½äºâ€œdrivers/base/devres.câ€ä¸­ï¼Œå®ƒå®ç°äº†ä¸Šè¿°æœºåˆ¶ã€‚
<img src="/blog/assets/DeviceResourceManagement/1.png" alt="1.png" /></p>

<h1 id="3æä¾›çš„æ¥å£">3.æä¾›çš„æ¥å£</h1>

<p>ä»¥ä¸‹æ˜¯devresæä¾›çš„å‡ ä¸ªåŸºæœ¬æ¥å£</p>

<table>
  <thead>
    <tr>
      <th>interface</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>devres_alloc( )</td>
      <td>// åˆ†é…èµ„æºèŠ‚ç‚¹</td>
    </tr>
    <tr>
      <td>devres_free( )</td>
      <td>// é‡Šæ”¾èµ„æºèŠ‚ç‚¹</td>
    </tr>
    <tr>
      <td>devres_add( )</td>
      <td>// æ·»åŠ èµ„æºèŠ‚ç‚¹åˆ°é“¾è¡¨</td>
    </tr>
    <tr>
      <td>devres_destroy( )</td>
      <td>// é‡Šæ”¾èµ„æº</td>
    </tr>
    <tr>
      <td>devres_release_all()</td>
      <td>//é‡Šæ”¾æ‰€æœ‰èµ„æº</td>
    </tr>
  </tbody>
</table>

<h1 id="4æ¥å£çš„ä½¿ç”¨">4.æ¥å£çš„ä½¿ç”¨</h1>

<p>å…¶ä»–èµ„æºæ¨¡å—ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨devresæä¾›çš„æ¥å£ï¼Œåˆ©ç”¨devresæœºåˆ¶å®ç°èµ„æºçš„è‡ªåŠ¨é‡Šæ”¾ã€‚</p>

<h2 id="41-èµ„æºèŠ‚ç‚¹å‡½æ•°çš„åº”ç”¨ä¸¾ä¾‹">4.1 èµ„æºèŠ‚ç‚¹å‡½æ•°çš„åº”ç”¨ä¸¾ä¾‹</h2>

<p>ä¸‹é¢çš„ä»£ç æ˜¯åˆ©ç”¨devresæœºåˆ¶å®ç°åˆ†é…ä¸­æ–­èµ„æºå‡½æ•° devm_request_threaded_irq( ), ä¸Šå±‚æ¨¡å—å¯ä»¥è°ƒç”¨å®ƒæ¥åˆ†é…ä¸­æ–­èµ„æºï¼Œåœ¨å‡ºé”™æ—¶ï¼Œä¸å¿…è€ƒè™‘å¯¹è¯¥èµ„æºçš„é‡Šæ”¾ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</p>

<p>ä¸»è¦æ¶‰åŠåˆ°devres_alloc()ã€devres_free()å’Œdevres_add()</p>

<p><img src="/blog/assets/DeviceResourceManagement/2.png" alt="2.png" /></p>

<h2 id="42-èµ„æºé‡Šæ”¾å‡½æ•°çš„åº”ç”¨ä¸¾ä¾‹">4.2 èµ„æºé‡Šæ”¾å‡½æ•°çš„åº”ç”¨ä¸¾ä¾‹</h2>

<p>èµ„æºé‡Šæ”¾å‡½æ•°devres_destroy()çš„ä½¿ç”¨ä¸¾ä¾‹ï¼Œèµ„æºæ¨¡å—å¯ä»¥ç”¨å®ƒæ¥å°è£…èµ„æºé‡Šæ”¾å‡½æ•°ã€‚</p>

<p><img src="/blog/assets/DeviceResourceManagement/3.png" alt="3.png" width="500px" /></p>

<h1 id="5-å‡½æ•°çš„å†…éƒ¨å®ç°">5. å‡½æ•°çš„å†…éƒ¨å®ç°</h1>

<h2 id="51-devres_alloc">5.1 devres_alloc()</h2>

<p>devrs_alloc()å‡½æ•°çš„å®ç°ï¼Œä¸»è¦è°ƒç”¨äº†å†…éƒ¨å‡½æ•°alloc_dr(), å®ƒä¼šåˆ†é…<font color="#ff0000">size+sizeof(struct devres)</font>çš„å†…å­˜å¤§å°, struct devresç”¨äºå­˜å‚¨èµ„æºèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¹¶è®°å½•release å‡½æ•°ã€‚</p>

<p><img src="/blog/assets/DeviceResourceManagement/4.png" alt="4.png" /></p>

<h2 id="52-devres_add">5.2 devres_add()</h2>

<p>devres_add()ä¸»è¦å®ç°æŠŠèµ„æºèŠ‚ç‚¹æ·»åŠ åˆ°è®¾å¤‡çš„èµ„æºé“¾è¡¨ä¸­ã€‚</p>

<p><img src="/blog/assets/DeviceResourceManagement/5.png" alt="5.png" width="550px" /></p>

<h2 id="53-devres_destroy">5.3 devres_destroy()</h2>

<p>devres_destroy()ä¸»è¦æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªå†…éƒ¨å‡½æ•°ï¼š</p>
<ul>
  <li>devres_remove()   //æŸ¥æ‰¾åˆ°èµ„æºèŠ‚ç‚¹ï¼Œå¹¶ä»é“¾è¡¨ä¸­åˆ é™¤</li>
  <li>find_dr()         //æ ¹æ®releaseå‡½æ•°æŒ‡é’ˆã€matchå‡½æ•°æŸ¥æ‰¾èµ„æºèŠ‚ç‚¹</li>
  <li>devres_free()     //é‡Šæ”¾èµ„æºèŠ‚ç‚¹</li>
</ul>

<p>å¯ä»¥ç»“åˆä¸Šé¢å®ƒçš„ä½¿ç”¨å®ä¾‹æ¥å­¦ä¹ ã€‚</p>

<p><img src="/blog/assets/DeviceResourceManagement/6.png" alt="6.png" /></p>

<h2 id="54-devers_release_all">5.4 devers_release_all()</h2>

<p>devers_release_all()çš„è°ƒç”¨ä¼šé‡Šæ”¾æ‰€æœ‰èµ„æºã€‚å®ƒçš„è¢«è°ƒç”¨æ—¶æœºæœ‰ä¸¤ä¸ªï¼š</p>
<ul>
  <li>really_probe()å¤±è´¥</li>
  <li>è®¾å¤‡ä¸é©±åŠ¨åˆ†ç¦»æ—¶, deriver_dettachæ—¶ å°±æ˜¯driver_removeæ—¶ã€‚</li>
</ul>

<p><img src="/blog/assets/DeviceResourceManagement/7.png" alt="7.png" /></p>]]></content><author><name>kevin</name></author><category term="linux" /><summary type="html"><![CDATA[1.è§£å†³çš„é—®é¢˜]]></summary></entry><entry><title type="html">DRM ioctl</title><link href="http://localhost:4000/blog/drm/2018-06-21-DRM_IOCTL.html" rel="alternate" type="text/html" title="DRM ioctl" /><published>2018-06-21T00:00:00+08:00</published><updated>2018-06-21T00:00:00+08:00</updated><id>http://localhost:4000/blog/drm/DRM_IOCTL</id><content type="html" xml:base="http://localhost:4000/blog/drm/2018-06-21-DRM_IOCTL.html"><![CDATA[<h1 id="drm_ioctl_version">DRM_IOCTL_VERSION</h1>

<p>å®ƒé€šè¿‡ä¸»è¦ã€æ¬¡è¦å’Œè¡¥ä¸ç¨‹åºçº§åˆ«çš„ä¸‰å…ƒç»„æ¥æ ‡è¯†é©±åŠ¨ç¨‹åºç‰ˆæœ¬ã€‚</p>
<ul>
  <li>è¿™äº›ä¿¡æ¯åœ¨åˆå§‹åŒ–æ—¶è¢«æ‰“å°åˆ°å†…æ ¸æ—¥å¿—ä¸­</li>
  <li>é€šè¿‡ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_VERSION</code> ioctl ä¼ é€’åˆ°ç”¨æˆ·ç©ºé—´ã€‚</li>
</ul>

<p>é©±åŠ¨ç¨‹åºçš„æè¿°æ˜¯ä¸€ä¸ªçº¯ç²¹çš„ä¿¡æ¯å­—ç¬¦ä¸²ï¼Œé€šè¿‡ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_VERSION</code> ioctl ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ï¼Œä½†åœ¨å†…æ ¸ä¸­æ²¡æœ‰å…¶ä»–ç”¨é€”ã€‚é©±åŠ¨ç¨‹åºçš„æ—¥æœŸä»¥ YYYYMMDD æ ¼å¼è¡¨ç¤ºï¼Œç”¨äºæ ‡è¯†é©±åŠ¨ç¨‹åºçš„æœ€æ–°ä¿®æ”¹æ—¥æœŸã€‚<strong>ç”±äºå¤§å¤šæ•°é©±åŠ¨ç¨‹åºæœªèƒ½æ›´æ–°å®ƒï¼Œå…¶å€¼åŸºæœ¬ä¸Šæ˜¯æ— ç”¨çš„</strong>ã€‚</p>

<h1 id="drm_ioctl_get_unique">DRM_IOCTL_GET_UNIQUE</h1>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæŸ¥è¯¢ä¸ DRM è®¾å¤‡ç›¸å…³çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºè·å–è®¾å¤‡çš„ UUID æˆ–å…¶ä»–å”¯ä¸€æ ‡è¯†ï¼Œä»¥ä¾¿åœ¨å¤šä¸ªè®¾å¤‡ä¹‹é—´è¿›è¡ŒåŒºåˆ†ã€‚</p>

<h1 id="drm_ioctl_set_unique">DRM_IOCTL_SET_UNIQUE</h1>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè®¾ç½® DRM è®¾å¤‡çš„å”¯ä¸€åç§°ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ã€‚</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_SET_UNIQUE</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦ä¸²è®¾ç½® DRM è®¾å¤‡çš„å”¯ä¸€åç§°ã€‚</li>
      <li>è¿™ä¸ªå”¯ä¸€åç§°é€šå¸¸ç”¨äºæ ‡è¯†ä¸åŒçš„ DRM è®¾å¤‡ï¼Œä»¥ä¾¿åœ¨å¤šä¸ªè®¾å¤‡ä¹‹é—´è¿›è¡ŒåŒºåˆ†ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>åœ¨ Linux å†…æ ¸ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_SET_UNIQUE</code> çš„å®ç°å¯èƒ½å› ä¸åŒçš„ DRM é©±åŠ¨è€Œå¼‚ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ç›¸åº”çš„ ioctl å‡½æ•°æ¥è®¾ç½®è®¾å¤‡çš„å”¯ä¸€åç§°ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_irq_busid">DRM_IOCTL_IRQ_BUSID</h1>

<p>å®ƒç”¨äºåŸºäºæ€»çº¿ IDï¼ˆbusidï¼‰ä¸º PCI è®¾å¤‡è·å–ä¸­æ–­è¯·æ±‚ï¼ˆIRQï¼‰ã€‚åœ¨è¿‡å»ï¼Œè¿™ä¸ªæ¥å£æ˜¯é€šç”¨çš„ DRM æ¨¡å—å‡½æ•°ï¼Œå¯ä»¥ä¸ºå¤šä¸ªä¸åŒçš„è®¾å¤‡æä¾›æœåŠ¡ã€‚ç„¶è€Œï¼Œç°åœ¨å®ƒå¯èƒ½éœ€è¦æ›´æ”¹ï¼Œä»¥ä»…è¿”å›ä¸ç‰¹å®š <code class="language-plaintext highlighter-rouge">drm_device_t</code> ç›¸å…³è”çš„è®¾å¤‡çš„ä¸­æ–­å·ã€‚</p>

<h1 id="drm_ioctl_get_client">DRM_IOCTL_GET_CLIENT</h1>

<p>å®ƒç”¨äºæŸ¥è¯¢ DRM è®¾å¤‡çš„å®¢æˆ·ç«¯ä¿¡æ¯ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ã€‚</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_CLIENT</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæŸ¥è¯¢ä¸ DRM è®¾å¤‡ç›¸å…³çš„å®¢æˆ·ç«¯ä¿¡æ¯ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºè·å–å®¢æˆ·ç«¯çš„å”¯ä¸€æ ‡è¯†ç¬¦æˆ–å…¶ä»–ç›¸å…³ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨å¤šä¸ªå®¢æˆ·ç«¯ä¹‹é—´è¿›è¡ŒåŒºåˆ†ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>åœ¨ Linux å†…æ ¸ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_CLIENT</code> çš„å®ç°å¯èƒ½å› ä¸åŒçš„ DRM é©±åŠ¨è€Œå¼‚ã€‚</li>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">drmGetBusid()</code> å‡½æ•°ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥è·å–ä¸æ€»çº¿ IDï¼ˆbusidï¼‰ç›¸å…³çš„å®¢æˆ·ç«¯ä¿¡æ¯ã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ¥å£çš„å…·ä½“å®ç°å¯èƒ½å› ä¸åŒçš„é©±åŠ¨è€Œæœ‰æ‰€ä¸åŒï¼Œå› æ­¤æ‚¨å¯ä»¥æŸ¥é˜…ç‰¹å®šé©±åŠ¨çš„æ–‡æ¡£æˆ–æºä»£ç ä»¥è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_get_stats">DRM_IOCTL_GET_STATS</h1>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæŸ¥è¯¢ä¸ DRM è®¾å¤‡ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ã€‚</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_STATS</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè·å–ä¸ DRM è®¾å¤‡ç›¸å…³çš„ç»Ÿè®¡æ•°æ®ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºæŸ¥è¯¢è®¾å¤‡çš„æ€§èƒ½æŒ‡æ ‡ã€èµ„æºä½¿ç”¨æƒ…å†µã€é”™è¯¯ç»Ÿè®¡ç­‰ä¿¡æ¯ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>åœ¨ Linux å†…æ ¸ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_STATS</code> çš„å®ç°å¯èƒ½å› ä¸åŒçš„ DRM é©±åŠ¨è€Œå¼‚ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ç›¸åº”çš„ ioctl å‡½æ•°æ¥è·å–ç»Ÿè®¡æ•°æ®ã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ¥å£çš„å…·ä½“å®ç°å¯èƒ½å› ä¸åŒçš„é©±åŠ¨è€Œæœ‰æ‰€ä¸åŒï¼Œå› æ­¤æ‚¨å¯ä»¥æŸ¥é˜…ç‰¹å®šé©±åŠ¨çš„æ–‡æ¡£æˆ–æºä»£ç ä»¥è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_get_cap">DRM_IOCTL_GET_CAP</h1>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæŸ¥è¯¢ä¸ DRM è®¾å¤‡ç›¸å…³çš„èƒ½åŠ›ä¿¡æ¯ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ã€‚</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_CAP</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè·å–ä¸ DRM è®¾å¤‡ç›¸å…³çš„èƒ½åŠ›æ•°æ®ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºæŸ¥è¯¢è®¾å¤‡æ”¯æŒçš„åŠŸèƒ½ã€ç‰¹æ€§å’Œé™åˆ¶ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>åœ¨ Linux å†…æ ¸ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_CAP</code> çš„å®ç°å¯èƒ½å› ä¸åŒçš„ DRM é©±åŠ¨è€Œå¼‚ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ç›¸åº”çš„ ioctl å‡½æ•°æ¥è·å–èƒ½åŠ›æ•°æ®ã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ¥å£çš„å…·ä½“å®ç°å¯èƒ½å› ä¸åŒçš„é©±åŠ¨è€Œæœ‰æ‰€ä¸åŒï¼Œå› æ­¤æ‚¨å¯ä»¥æŸ¥é˜…ç‰¹å®šé©±åŠ¨çš„æ–‡æ¡£æˆ–æºä»£ç ä»¥è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_set_client_cap">DRM_IOCTL_SET_CLIENT_CAP</h1>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè®¾ç½®ä¸ DRM è®¾å¤‡ç›¸å…³çš„èƒ½åŠ›ä¿¡æ¯ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ã€‚</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_SET_CLIENT_CAP</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè®¾ç½®ä¸ DRM è®¾å¤‡ç›¸å…³çš„èƒ½åŠ›æ•°æ®ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºæŸ¥è¯¢è®¾å¤‡æ”¯æŒçš„åŠŸèƒ½ã€ç‰¹æ€§å’Œé™åˆ¶ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>åœ¨ Linux å†…æ ¸ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_SET_CLIENT_CAP</code> çš„å®ç°å¯èƒ½å› ä¸åŒçš„ DRM é©±åŠ¨è€Œå¼‚ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ç›¸åº”çš„ ioctl å‡½æ•°æ¥è®¾ç½®èƒ½åŠ›æ•°æ®ã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ¥å£çš„å…·ä½“å®ç°å¯èƒ½å› ä¸åŒçš„é©±åŠ¨è€Œæœ‰æ‰€ä¸åŒï¼Œå› æ­¤æ‚¨å¯ä»¥æŸ¥é˜…ç‰¹å®šé©±åŠ¨çš„æ–‡æ¡£æˆ–æºä»£ç ä»¥è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_CLIENT_CAP_ASPECT_RATIO</strong>:
    <ul>
      <li>
        <p>æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½åŠ›æ ‡å¿—ï¼Œç”¨äºæŒ‡ç¤ºç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæ˜¯å¦æ”¯æŒå›¾åƒçš„çºµæ¨ªæ¯”ä¿¡æ¯ã€‚å¦‚æœåº”ç”¨ç¨‹åºæ”¯æŒæ­¤æ ‡å¿—ï¼Œå†…æ ¸å°†åœ¨æ¨¡å¼ä¸­ä¼ é€’çºµæ¨ªæ¯”ä¿¡æ¯ã€‚è¿™å¯¹äºæ˜¾ç¤ºå›¾åƒæ—¶ä¿æŒæ­£ç¡®çš„çºµæ¨ªæ¯”éå¸¸é‡è¦ã€‚</p>
      </li>
      <li>
        <p>å¦‚æœè®¾ç½®ä¸º 1ï¼ŒDRM å†…æ ¸å°†å‘ç”¨æˆ·ç©ºé—´å…¬å¼€åŸå­å±æ€§ã€‚è¿™éšå¼å¯ç”¨äº† DRM_CLIENT_CAP_UNIVERSAL_PLANES å’Œ DRM_CLIENT_CAP_ASPECT_RATIOã€‚å¦‚æœé©±åŠ¨ç¨‹åºä¸æ”¯æŒåŸå­æ¨¡å¼è®¾ç½®ï¼Œå¯ç”¨æ­¤åŠŸèƒ½å°†å¤±è´¥å¹¶è¿”å› -EOPNOTSUPP é”™è¯¯ã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯åœ¨å†…æ ¸ç‰ˆæœ¬ 4.0 ä¸­å¼•å…¥çš„1ã€‚</p>
      </li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_wait_vblank">DRM_IOCTL_WAIT_VBLANK</h1>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåœ¨æŒ‡å®šçš„vblankäº‹ä»¶å‘ç”Ÿæ—¶é˜»å¡æˆ–è¯·æ±‚ä¿¡å·ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_WAIT_VBLANK</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºåœ¨æŒ‡å®šçš„vblankäº‹ä»¶å‘ç”Ÿæ—¶é˜»å¡æˆ–è¯·æ±‚ä¿¡å·ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºä¸æ˜¾ç¤ºç›¸å…³çš„åŒæ­¥æ“ä½œï¼Œä¾‹å¦‚åœ¨è¿›è¡Œé¡µé¢ç¿»è½¬æ—¶ç­‰å¾…vblankã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>DRM æ ¸å¿ƒå¤„ç†å¤§éƒ¨åˆ†vblankç®¡ç†é€»è¾‘ï¼ŒåŒ…æ‹¬è¿‡æ»¤æ‰è™šå‡ä¸­æ–­ã€ä¿æŒæ— ç«äº‰çš„ç©ºç™½è®¡æ•°ã€å¤„ç†è®¡æ•°å™¨å›ç»•å’Œé‡ç½®ï¼Œä»¥åŠä¿æŒä½¿ç”¨è®¡æ•°ã€‚</li>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œç›¸åº”çš„ ioctl å‡½æ•°æ¥ä½¿ç”¨è¿™ä¸ªæ¥å£ã€‚</li>
      <li>è¿™ä¸ªæœºåˆ¶ç¡®ä¿åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„è°ƒç”¨è€…æ‰èƒ½è®¿é—®ç‰¹å®šçš„ DRM åŠŸèƒ½ã€‚</li>
    </ul>
  </li>
  <li><strong>å‚ç›´åŒæ­¥ï¼ˆVSYNC</strong>ï¼‰ï¼š
    <ul>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼Œå‚ç›´åŒæ­¥æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œç”¨äºç¡®ä¿å›¾åƒåœ¨æ˜¾ç¤ºå™¨ä¸Šçš„åˆ·æ–°ä¸æ˜¾ç¤ºå™¨çš„å‚ç›´ç©ºç™½æœŸï¼ˆvertical blanking intervalï¼‰åŒæ­¥ã€‚</li>
      <li>vblank(<strong>å‚ç›´ç©ºç™½æœŸ</strong>)æ˜¯æ˜¾ç¤ºå™¨åœ¨ç»˜åˆ¶ä¸€å¸§å›¾åƒåï¼Œå‡†å¤‡ç»˜åˆ¶ä¸‹ä¸€å¸§ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚</li>
    </ul>
  </li>
  <li><strong>drmWaitVBlank å‡½æ•°</strong>ï¼š
    <ul>
      <li>è¿™ä¸ªå‡½æ•°ç”¨äºç­‰å¾…å‚ç›´åŒæ­¥ä¿¡å·ã€‚</li>
      <li>å®ƒæ¥å—ä¸€ä¸ª DRM è®¾å¤‡æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œä¸€ä¸ªè¡¨ç¤ºæ˜¾ç¤ºè¾“å‡ºçš„ CRTCï¼ˆCathode Ray Tube Controllerï¼‰çš„ IDã€‚
å½“å‚ç›´åŒæ­¥ä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‡½æ•°ä¼šè¿”å›ã€‚</li>
      <li>åœ¨æ¸¸æˆå¼€å‘å’Œå›¾å½¢æ¸²æŸ“ä¸­ï¼ŒdrmWaitVBlank å¯ä»¥ç”¨äºç¡®ä¿é¡µé¢ç¿»è½¬ï¼ˆpage flipï¼‰ä¸å‚ç›´åŒæ­¥å¯¹é½ï¼Œä»è€Œé¿å…å±å¹•æ’•è£‚ï¼ˆtearingï¼‰ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_mode_getgamma">DRM_IOCTL_MODE_GETGAMMA</h1>

<p>ç”¨äºä» <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è·å–ç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„ <strong>ä¼½é©¬æ ¡æ­£ï¼ˆGamma Correctionï¼‰</strong> ä¿¡æ¯.</p>

<p>è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>ä¼½é©¬æ ¡æ­£æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>ä¼½é©¬æ ¡æ­£</strong> æ˜¯ä¸€ç§å›¾åƒå¤„ç†æŠ€æœ¯ï¼Œç”¨äºè°ƒæ•´æ˜¾ç¤ºè®¾å¤‡çš„äº®åº¦å’Œå¯¹æ¯”åº¦ã€‚</li>
      <li>å®ƒé€šè¿‡æ”¹å˜åƒç´ çš„äº®åº¦å€¼æ¥å®ç°ï¼Œä»¥ä¾¿æ›´å‡†ç¡®åœ°æ˜¾ç¤ºä¸åŒäº®åº¦çº§åˆ«çš„å›¾åƒã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_GETGAMMA çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETGAMMA</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¼½é©¬æ ¡æ­£ä¿¡æ¯ã€‚</li>
      <li>è¿™äº›ä¿¡æ¯å¯èƒ½åŒ…æ‹¬ä¼½é©¬æ ¡æ­£æ›²çº¿ã€äº®åº¦å’Œå¯¹æ¯”åº¦çš„è°ƒæ•´ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETGAMMA</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_mode_dirtyfb">DRM_IOCTL_MODE_DIRTYFB</h1>

<p>ç”¨äºå®šä¹‰ä¸€ä¸ªå¸§ç¼“å†²åŒºåŒºåŸŸä¸ºâ€œè„â€ï¼ˆæ•°æ®å·²æ›´æ”¹ï¼Œå› æ­¤éœ€è¦é‡æ–°æ˜¾ç¤ºï¼‰ã€‚è¿™ä¸ª ioctl ä½¿ç”¨äº† <code class="language-plaintext highlighter-rouge">drm_mode_fb_dirty_cmd</code> ç»“æ„ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">num_clips</code> å­—æ®µï¼ŒæŒ‡ç¤ºæ›´æ”¹çš„åŒºåŸŸæ•°é‡.</p>

<ol>
  <li><strong>å¸§ç¼“å†²åŒºæ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>å¸§ç¼“å†²åŒº</strong> æ˜¯ä¸€ä¸ªæŠ½è±¡çš„å†…å­˜å¯¹è±¡ï¼Œç”¨äºå‘ CRTC æ‰«æè¾“å‡ºåƒç´ ã€‚</li>
      <li>åº”ç”¨ç¨‹åºé€šè¿‡ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼ˆ2ï¼‰ioctl æ˜¾å¼è¯·æ±‚åˆ›å»ºå¸§ç¼“å†²åŒºï¼Œå¹¶æ¥æ”¶ä¸€ä¸ªä¸é€æ˜çš„å¥æŸ„ï¼Œå¯ä»¥ä¼ é€’ç»™ KMS CRTC æ§åˆ¶ã€å¹³é¢é…ç½®å’Œé¡µé¢ç¿»è½¬åŠŸèƒ½ã€‚</li>
      <li>å¸§ç¼“å†²åŒºä¾èµ–äºåº•å±‚å†…å­˜ç®¡ç†å™¨è¿›è¡Œä½çº§å†…å­˜æ“ä½œã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_DIRTYFB çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_DIRTYFB</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å°†ç‰¹å®šå¸§ç¼“å†²åŒºåŒºåŸŸæ ‡è®°ä¸ºâ€œè„â€ã€‚</li>
      <li>è¿™é€šå¸¸ç”¨äºé€šçŸ¥æ˜¾ç¤ºç³»ç»Ÿéœ€è¦é‡æ–°æ‰«æå’Œæ˜¾ç¤ºæ›´æ”¹çš„åƒç´ æ•°æ®ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_DIRTYFB</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_mode_atomic">DRM_IOCTL_MODE_ATOMIC</h1>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­æ‰§è¡Œ <strong>åŸå­æ“ä½œï¼ˆAtomic Operationï¼‰</strong>ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>KMS æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>KMSï¼ˆKernel Mode Settingï¼‰</strong> æ˜¯ä¸€ç§å†…æ ¸çº§åˆ«çš„å›¾å½¢æ˜¾ç¤ºè®¾ç½®æœºåˆ¶ï¼Œç”¨äºç®¡ç†æ˜¾ç¤ºè®¾å¤‡çš„æ¨¡å¼å’ŒçŠ¶æ€ã€‚</li>
      <li>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºä¸å†…æ ¸äº¤äº’ï¼Œä»¥é…ç½®æ˜¾ç¤ºè¾“å‡ºã€‚</li>
    </ul>
  </li>
  <li><strong>åŸå­æ“ä½œçš„æ¦‚å¿µ</strong>
    <ul>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼Œ<strong>åŸå­æ“ä½œ</strong> æ˜¯æŒ‡ä¸€ç»„çŠ¶æ€æ›´æ”¹ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸåº”ç”¨ï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œä¸ä¼šå‡ºç°éƒ¨åˆ†åº”ç”¨çš„æƒ…å†µã€‚</li>
      <li>åœ¨ KMS ä¸­ï¼ŒåŸå­æ“ä½œç”¨äºä¸€æ¬¡æ€§æ›´æ–°å¤šä¸ªæ˜¾ç¤ºå¯¹è±¡çš„çŠ¶æ€ï¼Œä¾‹å¦‚ CRTCã€å¹³é¢ã€è¿æ¥å™¨ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_ATOMIC çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ATOMIC</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æäº¤ä¸€ç»„åŸå­æ“ä½œï¼Œä»¥æ›´æ–°æ˜¾ç¤ºç®¡é“çš„çŠ¶æ€ã€‚</li>
      <li>è¿™äº›æ“ä½œå¯ä»¥åŒ…æ‹¬æ›´æ”¹ CRTC æ¨¡å¼ã€å¹³é¢é…ç½®ã€è¿æ¥å™¨çŠ¶æ€ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ATOMIC</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_crtc_get_sequence">DRM_IOCTL_CRTC_GET_SEQUENCE</h1>

<p>ç”¨äºä» <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è·å–ç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„ <strong>å¸§åºåˆ—ï¼ˆFrame Sequenceï¼‰</strong> ä¿¡æ¯.</p>

<p>è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>CRTC æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>CRTC</strong> æ˜¯æ˜¾ç¤ºæ§åˆ¶å™¨ï¼Œè´Ÿè´£å°†å›¾å½¢æ•°æ®å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼ˆä¾‹å¦‚æ˜¾ç¤ºå™¨æˆ–ç”µè§†ï¼‰ã€‚</li>
      <li>å®ƒç®¡ç†åƒç´ æ—¶é’Ÿã€æ‰«æçº¿å’Œå¸§ç¼“å†²åŒºçš„åˆ·æ–°ã€‚</li>
    </ul>
  </li>
  <li><strong>å¸§åºåˆ—æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼Œ<strong>å¸§åºåˆ—</strong> æ˜¯æŒ‡æ˜¾ç¤ºè®¾å¤‡åˆ·æ–°å›¾åƒçš„é¡ºåºã€‚</li>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_CRTC_GET_SEQUENCE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è·å–æœ‰å…³ç‰¹å®š CRTC çš„å¸§åºåˆ—ä¿¡æ¯ï¼Œä¾‹å¦‚å½“å‰å¸§æ•°ã€å‚ç›´åŒæ­¥ä¿¡å·ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_CRTC_GET_SEQUENCE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="drm_ioctl_crtc_queue_sequence">DRM_IOCTL_CRTC_QUEUE_SEQUENCE</h1>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­å°†ç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„å¸§åºåˆ—ä¿¡æ¯æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­.</p>

<p>ä»¥ä¸‹æ˜¯å…³äº <code class="language-plaintext highlighter-rouge">DRM_IOCTL_CRTC_QUEUE_SEQUENCE</code> çš„ä¸€äº›è¦ç‚¹ï¼š</p>

<ol>
  <li><strong>CRTC æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>CRTC</strong> æ˜¯æ˜¾ç¤ºæ§åˆ¶å™¨ï¼Œè´Ÿè´£å°†å›¾å½¢æ•°æ®å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼ˆä¾‹å¦‚æ˜¾ç¤ºå™¨æˆ–ç”µè§†ï¼‰ã€‚</li>
      <li>å®ƒç®¡ç†åƒç´ æ—¶é’Ÿã€æ‰«æçº¿å’Œå¸§ç¼“å†²åŒºçš„åˆ·æ–°ã€‚</li>
    </ul>
  </li>
  <li><strong>å¸§åºåˆ—æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼Œ<strong>å¸§åºåˆ—</strong> æ˜¯æŒ‡æ˜¾ç¤ºè®¾å¤‡åˆ·æ–°å›¾åƒçš„é¡ºåºã€‚</li>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_CRTC_QUEUE_SEQUENCE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å°†ç‰¹å®š CRTC çš„å¸§åºåˆ—ä¿¡æ¯æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_CRTC_QUEUE_SEQUENCE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="magic--master">Magic &amp; Master</h1>

<h2 id="drm_ioctl_get_magic">DRM_IOCTL_GET_MAGIC</h2>

<p>æ˜¯ä¸€å¯¹ <strong>IOCTLï¼ˆInput/Output Controlï¼‰å‘½ä»¤</strong>ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>é­”æ•°/å¹»æ•°å­—ï¼ˆMagic Numberï¼‰çš„ä½œç”¨</strong>
    <ul>
      <li>åœ¨å›¾å½¢è®¾å¤‡é©±åŠ¨ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_MAGIC</code> ç”¨äºè®¾ç½®é­”æ•°/å¹»æ•°å­—ï¼Œä»¥è¿›è¡Œ <strong>GEM ioctl</strong> æƒé™æ£€æŸ¥ã€‚</li>
      <li>é­”æ•°æ˜¯ä¸€ä¸ª32ä½çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºéªŒè¯å¯¹å›¾å½¢èµ„æºçš„è®¿é—®æƒé™ã€‚</li>
    </ul>
  </li>
  <li><strong>å…·ä½“æ“ä½œ</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_MAGIC</code> å‡½æ•°ä¼šè¿”å›ä¸€ä¸ª32ä½çš„é­”æ•°ï¼Œç„¶åå°†è¯¥é­”æ•°ä¼ é€’ç»™ <strong>DRM-Master</strong>ã€‚</li>
      <li><strong>DRM-Master</strong> ä½¿ç”¨æ­¤é­”æ•°é€šè¿‡ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_AUTH_MAGIC</code> ç»™å‘èµ·é‰´æƒçš„é <strong>DRM-Master</strong> åº”ç”¨ç¨‹åºæˆæƒã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_auth_magic">DRM_IOCTL_AUTH_MAGIC</h2>

<p>å®ƒç”¨äºå¯¹é DRM ä¸»ç”¨æˆ·ç©ºé—´ç¨‹åºè¿›è¡Œèº«ä»½éªŒè¯ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_AUTH_MAGIC</code> ç”¨äºå¯¹é DRM ä¸»ç”¨æˆ·ç©ºé—´ç¨‹åºè¿›è¡Œèº«ä»½éªŒè¯ã€‚</li>
      <li>å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š
        <ol>
          <li>é DRM ä¸»ç”¨æˆ·ç©ºé—´ç¨‹åºé€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_MAGIC</code> ioctl ä» DRM è®¾å¤‡è·å–ä¸€ä¸ªå”¯ä¸€çš„ä»¤ç‰Œï¼ˆ32 ä½é­”æ•°ï¼‰ã€‚</li>
          <li>ç„¶åï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºå°†æ­¤ä»¤ç‰Œä¼ é€’ç»™ DRM ä¸»ï¼ˆä¾‹å¦‚é€šè¿‡ IPC æˆ– X å®¢æˆ·ç«¯ä¸­çš„ DRI2Authenticate è¯·æ±‚ï¼‰ã€‚</li>
          <li>DRM ä¸»è¿›ç¨‹éšåä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_AUTH_MAGIC</code> ioctl å°†ä»¤ç‰Œå‘é€å› DRM è®¾å¤‡ã€‚</li>
          <li>è®¾å¤‡æ ¹æ®æ¥æ”¶åˆ°çš„ä»¤ç‰Œï¼Œæˆäºˆå‘èµ·èº«ä»½éªŒè¯çš„é DRM ä¸»åº”ç”¨ç‰¹æ®Šæƒé™ã€‚</li>
        </ol>
      </li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>èº«ä»½éªŒè¯ä»¤ç‰Œå…è®¸é DRM ä¸»è¿›ç¨‹æ‰§è¡Œç‰¹å®šçš„ç‰¹æƒæ“ä½œã€‚</li>
      <li>é€šè¿‡å°†ä»¤ç‰Œä¸ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰å…³è”ï¼Œè®¾å¤‡æˆæƒåº”ç”¨è®¿é—®ç‰¹å®šèµ„æºæˆ–æ‰§è¡Œå—é™æ“ä½œã€‚</li>
      <li>è¿™ç§æœºåˆ¶ç¡®ä¿åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„è°ƒç”¨è€…æ‰èƒ½è®¿é—®ç‰¹å®šçš„ DRM åŠŸèƒ½ã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_set_master">DRM_IOCTL_SET_MASTER</h2>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæˆä¸ºå”¯ä¸€çš„ DRM ä¸»æ˜¾ç¤ºç®¡ç†ç¨‹åºã€‚æ‰§è¡Œæ­¤ ioctl åï¼Œè¯¥ç¨‹åºè·å¾—äº†ç‹¬å çš„æƒé™ï¼Œç”¨äºç®¡ç†ä¸æ˜¾ç¤ºç›¸å…³çš„æ“ä½œã€‚ç›¸åï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_DROP_MASTER</code> ioctl å¯ç”¨äºæ”¾å¼ƒ DRM ä¸»èº«ä»½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒX æœåŠ¡å™¨ï¼ˆXorgï¼‰å……å½“ DRM ä¸»ã€‚</p>

<p>å…¶ä»–é DRM ä¸»ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡ DRM-Auth è¿›è¡Œèº«ä»½éªŒè¯ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<ol>
  <li>æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GET_MAGIC</code> ioctlï¼Œä» DRM è®¾å¤‡è·å–ä¸€ä¸ªå”¯ä¸€çš„ä»¤ç‰Œï¼ˆé­”æ•°ï¼‰ã€‚</li>
  <li>å°†æ­¤ä»¤ç‰Œä¼ é€’ç»™ DRM ä¸»ï¼ˆä¾‹å¦‚é€šè¿‡ IPC æˆ– X å®¢æˆ·ç«¯ä¸­çš„ DRI2Authenticate è¯·æ±‚ï¼‰ã€‚</li>
  <li>DRM ä¸»è¿›ç¨‹éšåä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_AUTH_MAGIC</code> ioctl å°†ä»¤ç‰Œå‘é€å› DRM è®¾å¤‡ã€‚</li>
  <li>åŸºäºæ¥æ”¶åˆ°çš„ä»¤ç‰Œï¼Œè®¾å¤‡æˆäºˆå‘èµ·èº«ä»½éªŒè¯çš„é DRM ä¸»åº”ç”¨ç‰¹æ®Šæƒé™ã€‚</li>
</ol>

<p>è¿™ä¸ªèº«ä»½éªŒè¯ä»¤ç‰Œå…è®¸é DRM ä¸»è¿›ç¨‹æ‰§è¡Œç‰¹å®šçš„ç‰¹æƒæ“ä½œã€‚é€šè¿‡å°†ä»¤ç‰Œä¸ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰å…³è”ï¼Œè®¾å¤‡æˆæƒåº”ç”¨è®¿é—®ç‰¹å®šèµ„æºæˆ–æ‰§è¡Œå—é™æ“ä½œã€‚è¿™ç§æœºåˆ¶ç¡®ä¿åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„è°ƒç”¨è€…æ‰èƒ½è®¿é—®ç‰¹å®šçš„ DRM åŠŸèƒ½ã€‚</p>

<h2 id="drm_ioctl_drop_master">DRM_IOCTL_DROP_MASTER</h2>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæ”¾å¼ƒ DRM ä¸»èº«ä»½ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_DROP_MASTER</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºæ”¾å¼ƒ DRM ä¸»èº«ä»½ã€‚</li>
      <li>å½“ç¨‹åºæ‰§è¡Œæ­¤ ioctl æ—¶ï¼Œå®ƒä¼šå¤±å»ç‹¬å ç®¡ç†æ˜¾ç¤ºç›¸å…³æ“ä½œçš„ç‰¹æƒã€‚</li>
      <li>ç›¸åï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_SET_MASTER</code> ioctl å¯ç”¨äºæˆä¸º DRM ä¸»ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>é€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_DROP_MASTER</code>ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥æ”¾å¼ƒ DRM ä¸»èº«ä»½ã€‚</li>
      <li>è¿™åœ¨éœ€è¦åˆ‡æ¢ DRM ä¸»æ—¶å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚åœ¨å…³é—­/æ‰“å¼€ä¸»è®¾å¤‡èŠ‚ç‚¹æ—¶ã€‚</li>
      <li>é€šå¸¸æƒ…å†µä¸‹ï¼ŒX æœåŠ¡å™¨ï¼ˆXorgï¼‰å……å½“ DRM ä¸»ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="gem">GEM</h1>

<h2 id="drm_ioctl_gem_close">DRM_IOCTL_GEM_CLOSE</h2>

<p>å®ƒç”¨äºå…³é—­ GEM ç¼“å†²åŒºï¼ˆGraphics Execution Managerï¼‰ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_CLOSE</code> ç”¨äºå…³é—­ GEM ç¼“å†²åŒºã€‚</li>
      <li>åœ¨æ‰§è¡Œæ­¤ ioctl åï¼ŒGEM ç¼“å†²åŒºçš„å¥æŸ„å°†ä¸å†å¯ç”¨äºå½“å‰è¿›ç¨‹ï¼Œå¹¶ä¸”å¯èƒ½è¢« GEM API é‡æ–°ç”¨äºæ–°çš„ GEM å¯¹è±¡ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_CLOSE</code> æ¥å…³é—­ GEM ç¼“å†²åŒºã€‚</li>
      <li>è¿™åœ¨é‡Šæ”¾èµ„æºæˆ–ç®¡ç†å†…å­˜æ—¶éå¸¸æœ‰ç”¨ã€‚</li>
      <li>è¯·æ³¨æ„ï¼ŒGEM ç¼“å†²åŒºçš„å…³é—­ä¸ä¼šç«‹å³é‡Šæ”¾å†…å­˜ï¼Œè€Œæ˜¯å°†å…¶æ ‡è®°ä¸ºä¸å†ä½¿ç”¨ï¼Œä»¥ä¾¿ç¨åè¿›è¡Œå›æ”¶ã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_gem_flink">DRM_IOCTL_GEM_FLINK</h2>

<p>å®ƒç”¨äºä¸º GEM ç¼“å†²åŒºï¼ˆGraphics Execution Managerï¼‰åˆ›å»ºä¸€ä¸ªåç§°ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_FLINK</code> ç”¨äºä¸º GEM ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ªåç§°ã€‚</li>
      <li>åœ¨æ‰§è¡Œæ­¤ ioctl åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªåç§°æ¥å¼•ç”¨è¯¥ GEM ç¼“å†²åŒºã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_FLINK</code> æ¥ä¸º GEM ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ªåç§°ã€‚</li>
      <li>è¿™åœ¨éœ€è¦åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´å¼•ç”¨ GEM å¯¹è±¡æ—¶éå¸¸æœ‰ç”¨ã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªåç§°ä¸èƒ½ç›´æ¥ç”¨äºåœ¨ DRM API ä¸­å¼•ç”¨å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_FLINK</code> å’Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_OPEN</code> ioctl åˆ†åˆ«å°†å¥æŸ„è½¬æ¢ä¸ºåç§°å’Œåç§°è½¬æ¢ä¸ºå¥æŸ„ã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_gem_open">DRM_IOCTL_GEM_OPEN</h2>

<p>å®ƒç”¨äºä¸º GEM ç¼“å†²åŒºï¼ˆGraphics Execution Managerï¼‰åˆ›å»ºä¸€ä¸ªåç§°ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_OPEN</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºä¸º GEM ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ªåç§°ã€‚</li>
      <li>åœ¨æ‰§è¡Œæ­¤ ioctl åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªåç§°æ¥å¼•ç”¨è¯¥ GEM ç¼“å†²åŒºã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_OPEN</code> æ¥ä¸º GEM ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ªåç§°ã€‚</li>
      <li>è¿™åœ¨éœ€è¦åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´å¼•ç”¨ GEM å¯¹è±¡æ—¶éå¸¸æœ‰ç”¨ã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªåç§°ä¸èƒ½ç›´æ¥ç”¨äºåœ¨ DRM API ä¸­å¼•ç”¨å¯¹è±¡ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_FLINK</code> å’Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_GEM_OPEN</code> ioctl åˆ†åˆ«å°†å¥æŸ„è½¬æ¢ä¸ºåç§°å’Œåç§°è½¬æ¢ä¸ºå¥æŸ„ã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_prime_handle_to_fd">DRM_IOCTL_PRIME_HANDLE_TO_FD</h2>

<p>å®ƒç”¨äºå°† GEM ç¼“å†²åŒºï¼ˆGraphics Execution Managerï¼‰çš„å¥æŸ„è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_PRIME_HANDLE_TO_FD</code> å…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºå°† GEM ç¼“å†²åŒºçš„å¥æŸ„è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ã€‚</li>
      <li>è¿™åœ¨éœ€è¦åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´å…±äº« GEM ç¼“å†²åŒºæ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚ç”¨äºè·¨è¿›ç¨‹çš„çº¹ç†å…±äº«ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_PRIME_HANDLE_TO_FD</code> æ¥è·å–æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ä¸å…¶ä»–è¿›ç¨‹ä¹‹é—´çš„ IPCï¼ˆè¿›ç¨‹é—´é€šä¿¡ï¼‰ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¾¿å…±äº« GEM ç¼“å†²åŒºã€‚</li>
      <li>è¯·æ³¨æ„ï¼Œè¿™ä¸ªæ¥å£çš„å®ç°å¯èƒ½å› ä¸åŒçš„ DRM é©±åŠ¨è€Œæœ‰æ‰€ä¸åŒï¼Œå…·ä½“ç»†èŠ‚å¯ä»¥æŸ¥é˜…ç‰¹å®šé©±åŠ¨çš„æ–‡æ¡£æˆ–æºä»£ç ã€‚</li>
    </ul>
  </li>
  <li>ç›¸å…³CMD <strong>DRM_IOCTL_PRIME_FD_TO_HANDLE</strong></li>
</ol>

<h1 id="resource">Resource</h1>

<h2 id="drm_ioctl_mode_getresources">DRM_IOCTL_MODE_GETRESOURCES</h2>

<p>å®ƒå…è®¸ç”¨æˆ·ç©ºé—´ç¨‹åºè·å–ä¸ DRM è®¾å¤‡ç›¸å…³çš„èµ„æºä¿¡æ¯ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹è¿™ä¸ªæ¥å£çš„ä½œç”¨å’Œå®ç°ï¼š</p>

<ol>
  <li><strong>æ¥å£ä½œç”¨</strong>ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETRESOURCES</code> ç”¨äºè·å–ä¸ DRM è®¾å¤‡ç›¸å…³çš„èµ„æºä¿¡æ¯ã€‚</li>
      <li>è¿™ä¸ªæ¥å£é€šå¸¸ç”¨äºæŸ¥è¯¢è®¾å¤‡çš„å¸§ç¼“å†²ã€è¿æ¥å™¨ã€CRTCï¼ˆæ˜¾ç¤ºç®¡é“ï¼‰å’Œç¼–ç å™¨çš„æ•°é‡å’Œæ ‡è¯†ç¬¦ã€‚</li>
    </ul>
  </li>
  <li><strong>å®ç°ç»†èŠ‚</strong>ï¼š
    <ul>
      <li>ç”¨æˆ·ç©ºé—´ç¨‹åºå¯ä»¥é€šè¿‡æ‰§è¡Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETRESOURCES</code> æ¥è·å–èµ„æºä¿¡æ¯ã€‚</li>
      <li>è¿”å›çš„ç»“æ„ä½“ <code class="language-plaintext highlighter-rouge">drm_mode_card_res</code> åŒ…å«äº†å¸§ç¼“å†²ã€è¿æ¥å™¨ã€CRTC å’Œç¼–ç å™¨çš„æ•°é‡ä»¥åŠç›¸åº”çš„æ ‡è¯†ç¬¦ã€‚</li>
      <li>è¿™ä¸ªæ¥å£å¯¹äºåˆå§‹åŒ–æ˜¾ç¤ºç®¡é“ã€èµ„æºç®¡ç†å’Œæ¨¡å¼è®¾ç½®éå¸¸é‡è¦ã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_getplaneresources">DRM_IOCTL_MODE_GETPLANERESOURCES</h2>

<p>å®ƒç”¨äºè·å–Direct Rendering Manager (DRM)çš„èµ„æºã€‚DRMæ˜¯Linuxå†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£å¤„ç†å›¾å½¢ç¡¬ä»¶çš„åº•å±‚ç»†èŠ‚ã€‚</p>

<p>åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETPLANERESOURCES</code>æ—¶ï¼Œä½ éœ€è¦æ‰“å¼€ä¸€ä¸ªDRMè®¾å¤‡ï¼ˆä¾‹å¦‚<code class="language-plaintext highlighter-rouge">/dev/dri/card0</code>ï¼‰ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªioctlè°ƒç”¨æ¥è·å–èµ„æºã€‚è¿™äº›èµ„æºåŒ…æ‹¬å¸§ç¼“å†²åŒºï¼ˆframebuffersï¼‰ã€CRTCï¼ˆCathode Ray Tube Controllerï¼‰ã€è¿æ¥å™¨ï¼ˆconnectorsï¼‰å’Œç¼–ç å™¨ï¼ˆencodersï¼‰ã€‚</p>

<p>è¿™äº›èµ„æºçš„å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
  <li><strong>å¸§ç¼“å†²åŒºï¼ˆFramebuffersï¼‰</strong>ï¼šå®ƒä»¬åŒ…å«è¦æ˜¾ç¤ºçš„åƒç´ æ•°æ®ã€‚</li>
  <li><strong>CRTC</strong>ï¼šCRTCä»£è¡¨æ•´ä¸ªæ˜¾ç¤ºç®¡é“ï¼Œå®ƒä»ä¸€ä¸ªæˆ–å¤šä¸ªå¹³é¢è·å–åƒç´ æ•°æ®è¿›è¡Œæ··åˆã€‚</li>
  <li><strong>è¿æ¥å™¨ï¼ˆConnectorsï¼‰</strong>ï¼šåœ¨DRMä¸­ï¼Œè¿æ¥å™¨æ˜¯æ˜¾ç¤ºæ¥æ”¶å™¨çš„ä¸€èˆ¬æŠ½è±¡ï¼ŒåŒ…æ‹¬å›ºå®šé¢æ¿æˆ–ä»»ä½•å…¶ä»–å¯ä»¥ä»¥æŸç§å½¢å¼æ˜¾ç¤ºåƒç´ çš„è®¾å¤‡ã€‚</li>
  <li><strong>ç¼–ç å™¨ï¼ˆEncodersï¼‰</strong>ï¼šç¼–ç å™¨ä»CRTCè·å–åƒç´ æ•°æ®ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä»»ä½•è¿æ¥çš„è¿æ¥å™¨å¯ä»¥æ¥å—çš„æ ¼å¼ã€‚</li>
</ul>

<p>è¯·æ³¨æ„ï¼Œè¿™äº›èµ„æºçš„æ•°é‡å¯èƒ½ä¼šæ ¹æ®ä½ çš„ç¡¬ä»¶é…ç½®å’Œå½“å‰çš„æ˜¾ç¤ºè®¾ç½®è€Œå˜åŒ–ã€‚åœ¨ä½¿ç”¨è¿™äº›èµ„æºä¹‹å‰ï¼Œä½ å¯èƒ½éœ€è¦æ£€æŸ¥å®ƒä»¬çš„å¯ç”¨æ€§å’ŒçŠ¶æ€ã€‚ã€‚</p>

<h2 id="drm_ioctl_mode_getcrtc">DRM_IOCTL_MODE_GETCRTC</h2>

<p>æ˜¯ä¸€ç§ç”¨äºè·å–æœ‰å…³ç»™å®š CRTCï¼ˆCathode Ray Tube Controllerï¼‰çš„ä¿¡æ¯çš„ IOCTLï¼ˆInput/Output Controlï¼‰å‘½ä»¤ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>CRTC æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li>CRTC æ˜¯æ˜¾ç¤ºæ§åˆ¶å™¨ï¼Œè´Ÿè´£å°†å›¾å½¢æ•°æ®å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼ˆä¾‹å¦‚æ˜¾ç¤ºå™¨æˆ–ç”µè§†ï¼‰ã€‚</li>
      <li>å®ƒç®¡ç†åƒç´ æ—¶é’Ÿã€æ‰«æçº¿å’Œå¸§ç¼“å†²åŒºçš„åˆ·æ–°ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_GETCRTC çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
      <li>è¿™äº›ä¿¡æ¯å¯èƒ½åŒ…æ‹¬ CRTC çš„å½“å‰æ¨¡å¼ã€åˆ†è¾¨ç‡ã€åˆ·æ–°ç‡ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETOUTPUT</code>ï¼šè·å–æœ‰å…³ç‰¹å®šè¾“å‡ºçš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_setcrtc">DRM_IOCTL_MODE_SETCRTC</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è®¾ç½®ç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„å‚æ•°ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>CRTC æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>CRTC</strong> æ˜¯æ˜¾ç¤ºæ§åˆ¶å™¨ï¼Œè´Ÿè´£å°†å›¾å½¢æ•°æ®å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼ˆä¾‹å¦‚æ˜¾ç¤ºå™¨æˆ–ç”µè§†ï¼‰ã€‚</li>
      <li>å®ƒç®¡ç†åƒç´ æ—¶é’Ÿã€æ‰«æçº¿å’Œå¸§ç¼“å†²åŒºçš„åˆ·æ–°ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_SETCRTC çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è®¾ç½®ç‰¹å®š CRTC çš„å‚æ•°ï¼Œä¾‹å¦‚åˆ†è¾¨ç‡ã€åˆ·æ–°ç‡ç­‰ã€‚</li>
      <li>è¿™å¯¹äºé…ç½®æ˜¾ç¤ºè¾“å‡ºéå¸¸é‡è¦ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_getplane">DRM_IOCTL_MODE_GETPLANE</h2>

<p>ç”¨äºä» <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è·å–ç‰¹å®š <strong>å¹³é¢ï¼ˆPlaneï¼‰</strong> çš„ä¿¡æ¯ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>DRM_IOCTL_MODE_GETPLANE çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETPLANE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è·å–æœ‰å…³ç‰¹å®šå¹³é¢çš„ä¿¡æ¯ã€‚</li>
      <li>è¿™äº›ä¿¡æ¯å¯èƒ½åŒ…æ‹¬å¹³é¢çš„å½“å‰çŠ¶æ€ã€ä½ç½®ã€å¤§å°ã€åƒç´ æ ¼å¼ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETPLANE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_setplane">DRM_IOCTL_MODE_SETPLANE</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è®¾ç½®ç‰¹å®š <strong>å¹³é¢ï¼ˆPlaneï¼‰</strong> çš„å‚æ•°ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>DRM_IOCTL_MODE_SETPLANE çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETPLANE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è®¾ç½®ç‰¹å®šå¹³é¢çš„å‚æ•°ï¼Œä¾‹å¦‚åˆ†è¾¨ç‡ã€åˆ·æ–°ç‡ç­‰ã€‚</li>
      <li>è¿™å¯¹äºé…ç½®æ˜¾ç¤ºè¾“å‡ºéå¸¸é‡è¦ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETPLANE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="cursor">Cursor</h1>

<h2 id="drm_ioctl_mode_cursor">DRM_IOCTL_MODE_CURSOR</h2>

<p>ç”¨äºæ“ä½œç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„ <strong>å…‰æ ‡å¹³é¢ï¼ˆCursor Planeï¼‰</strong>ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>CRTC æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>CRTC</strong> æ˜¯æ˜¾ç¤ºæ§åˆ¶å™¨ï¼Œè´Ÿè´£å°†å›¾å½¢æ•°æ®å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼ˆä¾‹å¦‚æ˜¾ç¤ºå™¨æˆ–ç”µè§†ï¼‰ã€‚</li>
      <li>å®ƒç®¡ç†åƒç´ æ—¶é’Ÿã€æ‰«æçº¿å’Œå¸§ç¼“å†²åŒºçš„åˆ·æ–°ã€‚</li>
    </ul>
  </li>
  <li><strong>å…‰æ ‡å¹³é¢ï¼ˆCursor Planeï¼‰çš„ä½œç”¨</strong>
    <ul>
      <li><strong>å…‰æ ‡å¹³é¢</strong> æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ˜¾ç¤ºå¹³é¢ï¼Œç”¨äºæ˜¾ç¤ºå…‰æ ‡æˆ–å…¶ä»–å°å‹å›¾å½¢å…ƒç´ ã€‚</li>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ“ä½œå…‰æ ‡å¹³é¢ï¼Œä¾‹å¦‚è®¾ç½®å…‰æ ‡çš„ä½ç½®ã€å¤§å°ã€å›¾åƒç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_cursor2">DRM_IOCTL_MODE_CURSOR2</h2>

<p>ç”¨äºæ“ä½œç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„ <strong>å…‰æ ‡å¹³é¢ï¼ˆCursor Planeï¼‰</strong>âµã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>CRTC æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>CRTC</strong> æ˜¯æ˜¾ç¤ºæ§åˆ¶å™¨ï¼Œè´Ÿè´£å°†å›¾å½¢æ•°æ®å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡ï¼ˆä¾‹å¦‚æ˜¾ç¤ºå™¨æˆ–ç”µè§†ï¼‰ã€‚</li>
      <li>å®ƒç®¡ç†åƒç´ æ—¶é’Ÿã€æ‰«æçº¿å’Œå¸§ç¼“å†²åŒºçš„åˆ·æ–°ã€‚</li>
    </ul>
  </li>
  <li><strong>å…‰æ ‡å¹³é¢ï¼ˆCursor Planeï¼‰çš„ä½œç”¨</strong>
    <ul>
      <li><strong>å…‰æ ‡å¹³é¢</strong> æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ˜¾ç¤ºå¹³é¢ï¼Œç”¨äºæ˜¾ç¤ºå…‰æ ‡æˆ–å…¶ä»–å°å‹å›¾å½¢å…ƒç´ ã€‚</li>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR2</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ“ä½œå…‰æ ‡å¹³é¢ï¼Œä¾‹å¦‚è®¾ç½®å…‰æ ‡çš„ä½ç½®ã€å¤§å°ã€å›¾åƒç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR2</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="åŒºåˆ«">åŒºåˆ«</h2>

<p><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR</code> å’Œ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR2</code> éƒ½æ˜¯ <strong>IOCTLï¼ˆInput/Output Controlï¼‰å‘½ä»¤</strong>ï¼Œç”¨äºæ“ä½œç‰¹å®š <strong>CRTCï¼ˆCathode Ray Tube Controllerï¼‰</strong> çš„ <strong>å…‰æ ‡å¹³é¢ï¼ˆCursor Planeï¼‰</strong>ã€‚å®ƒä»¬ä¹‹é—´çš„åŒºåˆ«å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>DRM_IOCTL_MODE_CURSOR</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR</code> æ˜¯æ—§ç‰ˆæœ¬çš„å‘½ä»¤ï¼Œç”¨äºè®¾ç½®å…‰æ ‡å¹³é¢çš„å‚æ•°ï¼Œä¾‹å¦‚å…‰æ ‡çš„ä½ç½®ã€å¤§å°ã€å›¾åƒç­‰ã€‚</li>
      <li>å®ƒéµå¾ªæ—§çš„å…‰æ ‡å¹³é¢æ“ä½œè¯­ä¹‰ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_CURSOR2</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR2</code> æ˜¯æ–°ç‰ˆæœ¬çš„å‘½ä»¤ï¼Œç”¨äºç›¸åŒçš„ç›®çš„ï¼Œä½†å¯èƒ½å…·æœ‰æ›´ä¸°å¯Œçš„åŠŸèƒ½ã€‚</li>
      <li>å®ƒå¯èƒ½æ”¯æŒæ›´å¤šå±æ€§ï¼Œä¾‹å¦‚æ›´çµæ´»çš„å…‰æ ‡å½¢çŠ¶ã€é€æ˜åº¦ç­‰ã€‚</li>
    </ul>
  </li>
</ol>

<p>æ€»ä¹‹ï¼Œ<code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR2</code> å¯èƒ½æ˜¯å¯¹ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CURSOR</code> çš„æ”¹è¿›æˆ–æ‰©å±•ï¼Œä»¥æä¾›æ›´å¥½çš„å…‰æ ‡å¹³é¢æ§åˆ¶ã€‚</p>

<h1 id="sync-obj">Sync Obj</h1>

<h2 id="drm_ioctl_syncobj_create">DRM_IOCTL_SYNCOBJ_CREATE</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­åˆ›å»º <strong>åŒæ­¥å¯¹è±¡ï¼ˆSync Objectï¼‰</strong>ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>åŒæ­¥å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>åŒæ­¥å¯¹è±¡</strong> æ˜¯ä¸€ç§ç”¨äºåè°ƒå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¹‹é—´çš„åŒæ­¥æœºåˆ¶ã€‚</li>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼ŒåŒæ­¥å¯¹è±¡é€šå¸¸ç”¨äºç¡®ä¿ä¸åŒå›¾å½¢æ“ä½œçš„æ‰§è¡Œé¡ºåºæˆ–é¿å…ç«æ€æ¡ä»¶ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_SYNCOBJ_CREATE çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_CREATE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åˆ›å»ºä¸€ä¸ªåŒæ­¥å¯¹è±¡ã€‚</li>
      <li>åŒæ­¥å¯¹è±¡å¯ä»¥ç”¨äºè·Ÿè¸ªå›¾å½¢æ“ä½œçš„å®ŒæˆçŠ¶æ€ï¼Œä¾‹å¦‚ç­‰å¾…æ¸²æŸ“å®Œæˆæˆ–ç­‰å¾…å…¶ä»–äº‹ä»¶ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_CREATE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_syncobj_handle_to_fd">DRM_IOCTL_SYNCOBJ_HANDLE_TO_FD</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­å°†ç‰¹å®š <strong>åŒæ­¥å¯¹è±¡ï¼ˆSync Objectï¼‰</strong> çš„å¥æŸ„è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ï¼ˆFile Descriptorï¼‰ã€‚</p>

<p>è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>åŒæ­¥å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>åŒæ­¥å¯¹è±¡</strong> æ˜¯ä¸€ç§ç”¨äºåè°ƒå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¹‹é—´çš„åŒæ­¥æœºåˆ¶ã€‚</li>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼ŒåŒæ­¥å¯¹è±¡é€šå¸¸ç”¨äºç¡®ä¿ä¸åŒå›¾å½¢æ“ä½œçš„æ‰§è¡Œé¡ºåºæˆ–é¿å…ç«æ€æ¡ä»¶ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_SYNCOBJ_HANDLE_TO_FD çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_HANDLE_TO_FD</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å°†åŒæ­¥å¯¹è±¡çš„å¥æŸ„è½¬æ¢ä¸ºæ–‡ä»¶æè¿°ç¬¦ã€‚</li>
      <li>æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ç§ç”¨äºåœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’å¥æŸ„çš„æœºåˆ¶ã€‚è¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸é€æ˜çš„ï¼Œåªèƒ½ç”¨äºä¼ é€’åŒæ­¥å¯¹è±¡å¥æŸ„ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_HANDLE_TO_FD</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_syncobj_signal">DRM_IOCTL_SYNCOBJ_SIGNAL</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­ç›´æ¥è§¦å‘ç‰¹å®š <strong>åŒæ­¥å¯¹è±¡ï¼ˆSync Objectï¼‰</strong>ã€‚è¿™ä¸ªå‘½ä»¤æä¾›äº†ä¸€ç§ç”¨æˆ·ç©ºé—´æ‰‹åŠ¨è§¦å‘åŒæ­¥å¯¹è±¡çš„æœºåˆ¶ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å…³äº <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_SIGNAL</code> çš„ä¸€äº›è¦ç‚¹ï¼š</p>

<ol>
  <li><strong>åŒæ­¥å¯¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>åŒæ­¥å¯¹è±¡</strong> æ˜¯ä¸€ç§ç”¨äºåè°ƒå¤šä¸ªå¹¶å‘ä»»åŠ¡ä¹‹é—´çš„åŒæ­¥æœºåˆ¶ã€‚</li>
      <li>åœ¨å›¾å½¢æ¸²æŸ“ä¸­ï¼ŒåŒæ­¥å¯¹è±¡é€šå¸¸ç”¨äºç¡®ä¿ä¸åŒå›¾å½¢æ“ä½œçš„æ‰§è¡Œé¡ºåºæˆ–é¿å…ç«æ€æ¡ä»¶ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_SYNCOBJ_SIGNAL çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_SIGNAL</code>ï¼Œç”¨æˆ·ç©ºé—´å¯ä»¥ç›´æ¥è§¦å‘ç‰¹å®šåŒæ­¥å¯¹è±¡ã€‚</li>
      <li>è¿™å¯¹äºæ‰‹åŠ¨è§¦å‘åŒæ­¥å¯¹è±¡éå¸¸æœ‰ç”¨ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_SYNCOBJ_SIGNAL</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h1 id="lease">Lease</h1>

<h2 id="drm_ioctl_mode_create_lease">DRM_IOCTL_MODE_CREATE_LEASE</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­åˆ›å»º <strong>ç§Ÿçº¦ï¼ˆLeaseï¼‰</strong>ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>ç§Ÿçº¦æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>ç§Ÿçº¦</strong> æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºç®¡ç†å›¾å½¢èµ„æºçš„å…±äº«å’Œè®¿é—®æƒé™ã€‚</li>
      <li>åœ¨å¤šä¸ªå›¾å½¢å®¢æˆ·ç«¯ä¹‹é—´ï¼Œç§Ÿçº¦å…è®¸æ§åˆ¶å¯¹ç‰¹å®šèµ„æºï¼ˆä¾‹å¦‚å¸§ç¼“å†²åŒºã€å¹³é¢ã€è¿æ¥å™¨ç­‰ï¼‰çš„è®¿é—®ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_CREATE_LEASE çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CREATE_LEASE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åˆ›å»ºä¸€ä¸ªç§Ÿçº¦ã€‚</li>
      <li>ç§Ÿçº¦å¯ä»¥ç”¨äºåè°ƒå¤šä¸ªå›¾å½¢å®¢æˆ·ç«¯ä¹‹é—´çš„èµ„æºå…±äº«ï¼Œä»¥ç¡®ä¿èµ„æºçš„æ­£ç¡®ä½¿ç”¨å’Œè®¿é—®æƒé™ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CREATE_LEASE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_list_lessees">DRM_IOCTL_MODE_LIST_LESSEES</h2>

<p>ç”¨äºä» <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è·å–ç‰¹å®š <strong>ç§Ÿçº¦ï¼ˆLeaseï¼‰</strong> æ‰€æœ‰ç§Ÿæˆ·ï¼ˆlesseesï¼‰çš„æ ‡è¯†ç¬¦ï¼ˆidentifiersï¼‰ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å…³äº <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_LIST_LESSEES</code> çš„ä¸€äº›è¦ç‚¹ï¼š</p>

<ol>
  <li><strong>ç§Ÿçº¦æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>ç§Ÿçº¦</strong> æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºç®¡ç†å›¾å½¢èµ„æºçš„å…±äº«å’Œè®¿é—®æƒé™ã€‚</li>
      <li>åœ¨å¤šä¸ªå›¾å½¢å®¢æˆ·ç«¯ä¹‹é—´ï¼Œç§Ÿçº¦å…è®¸æ§åˆ¶å¯¹ç‰¹å®šèµ„æºï¼ˆä¾‹å¦‚å¸§ç¼“å†²åŒºã€å¹³é¢ã€è¿æ¥å™¨ç­‰ï¼‰çš„è®¿é—®ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_LIST_LESSEES çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_LIST_LESSEES</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è·å–ç‰¹å®šç§Ÿçº¦çš„æ‰€æœ‰ç§Ÿæˆ·çš„æ ‡è¯†ç¬¦ã€‚</li>
      <li>è¿™å¯¹äºäº†è§£ç§Ÿçº¦çš„ä½¿ç”¨æƒ…å†µä»¥åŠèµ„æºå…±äº«éå¸¸æœ‰ç”¨ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_LIST_LESSEES</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GETCRTC</code>ï¼šè·å–æœ‰å…³ç‰¹å®š CRTC çš„ä¿¡æ¯ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_SETCRTC</code>ï¼šè®¾ç½® CRTC å‚æ•°ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_ADDFB</code>ï¼šæ·»åŠ æ–°çš„å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_RMFB</code>ï¼šç§»é™¤å¸§ç¼“å†²åŒºå¯¹è±¡ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_get_lease">DRM_IOCTL_MODE_GET_LEASE</h2>

<p>ç”¨äºä» <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­è·å–ç‰¹å®š <strong>ç§Ÿçº¦ï¼ˆLeaseï¼‰</strong> çš„ä¿¡æ¯ã€‚è¯¦æƒ…å¦‚ä¸‹ï¼š</p>

<ol>
  <li><strong>ç§Ÿçº¦æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>ç§Ÿçº¦</strong> æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºç®¡ç†å›¾å½¢èµ„æºçš„å…±äº«å’Œè®¿é—®æƒé™ã€‚</li>
      <li>åœ¨å¤šä¸ªå›¾å½¢å®¢æˆ·ç«¯ä¹‹é—´ï¼Œç§Ÿçº¦å…è®¸æ§åˆ¶å¯¹ç‰¹å®šèµ„æºï¼ˆä¾‹å¦‚å¸§ç¼“å†²åŒºã€å¹³é¢ã€è¿æ¥å™¨ç­‰ï¼‰çš„è®¿é—®ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_GET_LEASE çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GET_LEASE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥è·å–æœ‰å…³ç‰¹å®šç§Ÿçº¦çš„ä¿¡æ¯ã€‚</li>
      <li>è¿™äº›ä¿¡æ¯å¯èƒ½åŒ…æ‹¬ç§Ÿçº¦çš„çŠ¶æ€ã€ç§Ÿçº¦çš„èµ„æºåˆ—è¡¨ã€ç§Ÿçº¦çš„æŒæœ‰è€…ç­‰ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_GET_LEASE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CREATE_LEASE</code>ï¼šåˆ›å»ºç§Ÿçº¦ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_LIST_LESSEES</code>ï¼šåˆ—å‡ºç§Ÿçº¦çš„æ‰€æœ‰ç§Ÿæˆ·ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<h2 id="drm_ioctl_mode_revoke_lease">DRM_IOCTL_MODE_REVOKE_LEASE</h2>

<p>ç”¨äºåœ¨ <strong>Linux å†…æ ¸æ¨¡å¼è®¾ç½®ï¼ˆKMSï¼‰</strong> ä¸­æ’¤é”€ç‰¹å®š <strong>ç§Ÿçº¦ï¼ˆLeaseï¼‰</strong> çš„æƒé™ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å…³äº <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_REVOKE_LEASE</code> çš„ä¸€äº›è¦ç‚¹ï¼š</p>

<ol>
  <li><strong>ç§Ÿçº¦æ˜¯ä»€ä¹ˆï¼Ÿ</strong>
    <ul>
      <li><strong>ç§Ÿçº¦</strong> æ˜¯ä¸€ç§æœºåˆ¶ï¼Œç”¨äºç®¡ç†å›¾å½¢èµ„æºçš„å…±äº«å’Œè®¿é—®æƒé™ã€‚</li>
      <li>åœ¨å¤šä¸ªå›¾å½¢å®¢æˆ·ç«¯ä¹‹é—´ï¼Œç§Ÿçº¦å…è®¸æ§åˆ¶å¯¹ç‰¹å®šèµ„æºï¼ˆä¾‹å¦‚å¸§ç¼“å†²åŒºã€å¹³é¢ã€è¿æ¥å™¨ç­‰ï¼‰çš„è®¿é—®ã€‚</li>
    </ul>
  </li>
  <li><strong>DRM_IOCTL_MODE_REVOKE_LEASE çš„ä½œç”¨</strong>
    <ul>
      <li>é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_REVOKE_LEASE</code>ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ’¤é”€ç‰¹å®šç§Ÿçº¦çš„æƒé™ã€‚</li>
      <li>è¿™å¯¹äºé™åˆ¶èµ„æºçš„è®¿é—®æˆ–æ›´æ”¹ç§Ÿçº¦çš„çŠ¶æ€éå¸¸æœ‰ç”¨ã€‚</li>
    </ul>
  </li>
  <li><strong>å…¶ä»– DRM IOCTL å‘½ä»¤</strong>
    <ul>
      <li>é™¤äº† <code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_REVOKE_LEASE</code>ï¼Œè¿˜æœ‰å…¶ä»–ä¸æ˜¾ç¤ºè®¾ç½®ç›¸å…³çš„ IOCTL å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_CREATE_LEASE</code>ï¼šåˆ›å»ºç§Ÿçº¦ã€‚</li>
          <li><code class="language-plaintext highlighter-rouge">DRM_IOCTL_MODE_LIST_LESSEES</code>ï¼šåˆ—å‡ºç§Ÿçº¦çš„æ‰€æœ‰ç§Ÿæˆ·ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>]]></content><author><name>kevin</name></author><category term="DRM" /><summary type="html"><![CDATA[DRM_IOCTL_VERSION]]></summary></entry><entry><title type="html">è¿›ç¨‹å†…å­˜æ£€æŸ¥</title><link href="http://localhost:4000/blog/jekyll/2018-05-20-memory_check.html" rel="alternate" type="text/html" title="è¿›ç¨‹å†…å­˜æ£€æŸ¥" /><published>2018-05-20T00:00:00+08:00</published><updated>2018-05-20T00:00:00+08:00</updated><id>http://localhost:4000/blog/jekyll/memory_check</id><content type="html" xml:base="http://localhost:4000/blog/jekyll/2018-05-20-memory_check.html"><![CDATA[<h1 id="1è¿›ç¨‹å†…å­˜æ˜ å°„æ–‡ä»¶smaps">1.è¿›ç¨‹å†…å­˜æ˜ å°„æ–‡ä»¶smaps</h1>

<p>åœ¨å†…æ ¸çš„æ•°æ®ç»“æ„ä¸­ï¼Œè¿›ç¨‹ã€è¿›ç¨‹ä½¿ç”¨å†…å­˜ã€è™šæ‹Ÿå†…å­˜å—å’Œä¸€ä¸ªäºŒè¿›åˆ¶ç¨‹åºæ–‡ä»¶çš„å¯¹åº”å…³ç³»å›¾å¦‚ä¸‹ã€‚</p>

<p><img src="/blog/assets/memory_check/vm_area.png" alt="vm_area" /></p>

<p>æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">/proc/${PID}/smaps</code>ï¼Œå¯ä»¥å¾—åˆ°æ¯ä¸€ä¸ªvm_area_nodeçš„è¯¦ç»†ä¿¡æ¯ã€‚</p>

<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªå…·ä½“çš„<strong>vm_area_node</strong>ä¿¡æ¯ã€‚</p>

<p><img src="/blog/assets/memory_check/smap_file.png" alt="smaps" /></p>

<h2 id="11-ä¸¤ç§æ˜ å°„">1.1 ä¸¤ç§æ˜ å°„</h2>

<p>ä¸‹é¢ä¸¤ç§æ˜ å°„çš„ä»‹ç»ï¼Œæ˜¯ä¸ºäº†ä¸‹ä¸€èŠ‚è§£é‡Šå„å­—æ®µå«ä¹‰åšå‡†å¤‡ã€‚</p>

<ul>
  <li>æ–‡ä»¶æ˜ å°„</li>
</ul>

<p>å°±æ˜¯å­˜å‚¨ä»‹è´¨(æ¯”å¦‚ï¼šç£ç›˜)ä¸­çš„æ•°æ®é€šè¿‡æ–‡ä»¶ç³»ç»Ÿæ˜ å°„åˆ°å†…å­˜å†é€šè¿‡æ–‡ä»¶æ˜ å°„æ˜ å°„åˆ°è™šæ‹Ÿç©ºé—´ï¼Œè¿™æ ·ï¼Œç”¨æˆ·å°±å¯ä»¥åœ¨ç”¨æˆ·ç©ºé—´é€šè¿‡ open, read, write ç­‰å‡½æ•°åŒºæ“ä½œæ–‡ä»¶å†…å®¹ã€‚ä»£ç ä¸­å‡½æ•°open(), read(), write(), close(), mmap(fdï¼Œâ€¦)â€¦ æ“ä½œçš„è™šæ‹Ÿåœ°å€éƒ½å±äºæ–‡ä»¶æ˜ å°„ã€‚</p>

<ul>
  <li>åŒ¿åæ˜ å°„</li>
</ul>

<p>å°±æ˜¯ç”¨æˆ·ç©ºé—´è¦æ±‚å†…æ ¸åˆ†é…ä¸€å®šçš„ç‰©ç†å†…å­˜æ¥å­˜å‚¨æ•°æ®ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¸å±äºä»»ä½•æ–‡ä»¶ã€‚å†…æ ¸å°±ä½¿ç”¨åŒ¿åæ˜ å°„å°†å†…å­˜ä¸­çš„æŸæ®µç‰©ç†åœ°å€ä¸ç”¨æˆ·ç©ºé—´ä¸€ä¸€æ˜ å°„ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ç”¨ç›´æ¥æ“ä½œè™šæ‹Ÿåœ°å€æ¥èŒƒå›´è¿™æ®µç‰©ç†å†…å­˜ã€‚æ¯”å¦‚ä½¿ç”¨malloc(), mmap(NULLï¼Œâ€¦)ç”³è¯·å†…å­˜ã€‚</p>

<h2 id="12-å„å­—æ®µå«ä¹‰">1.2 å„å­—æ®µå«ä¹‰</h2>

<ul>
  <li><span style="background-color: yellow">ç¬¬ä¸€è¡Œ</span></li>
</ul>

<p><img src="/blog/assets/memory_check/vm_area_node_head.png" alt="smaps_head" /></p>

<blockquote>
  <ol>
    <li><span style="color:hotpink;">08048000-080bc000</span>: è¯¥è™šæ‹Ÿå†…å­˜æ®µçš„å¼€å§‹å’Œç»“æŸä½ç½®</li>
    <li><span style="color:orange">r-xp</span>:å†…å­˜æ®µçš„æƒé™ï¼Œåˆ†åˆ«æ˜¯å¯è¯»ã€å¯å†™ã€å¯è¿è¡Œã€ç§æœ‰æˆ–å…±äº«ï¼Œæœ€åä¸€ä½pä»£è¡¨ç§æœ‰ï¼Œsä»£è¡¨å…±äº«(å¦‚å…±äº«çš„å†…å­˜ï¼Œ shm). å¦‚æœæœ‰â€wâ€ï¼Œè¡¨ç¤ºæ˜¯åº“çš„æ•°æ®åŒº.</li>
    <li><span style="color:green">00000000</span>: è™šæ‹Ÿå†…å­˜æ®µèµ·å§‹åœ°å€åœ¨å¯¹åº”çš„æ˜ å°„æ–‡ä»¶ä¸­ä»¥é¡µä¸ºå•ä½çš„åç§»é‡ï¼Œ
å¯¹åŒ¿åæ˜ å°„ï¼Œå®ƒç­‰äº0æˆ–è€…vm_start/PAGE_SIZE</li>
    <li><span style="color:orangered;">03:02</span>: æ–‡ä»¶çš„ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ã€‚
å¯¹æœ‰åæ˜ å°„æ¥è¯´ï¼Œæ˜¯æ˜ å°„çš„æ–‡ä»¶æ‰€åœ¨è®¾å¤‡çš„è®¾å¤‡å·
å¯¹åŒ¿åæ˜ å°„æ¥è¯´ï¼Œå› ä¸ºæ²¡æœ‰æ–‡ä»¶åœ¨ç£ç›˜ä¸Šï¼Œæ‰€ä»¥æ²¡æœ‰è®¾å¤‡å·ï¼Œå§‹ç»ˆä¸º00:00ã€‚</li>
    <li><span style="color:blue;">13130</span>: è¢«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜çš„æ–‡ä»¶çš„ç´¢å¼•èŠ‚ç‚¹å·,é€šè¿‡è¯¥èŠ‚ç‚¹å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œ
å¯¹åŒ¿åæ˜ å°„æ¥è¯´ï¼Œå› ä¸ºæ²¡æœ‰æ–‡ä»¶åœ¨ç£ç›˜ä¸Šï¼Œæ‰€ä»¥ä¸º0</li>
    <li><strong>/bin/bash</strong>: è¢«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜çš„æ–‡ä»¶åç§°ã€‚åé¢å¸¦(deleted)çš„æ˜¯å†…å­˜æ•°æ®ï¼Œå¯ä»¥è¢«é”€æ¯ã€‚
å¯¹æœ‰åæ˜ å°„æ¥è¯´ï¼Œæ˜¯æ˜ å°„çš„æ–‡ä»¶åã€‚
å¯¹åŒ¿åæ˜ å°„æ¥è¯´ï¼Œæ˜¯æ­¤æ®µè™šæ‹Ÿå†…å­˜åœ¨è¿›ç¨‹ä¸­çš„è§’è‰²ã€‚[stack]è¡¨ç¤ºåœ¨è¿›ç¨‹ä¸­ä½œä¸ºæ ˆä½¿ç”¨ï¼Œ[heap]è¡¨ç¤ºå †ã€‚å…¶ä½™æƒ…å†µæ¯”å¦‚mmap(NULL, â€¦.)åˆ™æ— æ˜¾ç¤ºã€‚</li>
  </ol>
</blockquote>

<ul>
  <li>
    <p><span style="background-color: yellow">Size</span></p>

    <p>è™šæ‹Ÿå†…å­˜ç©ºé—´å¤§å°ã€‚ä½†æ˜¯è¿™ä¸ªå†…å­˜å€¼ä¸ä¸€å®šæ˜¯ç‰©ç†å†…å­˜å®é™…åˆ†é…çš„å¤§å°ï¼Œå› ä¸ºåœ¨ç”¨æˆ·æ€ä¸Šï¼Œè™šæ‹Ÿå†…å­˜æ€»æ˜¯å»¶è¿Ÿåˆ†é…çš„ã€‚è¿™ä¸ªå€¼è®¡ç®—ä¹Ÿéå¸¸ç®€å•ï¼Œå°±æ˜¯è¯¥VMAçš„å¼€       å§‹ä½ç½®å‡ç»“æŸä½ç½®ã€‚</p>

    <p><strong>å»¶è¿Ÿåˆ†é…</strong>:å°±æ˜¯å½“è¿›ç¨‹ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼ŒLinuxä¼šç»™ä»–å…ˆåˆ†é…é¡µï¼Œä½†æ˜¯å¹¶ä¸ä¼šåŒºå»ºç«‹é¡µä¸é¡µæ¡†çš„æ˜ å°„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å¹¶ä¸ä¼šåˆ†é…ç‰©ç†å†…å­˜ï¼Œè€Œå½“çœŸæ­£ä½¿ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªç¼ºé¡µå¼‚å¸¸ï¼Œç¡¬ä»¶è·³è½¬page faultå¤„ç†ç¨‹åºæ‰§è¡Œï¼Œåœ¨å…¶ä¸­åˆ†é…ç‰©ç†å†…å­˜ï¼Œç„¶åä¿®æ”¹é¡µè¡¨(åˆ›å»ºé¡µè¡¨é¡¹)ã€‚å¼‚å¸¸å¤„ç†å®Œæ¯•ï¼Œè¿”å›ç¨‹åºç”¨æˆ·æ€ï¼Œç»§ç»­æ‰§è¡Œã€‚</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Rss</span> resident set size</p>

    <p>å®é™…åˆ†é…çš„å†…å­˜ï¼Œè¿™éƒ¨åˆ†ç‰©ç†å†…å­˜å·²ç»åˆ†é…ï¼Œä¸éœ€è¦ç¼ºé¡µä¸­æ–­å°±å¯ä»¥ä½¿ç”¨çš„ã€‚<strong>ä½†å¯èƒ½æ˜¯å’Œå…¶ä»–è¿›ç¨‹å…±äº«çš„</strong>ã€‚</p>

    <p>è¿™é‡Œæœ‰ä¸€ä¸ªå…¬å¼è®¡ç®—Rssï¼š</p>
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Rss</span><span class="o">=</span><span class="n">Shared_Clean</span><span class="o">+</span><span class="n">Shared_Dirty</span><span class="o">+</span><span class="n">Private_Clean</span><span class="o">+</span><span class="n">Private_Dirty</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p><span style="background-color: yellow">Shared_Clean</span>  <span style="background-color: yellow">Shared_Dirty</span>   <span style="background-color: yellow">Private_Clean</span>  <span style="background-color: yellow">Private_Dirty</span></p>

    <p>share/privateï¼šè¡¨ç¤ºè¯¥é¡µé¢æ˜¯å…±äº«è¿˜æ˜¯ç§æœ‰ã€‚</p>

    <p>dirty/cleanï¼š è¡¨ç¤ºè¯¥é¡µé¢æ˜¯å¦è¢«ä¿®æ”¹è¿‡ï¼Œå¦‚æœä¿®æ”¹è¿‡ï¼ˆdirtyï¼‰ï¼Œåœ¨é¡µé¢è¢«æ·˜æ±°çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠè¯¥è„é¡µé¢å›å†™åˆ°äº¤æ¢åˆ†åŒº(æ¢å‡ºï¼Œswap out)ã€‚æœ‰ ä¸€ä¸ªæ ‡å¿—ä½ç”¨äºè¡¨ç¤ºé¡µé¢æ˜¯å¦dirtyã€‚</p>

    <p>share/private_dirty/clean è®¡ç®—é€»è¾‘ï¼š</p>

    <p>æŸ¥çœ‹è¯¥pageçš„å¼•ç”¨æ•°ï¼Œå¦‚æœå¼•ç”¨&gt;1ï¼Œåˆ™å½’ä¸ºsharedï¼Œå¦‚æœæ˜¯1ï¼Œåˆ™å½’ä¸ºprivateï¼Œå†æŸ¥çœ‹è¯¥pageçš„flagï¼Œæ˜¯å¦æ ‡è®°ä¸º_PAGE_DIRTYï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è®¤ä¸ºå¹²å‡€çš„</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Pss</span> proportional set size</p>

    <p>å¹³æ‘Šè®¡ç®—åçš„å®é™…ç‰©ç†ä½¿ç”¨å†…å­˜(æœ‰äº›å†…å­˜ä¼šå’Œå…¶ä»–è¿›ç¨‹å…±äº«ï¼Œä¾‹å¦‚mmapè¿›æ¥çš„)ã€‚å®é™…ä¸ŠåŒ…å«ä¸Šé¢private_clean+private_dirtyï¼Œå’ŒæŒ‰æ¯”ä¾‹å‡åˆ†çš„shared_cleanã€shared_dirtyã€‚</p>

    <p>ä¸¾ä¸ªè®¡ç®—Pssçš„ä¾‹å­ï¼š</p>

    <p>å¦‚æœè¿›ç¨‹Aæœ‰xä¸ªprivate_cleané¡µé¢ï¼Œæœ‰yä¸ªprivate_dirtyé¡µé¢ï¼Œæœ‰zä¸ªshared_cleanä»…å’Œè¿›ç¨‹Bå…±äº«ï¼Œæœ‰hä¸ªshared_dirtyé¡µé¢å’Œè¿›ç¨‹Bã€Cå…±äº«ã€‚é‚£ä¹ˆè¿›ç¨‹Açš„Pssä¸ºï¼šx + y + z/2 + h/3</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Referenced</span></p>

    <p>å½“å‰é¡µé¢è¢«æ ‡è®°ä¸ºå·²å¼•ç”¨æˆ–è€…åŒ…å«åŒ¿åæ˜ å°„ï¼ˆThe amount of memory currently marked as referenced or a mapping associated with a file may contain anonymous pagesï¼‰ã€‚åœ¨Linuxå†…å­˜ç®¡ç†çš„é¡µé¢æ›¿æ¢ç®—æ³•ä¸­ï¼Œå½“æŸä¸ªé¡µé¢è¢«è®¿é—®åï¼ŒReferencedæ ‡å¿—è¢«è®¾ç½®ï¼Œå¦‚æœè¯¥æ ‡å¿—è®¾ç½®äº†ï¼Œå°±ä¸èƒ½å°†è¯¥é¡µç§»å‡ºã€‚</p>
  </li>
  <li>
    <p><span style="background-color: yellow">Anonymous</span></p>

    <p>åŒ¿åæ˜ å°„çš„ç‰©ç†å†…å­˜ï¼Œè¿™éƒ¨åˆ†å†…å­˜ä¸æ˜¯æ¥è‡ªäºæ–‡ä»¶ã€‚</p>
  </li>
  <li>
    <p><span style="background-color: yellow">VmFlags</span></p>

    <p>vm_areaçš„å„ç§å±æ€§ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>

    <p><img src="/blog/assets/memory_check/vmflags.png" alt="vmflags" width="400px" height="450px" /></p>
  </li>
</ul>

<h2 id="13-ä¸åŒå˜é‡çš„ä½ç½®">1.3 ä¸åŒå˜é‡çš„ä½ç½®</h2>

<p>ä¸€ä¸ªåº“æ˜ å°„åˆ°å†…å­˜ï¼Œ ä¸€èˆ¬åˆ†ä¸ºä»£ç æ®µã€æ•°æ®æ®µå’Œåªè¯»æ•°æ®æ®µ</p>
<ul>
  <li>r- --p: soä¸­çš„å­—ç¬¦ä¸²å¸¸æ•°</li>
  <li>rw--p: soä¸­çš„å…¨å±€å˜é‡ï¼Œé™æ€å˜é‡</li>
  <li>r- -xp: soçš„ä»£ç æ®µï¼Œå¸¸é‡</li>
  <li>- ---p: è¡¨ç¤ºè¯¥ VMA æ˜¯ç§æœ‰çš„ï¼Œä¸å¯æ‰§è¡Œï¼Œä¸”ä¸å¯è¯»å†™. è¿™é€šå¸¸ç”¨äºä¿æŠ¤æ•æ„Ÿæ•°æ®æˆ–ä»£ç ï¼Œé˜²æ­¢å…¶è¢«ä¿®æ”¹æˆ–æ‰§è¡Œ</li>
</ul>

<p>ä¸‹é¢è¿™æ®µä»£ç å±•ç¤ºäº†ä¸åŒå˜é‡çš„å­˜å‚¨ä½ç½®ï¼š</p>

<p><img src="/blog/assets/memory_check/variable_location.png" alt="variable" width="650px" height="450px" /></p>

<h1 id="2free-å‘½ä»¤">2.free å‘½ä»¤</h1>

<p>free å‘½ä»¤ç”¨äºæ˜¾ç¤ºç³»ç»Ÿçš„å†…å­˜çŠ¶æ€ï¼ŒåŒ…æ‹¬ç‰©ç†å†…å­˜ã€äº¤æ¢å†…å­˜ï¼ˆswapï¼‰å’Œå†…æ ¸ç¼“å†²åŒºå†…å­˜ã€‚è¯¦ç»†è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<p><img src="/blog/assets/memory_check/free.png" alt="variable" width="650px" height="60px" /></p>

<ul>
  <li>Mem è¡Œï¼ˆç¬¬äºŒè¡Œï¼‰æ˜¾ç¤ºäº†å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚</li>
  <li>
    <p>Swapè¡Œï¼ˆç¬¬ä¸‰è¡Œï¼‰æ˜¾ç¤ºäº†äº¤æ¢ç©ºé—´çš„ä½¿ç”¨æƒ…å†µã€‚</p>
  </li>
  <li>total: è¡¨ç¤ºç³»ç»Ÿæ€»çš„å¯ç”¨<u>ç‰©ç†å†…å­˜</u>å’Œ<u>äº¤æ¢ç©ºé—´</u>å¤§å°ã€‚</li>
  <li>used : è¡¨ç¤ºå·²ç»è¢«ä½¿ç”¨çš„<u>ç‰©ç†å†…å­˜</u>å’Œ<u>äº¤æ¢ç©ºé—´</u>ã€‚</li>
  <li>free : è¡¨ç¤ºè¿˜æœ‰å¤šå°‘<u>ç‰©ç†å†…å­˜</u>å’Œ<u>äº¤æ¢ç©ºé—´</u>å¯ç”¨ä½¿ç”¨ã€‚</li>
  <li>shared: æ˜¾ç¤ºè¢«å…±äº«ä½¿ç”¨çš„<u>ç‰©ç†å†…å­˜</u>å¤§å°ã€‚</li>
  <li>buff/cache: æ˜¾ç¤ºè¢« buffer å’Œ cache ä½¿ç”¨çš„ç‰©<u>ç†å†…å­˜</u>å¤§å°ã€‚</li>
  <li>available: æ˜¾ç¤ºè¿˜å¯ä»¥è¢«åº”ç”¨ç¨‹åºä½¿ç”¨çš„<u>ç‰©ç†å†…å­˜</u>å¤§å°ã€‚</li>
</ul>

<h2 id="21-bufferä¸cache">2.1 bufferä¸cache</h2>

<ul>
  <li>
    <p><span style="background-color: yellow">buffer</span>: ç¼“<font style="color:red">å†²</font>åŒº</p>

    <p>CPU åœ¨è¿›è¡Œä¸€ç³»åˆ—æ“ä½œæ—¶ï¼Œå…ˆåœ¨å†…å­˜çš„ä¸€å—åŒºåŸŸè¿›è¡Œï¼Œä¸€ç³»åˆ—æ“ä½œå®Œæˆåï¼Œå†ä¸€æ¬¡æ€§æŠŠè¯¥å†…å­˜åŒºåŸŸæäº¤ç»™å¤–éƒ¨è®¾å¤‡ï¼Œæ¥å¯¹è¿™ä¸ªåŒºåŸŸæ“ä½œã€‚</p>

    <p>æ¯”å¦‚å†™ä¸€å †æ•°æ®ç»™ç¡¬ç›˜ï¼Œå°±å…ˆå†™åˆ°å†…å­˜çš„ä¸€å—åŒºåŸŸï¼Œå†™å¥½åä¸€æ¬¡å†™å›åˆ°ç¡¬ç›˜ã€‚åˆæ¯”å¦‚è¯»æ•°æ®ï¼Œå…ˆåœ¨å†…å­˜åˆ’å‡ºä¸€å—åŒºåŸŸï¼Œè®©ç¡¬ç›˜æ§åˆ¶å™¨å†™æ•°æ®åˆ°è¿™å—åŒºåŸŸï¼Œå†™å¥½åï¼ŒCPU ç›´æ¥è®¿é—®è¯¥åŒºåŸŸå¾—åˆ°æ•°æ®ã€‚è¿™ä¸ªå†…å­˜åŒºåŸŸå°±å«buffer</p>

    <p>ç¼“å†²åŒºæ˜¯å†…å­˜æˆ–å­˜å‚¨çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºåœ¨ç­‰å¾…ä»è¾“å…¥è®¾å¤‡ä¼ è¾“åˆ°è¾“å‡ºè®¾å¤‡æ—¶å­˜æ”¾é¡¹ç›®ã€‚</p>

    <p>æ“ä½œç³»ç»Ÿé€šå¸¸åœ¨æ‰“å°æ–‡æ¡£æ—¶ä½¿ç”¨ç¼“å†²åŒºã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæ’é˜Ÿï¼ˆspoolingï¼‰ï¼Œå®ƒå°†è¦æ‰“å°çš„æ–‡æ¡£å‘é€åˆ°ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯ç«‹å³å‘é€åˆ°æ‰“å°æœºã€‚å¦‚æœæ‰“å°æœºæ²¡æœ‰è‡ªå·±çš„å†…éƒ¨å­˜å‚¨å™¨ï¼Œæˆ–è€…å†…å­˜å·²æ»¡ï¼Œæ“ä½œç³»ç»Ÿçš„ç¼“å†²åŒºä¼šä¿å­˜ç­‰å¾…æ‰“å°çš„ä¿¡æ¯ï¼ŒåŒæ—¶æ‰“å°æœºä»¥è‡ªå·±çš„é€Ÿåº¦ä»ç¼“å†²åŒºæ‰“å°ã€‚</p>

    <p>é€šè¿‡å°†æ–‡æ¡£æ’é˜Ÿåˆ°ç¼“å†²åŒºï¼Œå¤„ç†å™¨å¯ä»¥ç»§ç»­è§£é‡Šå’Œæ‰§è¡ŒæŒ‡ä»¤ï¼ŒåŒæ—¶æ‰“å°æœºè¿›è¡Œæ‰“å°ã€‚è¿™ä½¿ç”¨æˆ·å¯ä»¥åœ¨æ‰“å°æœºæ‰“å°æ—¶ç»§ç»­åœ¨è®¡ç®—æœºä¸Šè¿›è¡Œå…¶ä»–ä»»åŠ¡ã€‚å¤šä¸ªæ‰“å°ä½œä¸šåœ¨ç¼“å†²åŒºä¸­æ’é˜Ÿï¼ˆå‘éŸ³ä¸ºâ€œQâ€ï¼‰ã€‚ä¸€ä¸ªåä¸º<strong>æ‰“å°æ’é˜Ÿç¨‹åºï¼ˆprint spoolerï¼‰</strong>çš„ç¨‹åºæ‹¦æˆªæ“ä½œç³»ç»Ÿä¸­è¦æ‰“å°çš„æ–‡æ¡£ï¼Œå¹¶å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­</p>
  </li>
  <li>
    <p><span style="background-color: yellow">cache</span>ï¼šç¼“<font style="color:red">å­˜</font></p>

    <p>CPU è¦è®¿é—®ä¸€å—æ•°æ®æ—¶ï¼Œé¦–å…ˆè®¿é—®å†…å­˜çš„æŸä¸ªåŒºåŸŸï¼Œçœ‹æ˜¯å¦æœ‰è¯¥æ•°æ®çš„ç¼“å­˜ï¼Œæœ‰åˆ™ç›´æ¥è®¿é—®ï¼Œæ²¡æœ‰åˆ™è®¿é—®å®ƒçš„æ¥æºåœ°ã€‚
   CPU åˆ©ç”¨å†…å­˜æˆ–é«˜é€Ÿç¼“å­˜å¯¹æ•°æ®çš„å†å¤‡ä»½ï¼Œä¸ºä»¥åçš„å†æ¬¡è®¿é—®æä¾›æ–¹ä¾¿</p>

    <p>ç¼“å­˜å¦‚ä»Šçš„å¤§å¤šæ•°è®¡ç®—æœºé€šè¿‡ç¼“å­˜ï¼ˆå‘éŸ³ä¸ºâ€œcashâ€ï¼‰æ¥æé«˜å¤„ç†é€Ÿåº¦ã€‚</p>

    <p>ç¼“å­˜æœ‰ä¸¤ç§ä¸»è¦ç±»å‹ï¼šå†…å­˜ç¼“å­˜å’Œç£ç›˜ç¼“å­˜ã€‚è®©æˆ‘ä»¬è¯¦ç»†äº†è§£ä¸€ä¸‹å†…å­˜ç¼“å­˜ã€‚</p>

    <p>L1 ç¼“å­˜ï¼š</p>

    <p>L1 ç¼“å­˜ç›´æ¥å†…ç½®åœ¨å¤„ç†å™¨èŠ¯ç‰‡ä¸­ã€‚     <br />
   å®ƒé€šå¸¸å®¹é‡å¾ˆå°ï¼ŒèŒƒå›´ä» 8 KB åˆ° 128 KBã€‚
   L1 ç¼“å­˜å­˜å‚¨ç»å¸¸ä½¿ç”¨çš„æŒ‡ä»¤å’Œæ•°æ®ï¼Œä»¥ä¾¿å¿«é€Ÿè®¿é—®ã€‚</p>

    <p>L2 ç¼“å­˜ï¼š</p>

    <p>L2 ç¼“å­˜æ¯” L1 ç¼“å­˜ç¨æ…¢ï¼Œä½†å®¹é‡æ›´å¤§ã€‚
   å®ƒçš„å¤§å°èŒƒå›´ä» 64 KB åˆ° 16 MBã€‚
   ä¸€äº›ç°ä»£å¤„ç†å™¨åŒ…æ‹¬é«˜çº§ä¼ è¾“ç¼“å­˜ï¼Œè¿™æ˜¯ä¸€ç§ç›´æ¥å†…ç½®åœ¨å¤„ç†å™¨èŠ¯ç‰‡ä¸Šçš„ L2 ç¼“å­˜ç±»å‹ã€‚
   ä½¿ç”¨é«˜çº§ä¼ è¾“ç¼“å­˜çš„å¤„ç†å™¨çš„æ€§èƒ½æ¯”ä¸ä½¿ç”¨å®ƒçš„å¤„ç†å™¨è¦å¿«å¾—å¤šã€‚
   ç°ä»Šçš„ä¸ªäººè®¡ç®—æœºé€šå¸¸å…·æœ‰ 512 KB åˆ° 12 MB çš„é«˜çº§ä¼ è¾“ç¼“å­˜ã€‚</p>

    <p>ç¼“å­˜é€šè¿‡å­˜å‚¨ç»å¸¸ä½¿ç”¨çš„æŒ‡ä»¤å’Œæ•°æ®æ¥æ˜¾è‘—åŠ å¿«å¤„ç†æ—¶é—´ã€‚</p>

    <p>å½“å¤„ç†å™¨éœ€è¦ä¸€æ¡æŒ‡ä»¤æˆ–æ•°æ®æ—¶ï¼Œå®ƒæŒ‰ç…§ä»¥ä¸‹é¡ºåºæœç´¢å†…å­˜ï¼šL1 ç¼“å­˜ï¼Œç„¶åæ˜¯ L2 ç¼“å­˜ï¼Œç„¶åæ˜¯ RAMã€‚</p>

    <p>å¦‚æœæ‰€éœ€ä¿¡æ¯åœ¨å†…å­˜ä¸­æ‰¾ä¸åˆ°ï¼Œå¤„ç†å™¨å¿…é¡»æœç´¢é€Ÿåº¦è¾ƒæ…¢çš„å­˜å‚¨ä»‹è´¨ï¼Œä¾‹å¦‚ç¡¬ç›˜æˆ–å…‰ç›˜ã€‚</p>
  </li>
</ul>

<h2 id="22-æ‰‹åŠ¨é‡Šæ”¾ç¼“å­˜">2.2. æ‰‹åŠ¨é‡Šæ”¾ç¼“å­˜</h2>

<ol>
  <li>é¦–å…ˆï¼Œ<u>ä½¿ç”¨syncå‘½ä»¤å°†æœªå†™å…¥ç£ç›˜çš„æ•°æ®åŒæ­¥åˆ°ç£ç›˜ï¼Œä»¥ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§ã€‚</u></li>
  <li>ç„¶åï¼Œé€šè¿‡è®¾ç½®/proc/sys/vm/drop_cachesæ¥é‡Šæ”¾å†…å­˜ç¼“å­˜ï¼š
    <ul>
      <li>echo 1 &gt; /proc/sys/vm/drop_cachesï¼šé‡Šæ”¾é¡µç¼“å­˜ã€‚</li>
      <li>echo 2 &gt; /proc/sys/vm/drop_cachesï¼šé‡Šæ”¾ dentries å’Œ inodesã€‚</li>
      <li>echo 3 &gt; /proc/sys/vm/drop_cachesï¼šé‡Šæ”¾æ‰€æœ‰ç¼“å­˜ã€‚</li>
    </ul>
  </li>
</ol>

<h1 id="3mtrace">3.mtrace</h1>

<p>mtrace æ˜¯ Linux ç³»ç»Ÿå†…æ ¸è‡ªå¸¦çš„ä¸€ä¸ªå†…å­˜è¿½è¸ªå‡½æ•°ã€‚å®ƒä¼šåœ¨æ¯ä¸ªå†…å­˜ç”³è¯·å‡½æ•°ï¼ˆmallocã€reallocã€callocï¼‰çš„ä½ç½®è®°å½•ä¸‹ä¿¡æ¯ï¼Œå¹¶åœ¨æ¯ä¸ªå†…å­˜é‡Šæ”¾çš„ä½ç½®è®°å½•ä¸‹ free çš„å†…å­˜ä¿¡æ¯ã€‚å…¶ä¸­åŒ…å«æœ‰å†…å­˜ç”³è¯·çš„åœ°å€ã€å†…å­˜ç”³è¯·çš„å¤§å°ã€é‡Šæ”¾å†…å­˜çš„åœ°å€ã€é‡Šæ”¾å†…å­˜çš„å¤§å°ã€‚</p>

<p>å…·ä½“æ¥è¯´ï¼Œmtrace å‡½æ•°çš„ä½œç”¨å¦‚ä¸‹ï¼š</p>

<ul>
  <li>å®‰è£…é’©å­å‡½æ•°ï¼Œç”¨äºè·Ÿè¸ªå†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚</li>
  <li>è®°å½•æœ‰å…³å†…å­˜åˆ†é…å’Œé‡Šæ”¾çš„è·Ÿè¸ªä¿¡æ¯ã€‚</li>
  <li>å¯ä»¥ç”¨äºå‘ç°ç¨‹åºä¸­çš„å†…å­˜æ³„æ¼å’Œè¯•å›¾é‡Šæ”¾æœªåˆ†é…å†…å­˜çš„æƒ…å†µã€‚</li>
</ul>

<p>ä½¿ç”¨æ–¹å¼ï¼š</p>

<ol>
  <li>åœ¨ä»£ç ä¸­åŒ…å« &lt;mcheck.h&gt; å¤´æ–‡ä»¶ã€‚</li>
  <li>åœ¨ç¨‹åºå¯åŠ¨æ—¶è°ƒç”¨ mtrace() å‡½æ•°ï¼Œå¼€å¯å†…å­˜åˆ†é…å’Œé‡Šæ”¾è·Ÿè¸ªã€‚</li>
  <li>ç¨‹åºç»“æŸæ—¶ï¼Œå¯ä»¥è°ƒç”¨ muntrace() å‡½æ•°å…³é—­å†…å­˜åˆ†é…å’Œé‡Šæ”¾è·Ÿè¸ªã€‚</li>
  <li>è¿è¡Œmtraceè„šæœ¬ï¼Œåˆ†æè·Ÿè¸ªæ—¥å¿—ï¼Œç”ŸæˆæŠ¥å‘Šã€‚</li>
</ol>

<p>è¯·æ³¨æ„ï¼Œmtrace çš„è·Ÿè¸ªè¾“å‡ºé€šå¸¸æ˜¯æ–‡æœ¬å½¢å¼ï¼Œä¸ä¸€å®šæ˜“äºäººç±»é˜…è¯»ã€‚GNU C åº“æä¾›äº†ä¸€ä¸ª Perl è„šæœ¬ mtraceï¼Œç”¨äºè§£æè·Ÿè¸ªæ—¥å¿—å¹¶ç”Ÿæˆäººç±»å¯è¯»çš„è¾“å‡ºã€‚ä¸ºäº†è·å¾—æœ€ä½³æ•ˆæœï¼Œå»ºè®®ç¼–è¯‘æ—¶å¯ç”¨è°ƒè¯•ï¼Œä»¥ä¾¿åœ¨å¯æ‰§è¡Œæ–‡ä»¶ä¸­è®°å½•è¡Œå·ä¿¡æ¯ã€‚ä¸è¿‡ï¼Œmtrace çš„è·Ÿè¸ªä¼šå¸¦æ¥æ€§èƒ½æŸè€—.å¦‚æœ MALLOC_TRACE æ²¡æœ‰æŒ‡å‘æœ‰æ•ˆä¸”å¯å†™çš„è·¯å¾„ï¼Œ åˆ™mtraceä¸ä¼šè®°å½•ä¿¡æ¯ã€‚</p>

<p><img src="/blog/assets/memory_check/mtrace.png" alt="mtrace" width="500px" height="250px" />
<img src="/blog/assets/memory_check/mtrace_2.png" alt="mtrace" width="650px" height="250px" /></p>

<h1 id="4straceä¸ltrace">4.straceä¸ltrace</h1>

<p>ltrace ç”¨äºè·Ÿè¸ªç¨‹åºçš„åº“å‡½æ•°è°ƒç”¨ï¼Œè€Œ strace åˆ™ç”¨äºè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ã€‚
å®ƒä»¬éƒ½åŸºäº ptrace ç³»ç»Ÿè°ƒç”¨ï¼Œä½†è·Ÿè¸ªåº“å‡½æ•°å’Œè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ä¹‹é—´å­˜åœ¨å·®å¼‚ã€‚ é€šè¿‡å®ƒä»¬ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹åº”ç”¨çš„å†…å­˜ç”³è¯·ã€é‡Šæ”¾è¿›è¡Œè·Ÿè¸ªã€‚</p>

<p>ltrace çš„å·¥ä½œåŸç†ï¼š</p>
<ul>
  <li>ptrace é™„åŠ åˆ°æ­£åœ¨è¿è¡Œçš„ç¨‹åºã€‚</li>
  <li>å®šä½ç¨‹åºçš„ PLTã€‚</li>
  <li>ä½¿ç”¨ PTRACE_POKETEXT è®¾ç½®è½¯ä»¶æ–­ç‚¹ï¼ˆint $3 æŒ‡ä»¤ï¼‰è¦†ç›–åº“å‡½æ•°çš„ PLT ä¸­çš„æ±‡ç¼– trampolineã€‚</li>
  <li>æ¢å¤ç¨‹åºæ‰§è¡Œã€‚</li>
</ul>

<p>strace åº”è¯¥ä¹Ÿæ˜¯ç›¸ç±»ä¼¼çš„å·¥ä½œåŸç†</p>

<h2 id="41-strace">4.1 strace</h2>

<p>strace æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Linux å‘½ä»¤ï¼Œç”¨äºè¯Šæ–­ã€è°ƒè¯•å’Œç»Ÿè®¡ã€‚å®ƒå…è®¸æ‚¨è·Ÿè¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨å’Œæ¥æ”¶çš„ä¿¡å·ã€‚ä¸‹é¢æ˜¯ä¸€äº›å…³äº strace çš„å‚æ•°ä½¿ç”¨æ–¹æ³•ã€‚</p>

<ul>
  <li>-cï¼šç»Ÿè®¡æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ—¶é—´ã€æ¬¡æ•°å’Œé”™è¯¯æ¬¡æ•°ã€‚ ç¤ºä¾‹ï¼šæ‰“å°æ‰§è¡Œ uptime æ—¶ç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´ã€æ¬¡æ•°å’Œé”™è¯¯æ¬¡æ•°ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strace <span class="nt">-c</span> <span class="nb">uptime</span>
</code></pre></div>    </div>
  </li>
  <li>-fï¼šè·Ÿè¸ªå­è¿›ç¨‹ï¼Œè¿™äº›å­è¿›ç¨‹æ˜¯ç”±å½“å‰è·Ÿè¸ªçš„è¿›ç¨‹åˆ›å»ºçš„ã€‚</li>
  <li>-iï¼šåœ¨ç³»ç»Ÿè°ƒç”¨æ—¶æ‰“å°æŒ‡ä»¤æŒ‡é’ˆã€‚</li>
  <li>-tï¼šè·Ÿè¸ªçš„æ¯ä¸€è¡Œéƒ½ä»¥æ—¶é—´ä¸ºå‰ç¼€ã€‚</li>
  <li>-ttï¼šå¦‚æœç»™å‡ºä¸¤æ¬¡ï¼Œåˆ™æ‰“å°æ—¶é—´å°†åŒ…æ‹¬å¾®ç§’ã€‚</li>
  <li>-tttï¼šå¦‚æœç»™å®šä¸‰æ¬¡ï¼Œåˆ™æ‰“å°æ—¶é—´å°†åŒ…æ‹¬å¾®ç§’ï¼Œå¹¶ä¸”å‰å¯¼éƒ¨åˆ†å°†æ‰“å°ä¸ºè‡ªå¯åŠ¨ä»¥æ¥çš„ç§’æ•°ã€‚</li>
  <li>-Tï¼šæ˜¾ç¤ºèŠ±è´¹åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šçš„æ—¶é—´ã€‚</li>
</ul>

<p>é™å®šè¡¨è¾¾å¼ï¼š</p>
<ul>
  <li>-e trace=setï¼šä»…è·Ÿè¸ªæŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨é›†ã€‚ä¾‹å¦‚ï¼Œtrace=open,close,read,write è¡¨ç¤ºä»…è·Ÿè¸ªè¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=fileï¼šè·Ÿè¸ªæ‰€æœ‰ä»¥æ–‡ä»¶åä½œä¸ºå‚æ•°çš„ç³»ç»Ÿè°ƒç”¨ã€‚ç¤ºä¾‹ï¼šæ‰“å°æ‰§è¡Œ ls æ—¶ä¸æ–‡ä»¶æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>file <span class="nb">ls</span>
</code></pre></div>    </div>
  </li>
  <li>-e trace=processï¼šè·Ÿè¸ªæ¶‰åŠè¿›ç¨‹ç®¡ç†çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=networkï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ç½‘ç»œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=signalï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ä¿¡å·ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=ipcï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ IPC ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li><span style="color: red;">-e trace=memoryï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ momory ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</span></li>
</ul>

<p>å…¶ä»–å‚æ•°ï¼š</p>
<ul>
  <li>-o æ–‡ä»¶åï¼šå°†è·Ÿè¸ªè¾“å‡ºå†™å…¥æ–‡ä»¶è€Œä¸æ˜¯ stderrã€‚</li>
  <li>-p pidï¼šä½¿ç”¨è¿›ç¨‹ ID pid é™„åŠ åˆ°è¯¥è¿›ç¨‹å¹¶å¼€å§‹è·Ÿè¸ª</li>
</ul>

<p>ä¸‹é¢æ˜¯è¿è¡Œ <code class="language-plaintext highlighter-rouge">strace ls</code> çš„è¾“å‡º
<img src="/blog/assets/memory_check/strace.png" alt="strace" width="650px" height="500px" /></p>

<h2 id="42-ltrace">4.2 ltrace</h2>

<p>ltrace æ˜¯ä¸€ä¸ªç”¨äºè·Ÿè¸ªç¨‹åºåº“è°ƒç”¨çš„ Linux å·¥å…·ã€‚å®ƒå¯ä»¥æ‹¦æˆªå¹¶è®°å½•è¢«æ‰§è¡Œè¿›ç¨‹è°ƒç”¨çš„åŠ¨æ€åº“å‡½æ•°ï¼Œä»¥åŠè¯¥è¿›ç¨‹æ¥æ”¶åˆ°çš„ä¿¡å·ã€‚æ­¤å¤–ï¼Œltrace è¿˜å¯ä»¥æ‹¦æˆªå¹¶æ‰“å°ç¨‹åºæ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>

<p>å¸¸ç”¨å‚æ•°å’Œç¤ºä¾‹ï¼š
-cï¼šç»Ÿè®¡æ¯ä¸ªç³»ç»Ÿè°ƒç”¨çš„æ‰§è¡Œæ—¶é—´ã€æ¬¡æ•°å’Œé”™è¯¯æ¬¡æ•°ã€‚ ç¤ºä¾‹ï¼šæ‰“å°æ‰§è¡Œ uptime æ—¶ç³»ç»Ÿè°ƒç”¨çš„æ—¶é—´ã€æ¬¡æ•°å’Œé”™è¯¯æ¬¡æ•°ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ltrace <span class="nt">-c</span> <span class="nb">uptime</span>
</code></pre></div></div>

<ul>
  <li>-fï¼šè·Ÿè¸ªå­è¿›ç¨‹ï¼Œè¿™äº›å­è¿›ç¨‹æ˜¯ç”±å½“å‰è·Ÿè¸ªçš„è¿›ç¨‹åˆ›å»ºçš„ã€‚</li>
  <li>-iï¼šåœ¨ç³»ç»Ÿè°ƒç”¨æ—¶æ‰“å°æŒ‡ä»¤æŒ‡é’ˆã€‚</li>
  <li>-tï¼šè·Ÿè¸ªçš„æ¯ä¸€è¡Œéƒ½ä»¥æ—¶é—´ä¸ºå‰ç¼€ã€‚</li>
  <li>-ttï¼šå¦‚æœç»™å‡ºä¸¤æ¬¡ï¼Œåˆ™æ‰“å°æ—¶é—´å°†åŒ…æ‹¬å¾®ç§’ã€‚</li>
  <li>-tttï¼šå¦‚æœç»™å®šä¸‰æ¬¡ï¼Œåˆ™æ‰“å°æ—¶é—´å°†åŒ…æ‹¬å¾®ç§’ï¼Œå¹¶ä¸”å‰å¯¼éƒ¨åˆ†å°†æ‰“å°ä¸ºè‡ªå¯åŠ¨ä»¥æ¥çš„ç§’æ•°ã€‚</li>
  <li>-Tï¼šæ˜¾ç¤ºèŠ±è´¹åœ¨ç³»ç»Ÿè°ƒç”¨ä¸Šçš„æ—¶é—´ã€‚</li>
</ul>

<p>é™å®šè¡¨è¾¾å¼ï¼š</p>

<ul>
  <li>-e trace=setï¼šä»…è·Ÿè¸ªæŒ‡å®šçš„ç³»ç»Ÿè°ƒç”¨é›†ã€‚ä¾‹å¦‚ï¼Œtrace=open,close,read,write è¡¨ç¤ºä»…è·Ÿè¸ªè¿™å››ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=fileï¼šè·Ÿè¸ªæ‰€æœ‰ä»¥æ–‡ä»¶åä½œä¸ºå‚æ•°çš„ç³»ç»Ÿè°ƒç”¨ã€‚ç¤ºä¾‹ï¼šæ‰“å°æ‰§è¡Œ ls æ—¶ä¸æ–‡ä»¶æœ‰å…³çš„ç³»ç»Ÿè°ƒç”¨ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ltrace <span class="nt">-e</span> <span class="nv">trace</span><span class="o">=</span>file <span class="nb">ls</span>
</code></pre></div>    </div>
  </li>
  <li>-e trace=processï¼šè·Ÿè¸ªæ¶‰åŠè¿›ç¨‹ç®¡ç†çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=networkï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ç½‘ç»œç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=signalï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ä¿¡å·ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
  <li>-e trace=ipcï¼šè·Ÿè¸ªæ‰€æœ‰ä¸ IPC ç›¸å…³çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
</ul>

<p>å…¶ä»–å‚æ•°ï¼š</p>

<ul>
  <li>-o æ–‡ä»¶åï¼šå°†è·Ÿè¸ªè¾“å‡ºå†™å…¥æ–‡ä»¶è€Œä¸æ˜¯ stderrã€‚</li>
  <li>-p pidï¼šä½¿ç”¨è¿›ç¨‹ ID pid é™„åŠ åˆ°è¯¥è¿›ç¨‹å¹¶å¼€å§‹è·Ÿè¸ªã€‚</li>
</ul>

<p>ä¸‹é¢æ˜¯è¿è¡Œ <code class="language-plaintext highlighter-rouge">ltrace ls</code> çš„è¾“å‡º</p>

<p><img src="/blog/assets/memory_check/ltrace.png" alt="ltrace" width="650px" height="500px" /></p>]]></content><author><name>Kevin</name></author><category term="Jekyll" /><summary type="html"><![CDATA[1.è¿›ç¨‹å†…å­˜æ˜ å°„æ–‡ä»¶smaps]]></summary></entry></feed>